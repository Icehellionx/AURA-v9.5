<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AURA v8.0 OMEGA Data Manager</title>
  <style>
    :root {
      --bg: #050816;
      --bg-elevated: #0b1020;
      --bg-elevated-2: #111827;
      --accent: #4f46e5;
      --accent-soft: rgba(79, 70, 229, 0.2);
      --accent-soft-2: rgba(79, 70, 229, 0.4);
      --accent-strong: #a855f7;
      --border-subtle: #1f2937;
      --border-strong: #374151;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --text-soft: #6b7280;
      --danger: #ef4444;
      --success: #22c55e;
      --warning: #f59e0b;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.6);
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-pill: 999px;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: radial-gradient(circle at top left, #111827 0, #020617 45%, #000 100%);
      color: var(--text-main);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .app-shell {
      display: flex;
      height: 100vh;
    }

    .sidebar {
      width: 280px;
      background: linear-gradient(180deg, #020617 0%, #050816 45%, #020617 100%);
      border-right: 1px solid var(--border-subtle);
      padding: 14px 10px 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 6px 10px;
    }

    .sidebar-title {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.04em;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .data-type-selector {
      display: flex;
      gap: 4px;
      padding: 4px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-subtle);
      margin-bottom: 8px;
    }

    .data-type-btn {
      flex: 1;
      padding: 6px 8px;
      font-size: 10px;
      font-weight: 600;
      border: none;
      background: transparent;
      color: var(--text-muted);
      border-radius: var(--radius-pill);
      cursor: pointer;
      transition: all 0.2s;
    }

    .data-type-btn.active {
      background: var(--accent);
      color: white;
      box-shadow: 0 2px 8px rgba(79, 70, 229, 0.4);
    }

    .entries-list {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-height: 0;
    }

    .entry-item {
      padding: 8px 10px;
      border-radius: var(--radius-md);
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid var(--border-subtle);
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .entry-item:hover {
      background: rgba(55, 65, 81, 0.4);
      border-color: rgba(148, 163, 184, 0.4);
    }

    .entry-item.active {
      background: rgba(79, 70, 229, 0.3);
      border-color: rgba(129, 140, 248, 0.7);
    }

    .entry-item.selected {
      background: rgba(79, 70, 229, 0.25);
      border-color: rgba(129, 140, 248, 0.5);
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.3);
    }

    .entry-item.shift-item {
      margin-left: 20px;
      border-left: 3px solid var(--accent);
      padding-left: 8px;
    }

    .entry-item.shift-item::before {
      content: '‚Ü≥';
      position: absolute;
      left: -15px;
      color: var(--accent);
      font-size: 14px;
    }

    .entry-item-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .entry-item-subtitle {
      font-size: 10px;
      color: var(--text-soft);
    }

    .group-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 4px;
      vertical-align: middle;
    }

    .sidebar-footer {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--border-subtle);
      position: relative;
      z-index: 10;
      background: linear-gradient(180deg, rgba(2, 6, 23, 0.0), rgba(5, 8, 22, 0.98));
    }

    .button-group {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
    }

    .button-group-label {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-soft);
      font-weight: 600;
      margin-bottom: 4px;
      padding-left: 2px;
    }

    .button-section {
      display: flex;
      flex-direction: column;
    }

    .button-section:not(:last-child) {
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
    }

    .pill-button.primary {
      background: radial-gradient(circle at top left, rgba(79, 70, 229, 0.6), rgba(67, 56, 202, 0.85));
      border-color: rgba(99, 102, 241, 0.5);
      font-weight: 600;
    }

    .pill-button.primary:hover {
      background: radial-gradient(circle at top left, rgba(99, 102, 241, 0.7), rgba(79, 70, 229, 0.95));
      border-color: rgba(129, 140, 248, 0.6);
    }

    .pill-button {
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-subtle);
      background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.45), rgba(15, 23, 42, 0.95));
      color: #f9fafb;
      font-size: 12px;
      padding: 6px 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.1);
      transition: all 0.2s;
    }

    .pill-button:hover {
      background: radial-gradient(circle at top left, rgba(168, 183, 204, 0.55), rgba(25, 33, 52, 0.95));
      border-color: var(--accent-soft-2);
    }

    .pill-button.small {
      font-size: 11px;
      padding: 4px 10px;
    }

    .pill-button.danger {
      background: radial-gradient(circle at top left, rgba(239, 68, 68, 0.3), rgba(15, 23, 42, 0.95));
      border-color: rgba(239, 68, 68, 0.4);
    }

    .pill-button.danger:hover {
      background: radial-gradient(circle at top left, rgba(239, 68, 68, 0.5), rgba(25, 33, 52, 0.95));
    }

    .pill-button.success {
      background: radial-gradient(circle at top left, rgba(34, 197, 94, 0.3), rgba(15, 23, 42, 0.95));
      border-color: rgba(34, 197, 94, 0.4);
    }

    .main-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .main-header {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(7, 11, 21, 0.98) 100%);
      border-bottom: 1px solid var(--border-subtle);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
    }

    .brand-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-title {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.02em;
      background: linear-gradient(135deg, #e0e7ff 0%, #a5b4fc 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .brand-subtitle {
      font-size: 11px;
      color: var(--text-soft);
    }

    .tab-toggle {
      display: flex;
      gap: 4px;
      padding: 4px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-subtle);
    }

    .tab-button {
      padding: 6px 16px;
      font-size: 12px;
      font-weight: 600;
      border: none;
      background: transparent;
      color: var(--text-muted);
      border-radius: var(--radius-pill);
      cursor: pointer;
      transition: all 0.2s;
    }

    .tab-button.active {
      background: var(--accent);
      color: white;
      box-shadow: 0 2px 8px rgba(79, 70, 229, 0.4);
    }

    .main-content {
      flex: 1;
      display: flex;
      overflow: hidden;
      position: relative;
      /* padding moved to view-container */
      padding: 20px;
    }

    .editor-card {
      background: rgba(17, 24, 39, 0.8);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-soft);
    }

    .form-section {
      margin-bottom: 24px;
    }

    .form-section:last-child {
      margin-bottom: 0;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.02em;
      color: var(--text-main);
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .form-help {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 4px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 10px 12px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-main);
      font-size: 13px;
      font-family: inherit;
      outline: none;
      transition: all 0.2s;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      border-color: var(--accent-soft-2);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }

    .form-textarea {
      min-height: 80px;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .radio-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .radio-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.9);
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .radio-pill:has(input:checked) {
      background: var(--accent-soft-2);
      border-color: var(--accent);
    }

    .radio-pill input[type="radio"] {
      margin: 0;
      cursor: pointer;
    }

    .emotion-preset-dropdown {
      width: 100%;
      padding: 10px 12px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-main);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      outline: none;
      transition: all 0.2s;
    }

    .emotion-preset-dropdown:focus {
      border-color: var(--accent-soft-2);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }

    .emotion-preset-dropdown option {
      background: #0b1020;
      color: var(--text-main);
      padding: 8px;
    }

    .switch-sliders {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .slider-control {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .slider-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .slider-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .slider-value {
      font-size: 11px;
      color: var(--accent-strong);
      font-weight: 600;
      font-family: ui-monospace, monospace;
    }

    .slider-input {
      width: 100%;
      height: 6px;
      -webkit-appearance: none;
      appearance: none;
      background: rgba(15, 23, 42, 0.95);
      border-radius: 3px;
      outline: none;
      border: 1px solid var(--border-subtle);
    }

    .slider-input::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      background: var(--accent);
      cursor: pointer;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .slider-input::-moz-range-thumb {
      width: 16px;
      height: 16px;
      background: var(--accent);
      cursor: pointer;
      border-radius: 50%;
      border: none;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .tag-cloud {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: var(--accent-soft-2);
      border: 1px solid var(--accent);
      border-radius: var(--radius-pill);
      font-size: 11px;
      color: var(--text-main);
    }

    .tag-remove {
      cursor: pointer;
      color: var(--text-muted);
      transition: color 0.2s;
    }

    .tag-remove:hover {
      color: var(--danger);
    }

    .pair-selector {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .pair-selector select {
      flex: 1;
    }

    .tag-list-area {
      width: 100%;
      min-height: 60px;
      padding: 10px 12px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-main);
      font-size: 12px;
      font-family: ui-monospace, monospace;
      outline: none;
      resize: vertical;
    }

    .tag-list-area:focus {
      border-color: var(--accent-soft-2);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }

    .code-view {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      height: 100%;
    }

    .code-panel {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .code-title {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.04em;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .code-textarea {
      flex: 1;
      width: 100%;
      resize: none;
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 12px;
      line-height: 1.5;
      border-radius: var(--radius-md);
      padding: 12px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.98);
      color: var(--text-main);
      outline: none;
    }

    .code-textarea:focus {
      border-color: var(--accent-soft-2);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      gap: 12px;
      color: var(--text-soft);
      text-align: center;
    }

    .empty-state-icon {
      font-size: 48px;
      opacity: 0.3;
    }

    .empty-state-text {
      font-size: 14px;
    }

    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.9);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(75, 85, 99, 0.8);
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(156, 163, 175, 0.9);
    }

    .hidden {
      display: none !important;
    }

    .breadcrumb {
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 12px;
      padding: 6px 10px;
      background: rgba(15, 23, 42, 0.6);
      border-radius: var(--radius-pill);
      display: inline-block;
    }

    .breadcrumb strong {
      color: var(--accent-strong);
    }

    /* Toast Notifications */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 9999;
      pointer-events: none;
    }
    .toast {
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      padding: 12px 16px;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-soft);
      color: var(--text-main);
      font-size: 13px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
      animation: slideIn 0.2s ease-out;
      pointer-events: auto;
      min-width: 200px;
    }
    .toast.success { border-left: 3px solid var(--success); }
    .toast.error { border-left: 3px solid var(--danger); }
    .toast.info { border-left: 3px solid var(--accent); }
    @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes fadeOut { to { opacity: 0; transform: translateY(5px); } }

    /* Collapsible Sections */
    .section-title {
      cursor: pointer;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .section-title::after {
      content: '‚ñº';
      font-size: 10px;
      opacity: 0.5;
      transition: transform 0.2s;
    }
    .form-section.collapsed .section-title::after {
      transform: rotate(-90deg);
    }
    .form-section.collapsed > *:not(.section-title) {
      display: none;
    }

    /* Tutorial System */
    .tutorial-tooltip {
      position: fixed;
      background: var(--bg-elevated);
      border: 1px solid var(--accent);
      padding: 20px;
      border-radius: var(--radius-lg);
      box-shadow: 0 0 40px rgba(0,0,0,0.8);
      z-index: 10002;
      max-width: 320px;
      color: var(--text-main);
      display: none;
      flex-direction: column;
      gap: 10px;
    }
    .tutorial-tooltip h4 { margin: 0 0 5px 0; color: var(--accent-strong); font-size: 15px; }
    .tutorial-tooltip p { margin: 0; font-size: 13px; line-height: 1.5; color: var(--text-soft); }
    .tutorial-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 10px; }
    .highlight-ring {
      position: fixed; border: 3px solid var(--accent); border-radius: 6px; box-shadow: 0 0 20px var(--accent-soft); pointer-events: none; z-index: 10001; transition: all 0.3s ease;
    }

    /* Smart Tag Input (Next Gen UI) */
    .smart-tag-container {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 6px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      min-height: 42px;
      cursor: text;
      transition: all 0.2s;
    }
    .smart-tag-container:focus-within {
      border-color: var(--accent-soft-2);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }
    .smart-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      background: var(--accent-soft-2);
      border: 1px solid var(--accent);
      border-radius: var(--radius-pill);
      font-size: 11px;
      color: var(--text-main);
      user-select: none;
      animation: slideIn 0.1s ease-out;
    }
    .smart-tag-remove { cursor: pointer; opacity: 0.7; font-weight: bold; }
    .smart-tag-remove:hover { opacity: 1; color: var(--danger); }
    .smart-tag-input {
      flex: 1; min-width: 80px; background: transparent; border: none; color: var(--text-main); font-size: 12px; font-family: ui-monospace, monospace; outline: none; padding: 4px 0;
    }

    /* Graph View */
    #graphCanvas { width: 100%; height: 100%; cursor: grab; }
    #graphCanvas:active { cursor: grabbing; }
    .graph-controls {
      position: absolute; bottom: 20px; right: 20px; background: rgba(15, 23, 42, 0.9); padding: 10px;
      border-radius: var(--radius-md); border: 1px solid var(--border-subtle); display: flex; gap: 10px; pointer-events: none;
    }
    .graph-controls > * { pointer-events: auto; }
    
    /* Focus Mode */
    body.focus-mode .sidebar, body.focus-mode .main-header { display: none; }
    body.focus-mode #exitFocusBtn { display: inline-flex !important; }

    .graph-legend {
      position: absolute; top: 20px; left: 20px; background: rgba(15, 23, 42, 0.9); padding: 10px;
      border-radius: var(--radius-md); border: 1px solid var(--border-subtle); pointer-events: none;
      display: flex; flex-direction: column; gap: 6px;
    }
    .legend-item { display: flex; align-items: center; gap: 8px; font-size: 11px; color: var(--text-muted); }
    .legend-dot { width: 8px; height: 8px; border-radius: 50%; }

    /* Graph Tooltip */
    .graph-tooltip {
      position: fixed;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid var(--border-subtle);
      padding: 12px;
      border-radius: var(--radius-md);
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      pointer-events: none;
      z-index: 10005;
      max-width: 280px;
      font-size: 12px;
      color: var(--text-main);
      display: none;
      backdrop-filter: blur(4px);
    }
    .graph-tooltip strong { color: var(--accent-strong); display: block; margin-bottom: 4px; font-size: 13px; }
    .graph-tooltip .meta { color: var(--text-soft); margin-bottom: 6px; font-size: 10px; text-transform: uppercase; }
    .graph-tooltip .preview { font-style: italic; color: var(--text-muted); display: -webkit-box; -webkit-line-clamp: 6; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4; }

    /* Zen Mode */
    body.zen-mode .sidebar, body.zen-mode .main-header, body.zen-mode .tab-toggle { display: none !important; }
    body.zen-mode .main-content { padding: 0; overflow: hidden; }
    body.zen-mode .editor-card {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000;
      border-radius: 0; border: none; background: var(--bg);
      display: flex; flex-direction: column; padding: 0;
    }
    body.zen-mode .section-title {
      padding: 20px; max-width: 800px; margin: 0 auto; width: 100%;
      border-bottom: 1px solid var(--border-subtle);
    }
    body.zen-mode .form-textarea {
      flex: 1; border: none; border-radius: 0; background: transparent;
      font-size: 16px; line-height: 1.7; padding: 40px;
      max-width: 800px; margin: 0 auto; box-shadow: none;
    }
    body.zen-mode .form-textarea:focus { box-shadow: none; }
    body.zen-mode #exitZenBtn { display: inline-flex !important; }

    /* Quick Switcher */
    .qs-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); z-index: 20000;
      display: flex; justify-content: center; align-items: flex-start;
      padding-top: 120px; backdrop-filter: blur(2px);
    }
    .qs-modal {
      width: 600px; max-width: 90%; background: var(--bg-elevated);
      border: 1px solid var(--border-subtle); border-radius: var(--radius-lg);
      box-shadow: 0 20px 50px rgba(0,0,0,0.8);
      display: flex; flex-direction: column; overflow: hidden;
    }
    .qs-input {
      width: 100%; padding: 16px 20px; background: transparent; border: none;
      border-bottom: 1px solid var(--border-subtle); color: var(--text-main);
      font-size: 16px; outline: none;
    }
    .qs-list { max-height: 400px; overflow-y: auto; }
    .qs-item {
      padding: 12px 20px; cursor: pointer; display: flex; justify-content: space-between;
      align-items: center; border-bottom: 1px solid rgba(255,255,255,0.03);
    }
    .qs-item.selected, .qs-item:hover { background: var(--accent-soft); }
    .qs-text { font-size: 13px; font-weight: 500; }
    .qs-meta { font-size: 11px; color: var(--text-soft); display: flex; gap: 8px; align-items: center; }
    .qs-badge { background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; font-size: 10px; text-transform: uppercase; }

    /* Context & Simulation Sidebar */
    .main-content { padding: 0; } /* Reset for flex layout */
    .view-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      position: relative;
    }
    .context-sidebar {
      width: 320px;
      background: var(--bg-elevated);
      border-left: 1px solid var(--border-subtle);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      padding: 16px;
      gap: 16px;
      flex-shrink: 0;
      transition: margin-right 0.3s ease;
    }
    .context-sidebar.hidden { display: none; }
    .context-box { 
      background: rgba(0,0,0,0.2); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); 
      padding: 10px; font-size: 11px; color: var(--text-muted); 
      min-height: 120px; max-height: 300px; overflow-y: auto; 
      width: 100%; resize: vertical; font-family: inherit; outline: none;
      margin-bottom: 8px; display: block;
    }
    .context-box:focus {
      border-color: var(--accent-soft-2); color: var(--text-main); background: rgba(0,0,0,0.4);
    }
    .sim-result { background: var(--bg-elevated-2); border: 1px solid var(--accent-soft); padding: 12px; border-radius: var(--radius-md); font-size: 12px; line-height: 1.5; color: var(--text-main); min-height: 100px; white-space: pre-wrap; }

    /* Chat Mode */
    .chat-container { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: var(--radius-md); border: 1px solid var(--border-subtle); margin-bottom: 10px; min-height: 200px; }
    .chat-msg { padding: 8px 12px; border-radius: var(--radius-md); font-size: 12px; line-height: 1.4; max-width: 90%; word-wrap: break-word; }
    .chat-msg.user { align-self: flex-end; background: var(--accent); color: white; border-bottom-right-radius: 2px; }
    .chat-msg.ai { align-self: flex-start; background: var(--bg-elevated-2); border: 1px solid var(--border-subtle); border-bottom-left-radius: 2px; }
    .chat-msg.system { align-self: center; font-size: 10px; color: var(--text-soft); font-style: italic; background: transparent; border: none; padding: 4px; }
    .chat-input-area { display: flex; gap: 6px; }
    .chat-input { flex: 1; padding: 8px; border-radius: var(--radius-md); border: 1px solid var(--border-subtle); background: var(--bg-elevated); color: var(--text-main); font-size: 12px; outline: none; }
    .chat-input:focus { border-color: var(--accent); }

    /* Laboratory View */
    .lab-view {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      height: 100%;
      padding: 20px;
    }
    .lab-column {
      display: flex;
      flex-direction: column;
      gap: 16px;
      min-height: 0;
    }
    .lab-column .form-group {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
      margin-bottom: 0;
    }
    .lab-column .form-textarea, .lab-column .lab-debug-panel, .lab-column .chat-container {
      flex: 1;
      resize: none;
    }
    .lab-debug-panel {
        background: rgba(0,0,0,0.2); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); 
        padding: 10px; font-size: 11px; color: var(--text-muted); 
        overflow-y: auto; 
        font-family: monospace;
        white-space: pre-wrap;
    }
    .lab-debug-panel .injected {
      color: var(--success);
    }
    .lab-debug-panel .removed {
      color: var(--danger);
      text-decoration: line-through;
    }
    /* Script Loader */
    .script-item {
      display: flex; align-items: center; gap: 10px; padding: 8px;
      background: var(--bg-elevated-2); border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md); transition: all 0.2s;
    }
    .script-item:hover { background: var(--bg-elevated); }
    .script-item.primary {
      border-color: var(--accent);
      background: rgba(79, 70, 229, 0.1);
    }
    .script-name { flex: 1; font-size: 12px; font-family: monospace; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .script-controls { display: flex; gap: 4px; }

    /* Quill Editor Styles */
    .quill-editor-container {
      position: relative;
    }
    .ql-toolbar.ql-snow {
      border: 1px solid var(--border-strong) !important;
      border-radius: var(--radius-md) var(--radius-md) 0 0 !important;
      background: var(--bg-elevated) !important;
      padding: 8px !important;
    }
    .ql-container.ql-snow {
      border: 1px solid var(--border-strong) !important;
      border-top: none !important;
      border-radius: 0 0 var(--radius-md) var(--radius-md) !important;
      background: var(--bg-elevated-2) !important;
      font-size: 13px !important;
      min-height: 120px;
    }
    .ql-editor {
      color: var(--text-main) !important;
      min-height: 120px;
      padding: 12px 15px !important;
    }
    .ql-editor.ql-blank::before {
      color: var(--text-soft) !important;
      font-style: normal !important;
    }
    .ql-toolbar .ql-stroke {
      stroke: var(--text-muted) !important;
    }
    .ql-toolbar .ql-fill {
      fill: var(--text-muted) !important;
    }
    .ql-toolbar .ql-picker-label {
      color: var(--text-muted) !important;
    }
    .ql-toolbar button:hover .ql-stroke,
    .ql-toolbar button.ql-active .ql-stroke {
      stroke: var(--accent) !important;
    }
    .ql-toolbar button:hover .ql-fill,
    .ql-toolbar button.ql-active .ql-fill {
      fill: var(--accent) !important;
    }
    .ql-toolbar button:hover,
    .ql-toolbar button.ql-active {
      color: var(--accent) !important;
    }
    .ql-snow .ql-picker-options {
      background: var(--bg-elevated) !important;
      border: 1px solid var(--border-strong) !important;
    }
    .ql-snow .ql-picker-item:hover {
      color: var(--accent) !important;
    }
  </style>

  <!-- Quill.js CDN -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
</head>

<body>
  <div class="app-shell">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">AURA Data</div>
      </div>

      <div style="padding: 0 4px 8px 4px;">
        <div style="position: relative;">
          <input type="text" id="searchInput" class="form-input small" placeholder="Search... (Ctrl+F)" oninput="window.renderList(); document.getElementById('searchClear').style.display = this.value ? 'block' : 'none';" style="font-size: 12px; padding: 6px 24px 6px 10px;">
          <span id="searchClear" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); cursor: pointer; display: none; color: var(--text-muted); font-weight: bold;" onclick="document.getElementById('searchInput').value = ''; window.renderList(); this.style.display='none';">√ó</span>
        </div>
      </div>

      <div class="data-type-selector" role="tablist" aria-label="Data type selector">
        <button class="data-type-btn active" onclick="window.switchType('characters', event)" role="tab" aria-selected="true" aria-controls="entriesList">Chars</button>
        <button class="data-type-btn" onclick="window.switchType('pairs', event)" role="tab" aria-selected="false" aria-controls="entriesList">Pairs</button>
        <button class="data-type-btn" onclick="window.switchType('dynamiclore', event)" role="tab" aria-selected="false" aria-controls="entriesList">Lore</button>
      </div>

      <div class="entries-list" id="entriesList"></div>

      <div class="sidebar-footer">
        <!-- Primary Actions -->
        <div class="button-section">
          <div class="button-group-label">Create</div>
          <div class="button-group">
            <button type="button" class="pill-button small primary" onclick="window.createNew()" title="Create new entry (Ctrl+N)">‚ú® New Entry</button>
            <button type="button" class="pill-button small primary" onclick="window.openAiEntryModal()" title="Generate new entry with AI">ü§ñ AI Entry</button>
            <button type="button" class="pill-button small primary" onclick="window.addShift()" id="btnAddShift"
              style="display:none;" title="Add a shift variant to this lore entry">‚ö° New Shift</button>
            <button type="button" class="pill-button small primary" onclick="window.openAiShiftModal()" id="btnAddAiShift"
              style="display:none;" title="Generate shift variant with AI">ü§ñ AI Shift</button>
          </div>
        </div>

        <!-- Edit Actions -->
        <div class="button-section">
          <div class="button-group-label">Edit</div>
          <div class="button-group">
            <button type="button" class="pill-button small" onclick="window.duplicate()" title="Duplicate selected entry (Ctrl+D)">üìã Duplicate</button>
            <button type="button" class="pill-button small" onclick="window.openDupModal()" title="Duplicate entry to another type">üìë Dup To...</button>
            <button type="button" class="pill-button small" onclick="window.openAiEditModal()" title="Edit current entry with AI">‚úèÔ∏è AI Edit</button>
            <button type="button" class="pill-button small" onclick="window.openSearchReplaceModal()" title="Find and replace across all entries (Ctrl+H)">üîç Find/Replace</button>
          </div>
        </div>

        <!-- Utility Tools -->
        <div class="button-section">
          <div class="button-group-label">Tools</div>
          <div class="button-group">
            <button type="button" class="pill-button small" onclick="window.validateAll()" title="Check for logical contradictions">‚úì Validate</button>
            <button type="button" class="pill-button small" onclick="window.runHealthCheck()" title="Scan data for common issues">üè• Health Check</button>
          </div>
        </div>

        <!-- Danger Zone -->
        <div class="button-section">
          <div class="button-group-label">Danger Zone</div>
          <div class="button-group">
            <button type="button" class="pill-button danger small" onclick="window.deleteEntry()" title="Delete selected entry (Delete key)">üóëÔ∏è Delete</button>
            <button type="button" class="pill-button danger small" onclick="window.openResetAllModal()" title="Reset all values (clears local data)">‚ö†Ô∏è Reset All</button>
          </div>
        </div>
      </div>
    </aside>

    <main class="main-panel">
      <header class="main-header">
        <div class="brand-block">
          <div class="brand-title">AURA Data Manager</div>
        </div>
        <form class="form-group" style="flex-grow: 1; margin-bottom: 0; display: flex; gap: 6px; align-items: center;" onsubmit="event.preventDefault(); window.saveApiKey();">
          <input type="text" name="username" value="AI_API_Key" autocomplete="username" style="display:none">
          <select id="apiKeySelector" class="form-input small" style="width: 150px;" onchange="window.switchApiKey()">
            <option value="">Select API Key...</option>
          </select>
          <input type="password" id="apiKey" name="password" class="form-input small" placeholder="Enter API Key" autocomplete="current-password" style="flex: 1; min-width: 150px;">
          <button type="submit" class="pill-button small">Save</button>
          <button type="button" class="pill-button small" onclick="window.openApiKeyManager()" title="Manage API Keys">‚öôÔ∏è</button>
        </form>
        <div class="tab-toggle" role="tablist" aria-label="Main view tabs">
          <button class="tab-button active" onclick="window.switchTab('visual')" role="tab" aria-selected="true" aria-controls="visualEditor">Visual</button>
          <button class="tab-button" onclick="window.switchTab('code')" role="tab" aria-selected="false" aria-controls="codeView">Code</button>
          <button class="tab-button" onclick="window.switchTab('graph')" role="tab" aria-selected="false" aria-controls="graphView">Graph</button>
          <button class="tab-button" onclick="window.switchTab('laboratory')" role="tab" aria-selected="false" aria-controls="laboratoryView">Laboratory</button>
          <button class="tab-button" onclick="window.switchTab('personality')" role="tab" aria-selected="false" aria-controls="personalityEditor">Personality</button>
          <button class="tab-button" onclick="window.switchTab('scenario')" role="tab" aria-selected="false" aria-controls="scenarioEditor">Scenario</button>
          <button class="tab-button" onclick="window.switchTab('initialMessage')" role="tab" aria-selected="false" aria-controls="initialMessageEditor">Init Msg</button>
        </div>
        <div style="display: flex; gap: 8px;">
          <button class="pill-button small" onclick="document.getElementById('personalityInput').click()" title="Import personality from text file">Load Personality</button>
          <button class="pill-button small" onclick="document.getElementById('scenarioInput').click()" title="Import scenario from text file">Load Scenario</button>
          <button class="pill-button small" onclick="document.getElementById('initialMessageInput').click()" title="Import initial message from text file">Load Initial Message</button>
          <button class="pill-button small" onclick="window.importData()" title="Import database from .js script file">Load Script</button>
          <button id="btn_save_file" class="pill-button small success" onclick="window.exportData()" title="Export database to .js script file (Ctrl+S)">üíæ Save Script to File</button>
        </div>
        <div id="autoSaveStatus" style="margin-left: 12px; font-size: 11px; color: var(--text-muted); display: flex; align-items: center; gap: 6px;">
          <span id="saveIndicator">‚óè</span>
          <span id="saveText">Auto-saved</span>
        </div>
        <div style="display:flex; flex-direction:column; gap:4px; margin-left:8px;">
          <button class="pill-button small" style="border-color: var(--accent); padding: 2px 8px; font-size:10px;" onclick="window.startTutorial()" title="Start basic tutorial">Tutorial</button>
          <button class="pill-button small" style="border-color: var(--accent); padding: 2px 8px; font-size:10px;" onclick="window.startAdvancedTutorial()" title="Learn all features in detail">Advanced Tutorial</button>
          <button class="pill-button small" style="border-color: var(--accent); padding: 2px 8px; font-size:10px;" onclick="window.startWalkthrough()" title="Step-by-step guided creation">Walk Through</button>
        </div>
        <button class="pill-button small" onclick="window.showKeyboardShortcuts()" title="View keyboard shortcuts (Ctrl+?)" style="margin-left: 8px;">‚å®Ô∏è</button>
      </header>

      <div class="main-content">
        <div id="viewContainer" class="view-container">
        <div id="visualEditor" class="editor-card">
          <div class="empty-state">
            <div class="empty-state-icon">üëà</div>
            <div class="empty-state-text">Select an entry from the sidebar<br>or create a new one</div>
          </div>
        </div>

        <div id="personalityEditor" class="editor-card hidden">
          <div class="section-title">Personality <div style="float:right; display:flex; gap:6px;"><button class="pill-button small" onclick="window.openAiTextEditModal('personalityTextarea')">AI Edit</button><button class="pill-button small" onclick="window.toggleZenMode()">Zen</button></div></div>
          <div id="personalityTextarea" class="quill-editor-container" style="min-height: 400px;"></div>
          <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
            <button class="pill-button small success" onclick="window.savePersonality()">Save Personality</button>
            <div id="personalityStats" class="form-help" style="margin:0;">0 words / ~0 tokens</div>
          </div>
        </div>

        <div id="scenarioEditor" class="editor-card hidden">
          <div class="section-title">Scenario <div style="float:right; display:flex; gap:6px;"><button class="pill-button small" onclick="window.openAiTextEditModal('scenarioTextarea')">AI Edit</button><button class="pill-button small" onclick="window.toggleZenMode()">Zen</button></div></div>
          <div id="scenarioTextarea" class="quill-editor-container" style="min-height: 400px;"></div>
          <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
            <button class="pill-button small success" onclick="window.saveScenario()">Save Scenario</button>
            <div id="scenarioStats" class="form-help" style="margin:0;">0 words / ~0 tokens</div>
          </div>
        </div>

        <div id="initialMessageEditor" class="editor-card hidden">
          <div class="section-title">Initial Message <div style="float:right; display:flex; gap:6px;"><button class="pill-button small" onclick="window.openAiTextEditModal('initialMessageTextarea')">AI Edit</button><button class="pill-button small" onclick="window.toggleZenMode()">Zen</button></div></div>
          <div id="initialMessageTextarea" class="quill-editor-container" style="min-height: 400px;"></div>
          <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
            <button class="pill-button small success" onclick="window.saveInitialMessage()">Save Initial Message</button>
            <div id="initialMessageStats" class="form-help" style="margin:0;">0 words / ~0 tokens</div>
          </div>
        </div>

        <div id="codeView" class="code-view hidden">
          <div class="code-panel">
            <div class="code-header">
              <div class="code-title">Current Entry JSON</div>
              <button class="pill-button small" onclick="window.syncFromJson()">‚Üê Sync</button>
            </div>
            <textarea class="code-textarea" id="entryJsonCode"></textarea>
          </div>
          <div class="code-panel">
            <div class="code-header">
              <div class="code-title">Full Export</div>
              <button class="pill-button small" onclick="window.copyCode()">Copy</button>
            </div>
            <textarea class="code-textarea" id="fullExportCode" readonly></textarea>
          </div>
        </div>

        <div id="graphView" class="hidden" style="width:100%;height:100%;position:relative;background:var(--bg-elevated-2);border-radius:var(--radius-lg);overflow:hidden;">
          <canvas id="graphCanvas"></canvas>
          <div class="graph-legend">
            <div class="legend-item"><div class="legend-dot" style="background:#a855f7"></div>Character</div>
            <div class="legend-item"><div class="legend-dot" style="background:#f59e0b"></div>Pair</div>
            <div class="legend-item"><div class="legend-dot" style="background:#4f46e5"></div>Lore</div>
            <div class="legend-item"><div class="legend-dot" style="background:#22c55e"></div>Shift</div>
          </div>
          <div class="graph-controls" style="flex-direction:column; align-items:flex-end; gap:8px;">
            <div style="display:flex; gap:8px; align-items:center;">
               <label style="font-size:11px; cursor:pointer;"><input type="checkbox" id="gFilterChar" checked onchange="window.renderGraph()"> Chars</label>
               <label style="font-size:11px; cursor:pointer;"><input type="checkbox" id="gFilterPair" checked onchange="window.renderGraph()"> Pairs</label>
               <label style="font-size:11px; cursor:pointer;"><input type="checkbox" id="gFilterLore" checked onchange="window.renderGraph()"> Lore</label>
               <label style="font-size:11px; cursor:pointer;"><input type="checkbox" id="gFilterShift" checked onchange="window.renderGraph()"> Shifts</label>
            </div>
            <div style="display:flex; gap:8px;">
              <input id="gSearchNode" class="form-input" placeholder="Highlight..." style="width:100px; padding:4px; height:24px; font-size:11px;">
              <input id="gFilterGroup" class="form-input" placeholder="Filter Group..." style="width:100px; padding:4px; height:24px; font-size:11px;" oninput="window.renderGraph()">
              <button class="pill-button small" onclick="window.renderGraph()">Refresh</button>
              <button class="pill-button small" onclick="window.resetGraphCamera()">Reset View</button>
            </div>
            <div style="font-size:10px;color:var(--text-soft);">Scroll to Zoom ‚Ä¢ Drag to Pan ‚Ä¢ DblClick to Edit</div>
          </div>
        </div>
      </div>
        
      <div id="laboratoryView" class="lab-view hidden">
        <div class="lab-column">
          <div class="form-group">
            <label class="form-label">Global Personality</label>
            <div id="labPersonality" class="quill-editor-container"></div>
          </div>
          <div class="form-group">
            <label class="form-label">Global Scenario</label>
            <div id="labScenario" class="quill-editor-container"></div>
          </div>
        </div>
        <div class="lab-column">
          <div class="form-group">
            <label class="form-label">Scripting Debug</label>
            <div id="labScriptDebug" class="lab-debug-panel">(Run simulation to see script execution log)</div>
          </div>
          <div class="form-group">
            <label class="form-label" style="display:flex; justify-content:space-between; align-items:center;">
              Chat Simulation
              <div style="display:flex; gap:4px;">
                <button type="button" class="pill-button small" onclick="window.copyChatLog()">Copy</button>
                <button type="button" class="pill-button small danger" onclick="window.clearChat()">Clear</button>
              </div>
            </label>
            <div id="labChatContainer" class="chat-container"></div>
            <div class="chat-input-area">
              <input id="labChatInput" class="chat-input" placeholder="Type a message..." onkeydown="if(event.key==='Enter') window.sendChat()">
              <button id="labBtnSendChat" class="pill-button small success" onclick="window.sendChat()">Send</button>
            </div>
          </div>
        </div>
      </div>
      </div>

      <!-- Context Sidebar -->
      <aside id="contextPanel" class="context-sidebar hidden">
        <div class="section-title">Global Context</div>
        <div>
          <div class="form-label">Personality</div>
          <div id="ctxPersonality" class="quill-editor-container context-box"></div>
        </div>
        <div>
          <div class="form-label">Scenario</div>
          <div id="ctxScenario" class="quill-editor-container context-box"></div>
        </div>
        <div>
          <div class="form-label">Initial Message</div>
          <div id="ctxInitialMessage" class="quill-editor-container context-box"></div>
        </div>

        <div class="section-title" style="margin-top:10px;">Scripting Debug</div>
        <div class="form-help">Active injections from selected entry:</div>
        <div id="scriptDebug" class="context-box" style="font-family:monospace; font-size:10px; color:var(--text-main); white-space: pre-wrap;">
           (Select an entry)
        </div>
        
        <div class="section-title" style="margin-top:10px;">
          Simulation
          <div style="float:right; display:flex; gap:4px;">
            <button class="pill-button small" onclick="window.copyChatLog()">Copy</button>
            <button class="pill-button small danger" onclick="window.clearChat()">Clear</button>
          </div>
        </div>
        <div id="chatContainer" class="chat-container"></div>
        <div class="chat-input-area">
          <input id="chatInput" class="chat-input" placeholder="Type a message..." onkeydown="if(event.key==='Enter') window.sendChat()">
          <button id="btnSendChat" class="pill-button small success" onclick="window.sendChat()">Send</button>
        </div>
      </aside>
      </div>
    </main>
  </div>

  <!-- Exit Zen Button -->
  <button id="exitZenBtn" class="pill-button" style="position:fixed; top:20px; right:20px; z-index:10001; display:none; box-shadow: 0 0 20px rgba(0,0,0,0.5); border-color: var(--accent);" onclick="window.toggleZenMode()">Exit Zen</button>

  <!-- Quick Switcher -->
  <div id="quickSwitcher" class="qs-overlay hidden" onclick="if(event.target===this) window.toggleQuickSwitcher()">
    <div class="qs-modal">
      <input id="qsInput" class="qs-input" placeholder="Jump to entry..." autocomplete="off">
      <div id="qsResults" class="qs-list"></div>
      <div style="padding: 8px 12px; font-size: 10px; color: var(--text-soft); background: rgba(0,0,0,0.2); border-top: 1px solid var(--border-subtle); display: flex; justify-content: space-between;">
        <span>‚Üë‚Üì to navigate</span><span>‚Üµ to select</span><span>Esc to close</span>
      </div>
    </div>
  </div>

  <!-- Graph Tooltip -->
  <div id="graphTooltip" class="graph-tooltip"></div>

  <input type="file" id="fileInput" accept=".js,.txt" style="display:none;" onchange="window.handleFileImport(event)">
  <input type="file" id="personalityInput" accept=".txt,.md" style="display:none;"
    onchange="window.handlePersonalityImport(event)">
  <input type="file" id="scenarioInput" accept=".txt,.md" style="display:none;"
    onchange="window.handleScenarioImport(event)">
  <input type="file" id="initialMessageInput" accept=".txt,.md" style="display:none;"
    onchange="window.handleInitialMessageImport(event)">

  <div id="aiModal" class="hidden"
    style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; display: flex; align-items: center; justify-content: center;">
    <div
      style="background: var(--bg-elevated); padding: 20px; border-radius: var(--radius-lg); width: 600px; max-width: 90%; box-shadow: var(--shadow-soft);">
      <div class="section-title">Generate with AI</div>
      <div class="form-group">
      <label class="form-label">Provider</label>
      <select id="aiProvider" class="form-select">
        <option value="gemini">Google Gemini</option>
        <option value="openrouter">OpenRouter</option>
        <option value="openai">OpenAI (ChatGPT)</option>
        <option value="grok">xAI (Grok)</option>
        <option value="anythingllm">AnythingLLM (Local)</option>
        <option value="chutes">Chutes.ai</option>
      </select>
    </div>
    <div class="form-group">
        <label class="form-label">Model ID</label>
        <input list="aiModels" id="aiModel" class="form-input" value="gemini-2.5-flash"
          placeholder="Type or select model...">

        <datalist id="aiModels">
          <option value="gemini-2.5-flash">
          <option value="gemini-2.5-pro">
          <option value="gemini-2.0-flash">
          <option value="gemini-2.0-pro-exp">
          <option value="gpt-4o">
          <option value="gpt-4-turbo">
          <option value="grok-beta">
          <option value="grok-2">
        <option value="anthropic/claude-3.5-sonnet">
        <option value="meta-llama/llama-3-70b-instruct">
        <option value="deepseek/deepseek-r1">
        </datalist>

        <div class="form-help">Select 'Flash' for speed or 'Pro' for complex reasoning.</div>
      </div>
      <div class="form-group">
        <label class="form-label">Prompt</label>
        <textarea id="aiPrompt" class="form-textarea" style="min-height: 120px;"></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Generated Text</label>
        <textarea id="aiResult" class="form-textarea" style="min-height: 150px;" readonly></textarea>
      </div>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
        <button type="button" class="pill-button success" onclick="window.generateAiText()">Generate</button>
        <div>
          <button id="insertAiResultBtn" type="button" class="pill-button"
            onclick="window.insertAiResult()">Insert</button>
          <button type="button" class="pill-button danger" onclick="window.closeAiModal()">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Script Loader Modal -->
  <div id="scriptLoaderModal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 300; display: flex; align-items: center; justify-content: center;">
    <div style="background: var(--bg-elevated); padding: 20px; border-radius: var(--radius-lg); width: 600px; max-width: 90%; box-shadow: var(--shadow-soft); display: flex; flex-direction: column; gap: 16px;">
      <div class="section-title">Script Loader</div>
      <div style="padding: 12px; background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); border-radius: var(--radius-md); margin-bottom: 8px;">
        <strong style="color: var(--danger);">‚ö†Ô∏è Security Warning:</strong>
        <div style="font-size: 11px; margin-top: 4px; color: var(--text-muted);">
          Only load scripts from trusted sources you created yourself. Loading untrusted scripts can execute malicious code.
        </div>
      </div>
      <div class="form-help">Add multiple scripts. Top runs first. Primary determines save filename/template.</div>
      
      <div id="scriptLoaderList" style="max-height: 300px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; border: 1px solid var(--border-subtle); padding: 8px; border-radius: var(--radius-md); background: rgba(0,0,0,0.2); min-height: 100px;">
        <!-- Scripts go here -->
      </div>

      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; gap: 8px;">
          <button class="pill-button small" onclick="document.getElementById('scriptLoaderInput').click()">+ Add Scripts</button>
          <button class="pill-button small danger" onclick="window.clearScriptLoader()">Clear All</button>
        </div>
        <div style="display: flex; gap: 8px;">
          <button class="pill-button" onclick="(window._closeModalById?window._closeModalById('scriptLoaderModal'):document.getElementById('scriptLoaderModal').classList.add('hidden'))">Cancel</button>
          <button class="pill-button" onclick="window.processLoadedScripts('append')">Merge</button>
          <button class="pill-button success" onclick="window.processLoadedScripts('overwrite')">Load</button>
        </div>
      </div>
    </div>
  </div>
  <input type="file" id="scriptLoaderInput" accept=".js,.txt" multiple style="display:none;" onchange="window.handleScriptLoaderFiles(event)">

  <!-- Search & Replace Modal -->
  <div id="searchReplaceModal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 400; display: flex; align-items: center; justify-content: center;">
    <div style="background: var(--bg-elevated); padding: 20px; border-radius: var(--radius-lg); width: 600px; max-width: 90%; box-shadow: var(--shadow-soft); display: flex; flex-direction: column; gap: 16px;">
      <div class="section-title">Search & Replace</div>
      <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 12px;">
        <div class="form-group">
          <label class="form-label">Find</label>
          <input id="srFind" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">Replace With</label>
          <input id="srReplace" class="form-input">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Scope (Fields to search in)</label>
        <div class="radio-group" style="gap: 16px; font-size: 12px;">
          <label><input type="checkbox" id="srScopeIds" checked> ID/Key</label>
          <label><input type="checkbox" id="srScopeGroup" checked> Group</label>
          <label><input type="checkbox" id="srScopeTags" checked> Keywords/Tags</label>
          <label><input type="checkbox" id="srScopePersonality" checked> Personality/Injection</label>
          <label><input type="checkbox" id="srScopeScenario" checked> Scenario</label>
        </div>
      </div>
      <div class="form-group">
        <label style="font-size: 12px;"><input type="checkbox" id="srCaseSensitive"> Case Sensitive</label>
      </div>
      <div style="display: flex; justify-content: flex-end; gap: 8px;">
        <button class="pill-button" onclick="(window._closeModalById?window._closeModalById('searchReplaceModal'):document.getElementById('searchReplaceModal').classList.add('hidden'))">Cancel</button>
        <button class="pill-button success" onclick="window.executeSearchReplace()">Replace All</button>
      </div>
    </div>
  </div>

  <!-- Validation Modal -->
  <div id="validationModal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 400; display: flex; align-items: center; justify-content: center;">
    <div style="background: var(--bg-elevated); padding: 20px; border-radius: var(--radius-lg); width: 800px; max-width: 90%; box-shadow: var(--shadow-soft); display: flex; flex-direction: column; gap: 16px;">
      <div class="section-title">Validation Report</div>
      <div id="validationResultList" style="max-height: 400px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 10px; border-radius: var(--radius-md); font-size: 12px; font-family: monospace; line-height: 1.5;">
        <!-- Results go here -->
      </div>
      <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">
        <div style="display: flex; gap: 8px;">
          <button id="btnFixContradictions" class="pill-button" onclick="window.fixAllContradictions()" style="display:none;">Auto-Fix Simple</button>
          <button id="btnAiAutoFix" class="pill-button" onclick="window.openAiAutoFix()" style="display:none;">ü§ñ AI Auto-Fix</button>
          <button id="btnAiRepair" class="pill-button" onclick="window.openAiRepair()" style="display:none;">ü§ñ AI Repair</button>
        </div>
        <button class="pill-button success" onclick="(window._closeModalById?window._closeModalById('validationModal'):document.getElementById('validationModal').classList.add('hidden'))">Close</button>
      </div>
    </div>
  </div>


  <!-- Reset All Modal -->
  <div id="resetAllModal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 450; display: flex; align-items: center; justify-content: center;">
    <div style="background: var(--bg-elevated); padding: 20px; border-radius: var(--radius-lg); width: 560px; max-width: 92%; box-shadow: var(--shadow-soft); display: flex; flex-direction: column; gap: 14px;">
      <div class="section-title" style="color: var(--danger);">Reset all values</div>
      <div class="form-help">
        This clears <b>all</b> local AURA data (autosave, globals, UI state). This cannot be undone.<br>
        Type <code>RESET</code> to confirm.
      </div>
      <input id="resetAllConfirmInput" class="form-input" placeholder="Type RESET to confirm" oninput="window._onResetConfirmInput(this)">
      <div style="display:flex; justify-content:flex-end; gap:8px;">
        <button class="pill-button" type="button" onclick="window._closeModalById('resetAllModal')">Cancel</button>
        <button id="btnResetAllConfirm" class="pill-button danger" type="button" onclick="window.confirmResetAll()" disabled>Reset</button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteConfirmModal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 450; display: flex; align-items: center; justify-content: center;">
    <div style="background: var(--bg-elevated); padding: 20px; border-radius: var(--radius-lg); width: 460px; max-width: 92%; box-shadow: var(--shadow-soft); display: flex; flex-direction: column; gap: 14px;">
      <div class="section-title" style="color: var(--danger);">Confirm Delete</div>
      <div id="deleteConfirmMessage" class="form-help"></div>
      <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer; user-select: none;">
        <input type="checkbox" id="deleteConfirmDontAsk" style="cursor: pointer;">
        <span>Don't ask me again</span>
      </label>
      <div style="display:flex; justify-content:flex-end; gap:8px;">
        <button class="pill-button" type="button" onclick="window._closeModalById('deleteConfirmModal')">Cancel</button>
        <button id="btnDeleteConfirm" class="pill-button danger" type="button" onclick="window.confirmDelete()">Delete</button>
      </div>
    </div>
  </div>

  <!-- API Key Manager Modal -->
  <div id="apiKeyManagerModal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 450; display: flex; align-items: center; justify-content: center;">
    <div style="background: var(--bg-elevated); padding: 20px; border-radius: var(--radius-lg); width: 600px; max-width: 92%; box-shadow: var(--shadow-soft); display: flex; flex-direction: column; gap: 14px;">
      <div class="section-title">üîë API Key Manager</div>

      <div style="display: flex; flex-direction: column; gap: 10px;">
        <div class="form-group">
          <label class="form-label">Key Name</label>
          <input type="text" id="newKeyName" class="form-input" placeholder="e.g., Gemini Personal, OpenRouter Work">
        </div>
        <div class="form-group">
          <label class="form-label">API Key</label>
          <input type="password" id="newKeyValue" class="form-input" placeholder="Enter API Key">
        </div>
        <button class="pill-button success" onclick="window.addNewApiKey()">‚ûï Add Key</button>
      </div>

      <div class="section-title" style="margin-top: 10px;">Saved Keys</div>
      <div id="apiKeysList" style="max-height: 300px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 10px; border-radius: var(--radius-md);">
        <!-- Keys list will be populated here -->
      </div>

      <div style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 10px;">
        <button class="pill-button" onclick="window._closeModalById('apiKeyManagerModal')">Close</button>
      </div>
    </div>
  </div>

  <!-- Duplicate To Modal -->
  <div id="dupModal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 200; display: flex; align-items: center; justify-content: center;">
    <div style="background: var(--bg-elevated); padding: 20px; border-radius: var(--radius-lg); width: 400px; max-width: 90%; box-shadow: var(--shadow-soft);">
      <div class="section-title">Duplicate To...</div>
      <div class="form-group">
        <label class="form-label">Target Type</label>
        <select id="dupTargetType" class="form-select">
          <option value="same">Same Type</option>
          <option value="characters">Character</option>
          <option value="pairs">Pair</option>
          <option value="dynamiclore">Lore Entry</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">New Group (Optional)</label>
        <input id="dupTargetGroup" class="form-input" placeholder="Enter group name...">
      </div>
      <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
        <button type="button" class="pill-button danger" onclick="(window._closeModalById?window._closeModalById('dupModal'):document.getElementById('dupModal').classList.add('hidden'))">Cancel</button>
        <button type="button" class="pill-button success" onclick="window.executeDuplicateTo()">Duplicate</button>
      </div>
    </div>
  </div>

  <!-- Keyboard Shortcuts Modal -->
  <div id="keyboardShortcutsModal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 200; display: flex; align-items: center; justify-content: center;">
    <div style="background: var(--bg-elevated); padding: 24px; border-radius: var(--radius-lg); width: 500px; max-width: 90%; box-shadow: var(--shadow-soft);">
      <div class="section-title" style="margin-bottom: 20px;">‚å®Ô∏è Keyboard Shortcuts</div>
      <div style="display: grid; gap: 12px;">
        <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(0,0,0,0.2); border-radius: var(--radius-md);">
          <span style="color: var(--text-soft);">New Entry</span>
          <kbd style="background: var(--bg-elevated-2); padding: 4px 8px; border-radius: 4px; font-family: monospace; font-size: 12px;">Ctrl + N</kbd>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(0,0,0,0.2); border-radius: var(--radius-md);">
          <span style="color: var(--text-soft);">Duplicate Entry</span>
          <kbd style="background: var(--bg-elevated-2); padding: 4px 8px; border-radius: 4px; font-family: monospace; font-size: 12px;">Ctrl + D</kbd>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(0,0,0,0.2); border-radius: var(--radius-md);">
          <span style="color: var(--text-soft);">Delete Entry</span>
          <kbd style="background: var(--bg-elevated-2); padding: 4px 8px; border-radius: 4px; font-family: monospace; font-size: 12px;">Delete</kbd>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(0,0,0,0.2); border-radius: var(--radius-md);">
          <span style="color: var(--text-soft);">Search</span>
          <kbd style="background: var(--bg-elevated-2); padding: 4px 8px; border-radius: 4px; font-family: monospace; font-size: 12px;">Ctrl + F</kbd>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(0,0,0,0.2); border-radius: var(--radius-md);">
          <span style="color: var(--text-soft);">Find & Replace</span>
          <kbd style="background: var(--bg-elevated-2); padding: 4px 8px; border-radius: 4px; font-family: monospace; font-size: 12px;">Ctrl + H</kbd>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(0,0,0,0.2); border-radius: var(--radius-md);">
          <span style="color: var(--text-soft);">Quick Switcher</span>
          <kbd style="background: var(--bg-elevated-2); padding: 4px 8px; border-radius: 4px; font-family: monospace; font-size: 12px;">Ctrl + P</kbd>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(0,0,0,0.2); border-radius: var(--radius-md);">
          <span style="color: var(--text-soft);">Save to File</span>
          <kbd style="background: var(--bg-elevated-2); padding: 4px 8px; border-radius: 4px; font-family: monospace; font-size: 12px;">Ctrl + S</kbd>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(0,0,0,0.2); border-radius: var(--radius-md);">
          <span style="color: var(--text-soft);">Keyboard Shortcuts</span>
          <kbd style="background: var(--bg-elevated-2); padding: 4px 8px; border-radius: 4px; font-family: monospace; font-size: 12px;">Ctrl + ?</kbd>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(0,0,0,0.2); border-radius: var(--radius-md);">
          <span style="color: var(--text-soft);">Close Modal</span>
          <kbd style="background: var(--bg-elevated-2); padding: 4px 8px; border-radius: 4px; font-family: monospace; font-size: 12px;">Escape</kbd>
        </div>
      </div>
      <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
        <button type="button" class="pill-button" onclick="(window._closeModalById?window._closeModalById('keyboardShortcutsModal'):document.getElementById('keyboardShortcutsModal').classList.add('hidden'))">Close</button>
      </div>
    </div>
  </div>

  <!-- Tutorial Elements -->
  <div id="tutorialRing" class="highlight-ring" style="display:none;"></div>
  <div id="tutorialTooltip" class="tutorial-tooltip">
    <h4 id="tutTitle">Title</h4>
    <p id="tutText">Description</p>
    <div class="tutorial-actions"><button class="pill-button small danger" onclick="window.endTutorial()">Exit</button><button class="pill-button small success" onclick="window.nextTutorialStep()">Next</button></div>
  </div>

  <script>
    // ============================================================================
    // AURA Data Manager ‚Äî patched for AURA+ v15
    // - Exports: ENTITY_DB, RELATIONSHIP_DB, DYNAMIC_LORE
    // - Removes v7 neural switch sliders + presets
    // - Adds v15 emotion-gate dropdowns (EMOTIONS: ANGER, JOY, SADNESS, FEAR, ROMANCE, NEUTRAL)
    // - Keeps: Characters, Pairs (Relationships), DynamicLore, Shifts, Import/Export, Code view
    // ============================================================================

    (function () {
      "use strict";

      // --------------------------------------------------------------------------
      // Constants - v15 emotion set (as defined in AURA+v15 docs)
      // --------------------------------------------------------------------------
      var EMOTIONS = ["ANGER", "JOY", "SADNESS", "FEAR", "ROMANCE", "NEUTRAL"];
      var EROS_INTENSITIES = ["platonic", "tension", "romance", "physical", "passion", "explicit", "conflict", "aftercare"];
      var INTENTS = ["question", "disclosure", "command", "promise", "conflict", "smalltalk", "meta", "narrative"];

      // UI Constants
      var TOAST_DURATION = 3000; // milliseconds
      var TOAST_FADE_DURATION = 300; // milliseconds
      var SCROLL_DELAY = 50; // milliseconds
      var GRAPH_RENDER_DELAY = 50; // milliseconds
      var GRAPH_RESIZE_DELAY = 300; // milliseconds (longer for resize operations)
      var REFOCUS_DELAY = 50; // milliseconds

      // Validation Limits
      var MAX_EMOTION_GATES = 2;
      var MAX_EROS_GATES = 2;
      var MAX_INTENT_GATES = 1;

      // Graph Physics Constants
      var GRAPH_REPULSION_FORCE = 10000;
      var GRAPH_REPULSION_MULTIPLIER = 0.5;
      var GRAPH_CENTER_GRAVITY = 0.005;
      var GRAPH_LINK_STIFFNESS = 0.05;
      var GRAPH_DRAG = 0.9;

      // --------------------------------------------------------------------------
      // App State
      // --------------------------------------------------------------------------
      var STATE = {
        templateText: null,
        type: "characters", // characters | pairs | dynamiclore
        entryId: null,
        selectedIds: [], // Multi-select support
        lastSelectedId: null, // For shift-click range selection
        data: {
          characters: [],
          pairs: [],
          dynamiclore: []
        },
        activeScripts: []
      };

      // ------------------------------------------------------------
      // UX State + Dirty Guard (refresh/close protection)
      // ------------------------------------------------------------
      STATE.isDirty = false;

      function setDirty() {
        try {
          STATE.isDirty = true;
          updateSaveIndicator('unsaved');
        } catch (_e) {}
      }

      function clearDirty() {
        try {
          STATE.isDirty = false;
          // updateSaveIndicator('saved') is handled by autoSave()
        } catch (_e) {}
      }

      // Persist lightweight UI state (tab/type/selection/search) across reloads
      var UI_STATE_KEY = 'aura_ui_state';

      function loadUiState() {
        try {
          var raw = localStorage.getItem(UI_STATE_KEY);
          if (!raw) return null;
          var s = JSON.parse(raw);
          if (!s || typeof s !== 'object') return null;
          return s;
        } catch (_e) { return null; }
      }

      function saveUiState(patch) {
        try {
          var cur = loadUiState() || {};
          for (var k in patch) cur[k] = patch[k];
          localStorage.setItem(UI_STATE_KEY, JSON.stringify(cur));
        } catch (_e) {}
      }

      function applyUiState() {
        var s = loadUiState();
        if (!s) return;

        // Type
        if (s.type && (s.type === 'characters' || s.type === 'pairs' || s.type === 'dynamiclore')) {
          STATE.type = s.type;
        }

        // Search
        try {
          var si = document.getElementById('searchInput');
          var cb = document.getElementById('searchClear');
          if (si && typeof s.search === 'string') {
            si.value = s.search;
            if (cb) cb.style.display = si.value ? 'inline-flex' : 'none';
          }
        } catch (_e0) {}

        // Selection (apply after list renders)
        if (s.entryId) {
          STATE.entryId = s.entryId;
          STATE.selectedIds = [s.entryId];
          STATE.lastSelectedId = s.entryId;
        }
        if (s.shiftId) STATE.shiftId = s.shiftId;

        // Tabs (apply after DOM is ready)
        if (s.tab) {
          try { window.switchTab(String(s.tab)); } catch (_e1) {}
        } else {
          try { window.switchType(STATE.type); } catch (_e2) {}
        }
      }

      window.addEventListener('beforeunload', function (e) {
        try {
          if (!STATE.isDirty) return;
          e.preventDefault();
          // Required for Chrome
          e.returnValue = '';
          return '';
        } catch (_e) {}
      });


      // --------------------------------------------------------------------------
      // Utilities
      // --------------------------------------------------------------------------

      /**
       * Generate a unique ID with a prefix
       * @param {string} prefix - The prefix for the ID
       * @returns {string} A unique identifier
       */
      function id(prefix) {
        return prefix + "_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);
      }

      /**
       * Escape HTML special characters to prevent XSS attacks
       * @param {*} s - The string to escape
       * @returns {string} HTML-safe string
       */
      function escHtml(s) {
        return (s == null ? "" : String(s))
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      /**
       * Convert value to array, ensuring consistent array output
       * @param {*} v - Value to convert
       * @returns {Array} Array representation of the value
       */
      function toArray(v) {
        if (!v) return [];
        if (Array.isArray(v)) return v.slice();
        return [v];
      }

      /**
       * Split comma-separated text into trimmed array
       * @param {string} text - Comma-separated text
       * @returns {Array<string>} Array of trimmed non-empty strings
       */
      function splitCsv(text) {
        if (!text) return [];
        return String(text)
          .split(",")
          .map(function (t) { return t.trim(); })
          .filter(Boolean);
      }

      /**
       * Join array into comma-separated string
       * @param {Array} arr - Array to join
       * @returns {string} Comma-separated string
       */
      function joinCsv(arr) {
        if (!arr || !arr.length) return "";
        return arr.join(", ");
      }

      function findEntry(id, entries) {
        for (const entry of entries) {
          if (entry.id === id) {
            return entry;
          }
          if (entry.shifts) {
            const found = findEntry(id, entry.shifts);
            if (found) {
              return found;
            }
          }
        }
        return null;
      }

      function stringToColor(str) {
        if (!str) return '#ffffff';
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
          hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }
        let color = '#';
        for (let i = 0; i < 3; i++) {
          let value = (hash >> (i * 8)) & 0xFF;
          color += ('00' + value.toString(16)).substr(-2);
        }
        return color;
      }

      function charKeys() {
        return STATE.data.characters.map(function (c) { return c.key; }).filter(Boolean);
      }

      function curr() {
        if (!STATE.entryId) return null;
        return findEntry(STATE.entryId, STATE.data[STATE.type]);
      }

      function save(patch) {
        var entry = curr();
        if (entry) {
          setDirty();
          for (var k in patch) entry[k] = patch[k];
          renderList();
          renderCode();
          autoSave(); // Auto-save to localStorage
        }
      }

      /**
       * Auto-save current state to localStorage
       */
      function autoSave() {
        try {
          var dataToSave = {
            characters: STATE.data.characters,
            pairs: STATE.data.pairs,
            dynamiclore: STATE.data.dynamiclore,
            timestamp: Date.now()
          };
          localStorage.setItem('aura_data_autosave', JSON.stringify(dataToSave));

          // Update templateText to reflect current data state
          // This ensures exports always use up-to-date content
          if (STATE.templateText) {
            STATE.templateText = patchFullFile(STATE.templateText);
          }

          updateSaveIndicator('saved');
          clearDirty();
        } catch (err) {
          console.error('Auto-save failed:', err);
          updateSaveIndicator('error');
        }
      }

      /**
       * Load data from localStorage if available
       */
      function autoLoad() {
        try {
          var saved = localStorage.getItem('aura_data_autosave');
          if (saved) {
            var data = JSON.parse(saved);
            if (data.characters && data.pairs && data.dynamiclore) {
              STATE.data.characters = data.characters;
              STATE.data.pairs = data.pairs;
              STATE.data.dynamiclore = data.dynamiclore;

              var date = new Date(data.timestamp);
              var timeStr = date.toLocaleString();
              window.showToast('Auto-saved data loaded from ' + timeStr, 'success');
              return true;
            }
          }
        } catch (err) {
          console.error('Auto-load failed:', err);
        }
        return false;
      }

      /**
       * Update save status indicator in UI
       * @param {string} status - 'saved', 'unsaved', or 'error'
       */
      function updateSaveIndicator(status) {
        var indicator = document.getElementById('saveIndicator');
        var text = document.getElementById('saveText');
        if (!indicator || !text) return;

        if (status === 'saved') {
          indicator.style.color = 'var(--success)';
          text.textContent = 'Auto-saved';
        } else if (status === 'unsaved') {
          indicator.style.color = 'var(--warning)';
          text.textContent = 'Unsaved changes';
        } else if (status === 'error') {
          indicator.style.color = 'var(--danger)';
          text.textContent = 'Save error';
        }
      }

      /**
       * Show keyboard shortcuts modal
       */
      window.showKeyboardShortcuts = function() {
        (window.ModalManager&&window.ModalManager.open?window.ModalManager.open(document.getElementById('keyboardShortcutsModal')):document.getElementById('keyboardShortcutsModal').classList.remove('hidden'));
      };

      // Helper: bracket matching for safe import slicing
      function findMatchingBracket(str, startPos, openChar, closeChar) {
        var depth = 1;
        var inString = false;
        var strChar = null;
        var inComment = false;
        var inMulti = false;
        
        for (var i = startPos + 1; i < str.length; i++) {
          var c = str[i];
          
          if (inComment) { if (c === '\n') inComment = false; continue; }
          if (inMulti) { if (c === '*' && str[i+1] === '/') { inMulti = false; i++; } continue; }
          if (inString) {
            if (c === strChar) {
               var esc = false;
               var k = i - 1;
               while (k >= 0 && str[k] === '\\') { esc = !esc; k--; }
               if (!esc) inString = false;
            }
            continue;
          }
          
          if (c === '/' && str[i+1] === '/') { inComment = true; i++; continue; }
          if (c === '/' && str[i+1] === '*') { inMulti = true; i++; continue; }
          
          if (c === '"' || c === "'" || c === '`') { inString = true; strChar = c; }
          else if (c === openChar) depth++;
          else if (c === closeChar) {
            depth--;
            if (depth === 0) return i;
          }
        }
        return -1;
      }

      async function saveTextToFile(content, suggestedName, fileTypes) {
        // Modern API with "Save As" dialog
        if (window.showSaveFilePicker) {
            try {
                const handle = await window.showSaveFilePicker({
                    suggestedName: suggestedName,
                    types: fileTypes,
                });
                const writable = await handle.createWritable();
                await writable.write(content);
                await writable.close();
                window.showToast('File saved successfully!', 'success');
            } catch (err) {
                // AbortError is expected if the user cancels the dialog.
                if (err.name !== 'AbortError') {
                    console.error('File save error:', err);
                    window.showToast('Error saving file: ' + err.message, 'error');
                }
            }
        } else {
            // Fallback for older browsers (auto-downloads)
            const blob = new Blob([content], { type: Object.keys(fileTypes[0].accept)[0] });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = suggestedName;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                window.showToast('File saved to Downloads folder.', 'success');
            }, 100);
        }
      }

      window.updateStats = function(inputId, outputId) {
        var text = "";
        var quill = window.quillInstances && window.quillInstances[inputId];
        if (quill) {
          text = quill.getText() || "";
        } else {
          var el = document.getElementById(inputId);
          text = el ? (el.value || el.innerText || "") : "";
        }
        var words = text.trim() ? text.trim().split(/\s+/).length : 0;
        var chars = text.length;
        var tokens = Math.ceil(chars / 4); // Rough estimate for LLMs
        document.getElementById(outputId).innerText = words + " words / ~" + tokens + " tokens";
      };

      /**
       * Display a toast notification to the user
       * @param {string} msg - The message to display
       * @param {string} type - The type of toast: 'info', 'success', 'error'
       */
      window.showToast = function(msg, type) {
        type = type || 'info';
        var container = document.querySelector('.toast-container');
        if (!container) {
          container = document.createElement('div');
          container.className = 'toast-container';
          document.body.appendChild(container);
        }
        var toast = document.createElement('div');
        toast.className = 'toast ' + type;
        toast.textContent = msg; // Use textContent instead of innerText for security
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'polite');
        container.appendChild(toast);
        setTimeout(function() {
          toast.style.animation = 'fadeOut ' + (TOAST_FADE_DURATION / 1000) + 's forwards';
          setTimeout(function() {
            if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
            }
          }, TOAST_FADE_DURATION);
        }, TOAST_DURATION);
      };

      // --------------------------------------------------------------------------
      // Download helpers (backup/export safety)
      // --------------------------------------------------------------------------
      function _downloadText(filename, text, mime) {
        mime = mime || 'text/plain;charset=utf-8';
        try {
          var blob = new Blob([String(text)], { type: mime });
          var url = URL.createObjectURL(blob);
          var a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          setTimeout(function(){ try{ URL.revokeObjectURL(url); }catch(_e){} }, 250);
        } catch (_e2) {
          try { window.open('data:' + mime + ',' + encodeURIComponent(String(text))); } catch (_e3) {}
        }
      }

      window.downloadBackupJson = function(reason) {
        reason = reason || 'backup';
        var snap = {
          schema: 'aura.backup',
          version: 1,
          reason: String(reason),
          createdAt: (new Date()).toISOString(),
          state: {
            type: STATE.type,
            entryId: STATE.entryId,
            shiftId: STATE.shiftId,
            templateText: STATE.templateText || null,
            activeScripts: STATE.activeScripts || [],
            data: STATE.data
          }
        };
        var name = 'AURA-backup-' + reason + '-' + (new Date().toISOString().replace(/[:.]/g,'-')) + '.json';
        _downloadText(name, JSON.stringify(snap, null, 2), 'application/json;charset=utf-8');
      };



      // --------------------------------------------------------------------------
      // API Key Management (Multi-Key Support)
      // --------------------------------------------------------------------------
      window.getApiKeys = function() {
        try {
          var keys = localStorage.getItem('aura_api_keys');
          return keys ? JSON.parse(keys) : {};
        } catch (e) {
          return {};
        }
      };

      window.saveApiKeys = function(keys) {
        localStorage.setItem('aura_api_keys', JSON.stringify(keys));
      };

      window.getActiveKeyName = function() {
        return localStorage.getItem('aura_active_key') || '';
      };

      window.setActiveKeyName = function(name) {
        localStorage.setItem('aura_active_key', name);
      };

      window.saveApiKey = function() {
        var selector = document.getElementById('apiKeySelector');
        var keyInput = document.getElementById('apiKey');
        var selectedName = selector.value;
        var keyValue = keyInput.value.trim();

        if (!keyValue) {
          window.showToast('Please enter an API key', 'error');
          return;
        }

        if (!selectedName) {
          window.showToast('Please select a key name or create a new one in Key Manager', 'error');
          return;
        }

        var keys = window.getApiKeys();
        keys[selectedName] = keyValue;
        window.saveApiKeys(keys);
        window.setActiveKeyName(selectedName);

        window.showToast('API Key "' + selectedName + '" saved!', 'success');
        window.refreshApiKeySelector();
      };

      window.switchApiKey = function() {
        var selector = document.getElementById('apiKeySelector');
        var keyInput = document.getElementById('apiKey');
        var selectedName = selector.value;

        if (!selectedName) {
          keyInput.value = '';
          return;
        }

        var keys = window.getApiKeys();
        keyInput.value = keys[selectedName] || '';
        window.setActiveKeyName(selectedName);
      };

      window.refreshApiKeySelector = function() {
        var selector = document.getElementById('apiKeySelector');
        var keys = window.getApiKeys();
        var activeKey = window.getActiveKeyName();

        selector.innerHTML = '<option value="">Select API Key...</option>';

        Object.keys(keys).forEach(function(name) {
          var option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          if (name === activeKey) option.selected = true;
          selector.appendChild(option);
        });
      };

      window.openApiKeyManager = function() {
        window.renderApiKeysList();
        document.getElementById('apiKeyManagerModal').classList.remove('hidden');
      };

      window.renderApiKeysList = function() {
        var keys = window.getApiKeys();
        var activeKey = window.getActiveKeyName();
        var listEl = document.getElementById('apiKeysList');

        if (Object.keys(keys).length === 0) {
          listEl.innerHTML = '<div style="color: var(--text-soft); text-align: center; padding: 20px;">No API keys saved yet.</div>';
          return;
        }

        var html = '';
        Object.keys(keys).forEach(function(name) {
          var isActive = (name === activeKey);
          html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin-bottom: 6px; background: ' + (isActive ? 'rgba(79, 70, 229, 0.2)' : 'rgba(0,0,0,0.3)') + '; border: 1px solid ' + (isActive ? 'rgba(129, 140, 248, 0.5)' : 'var(--border)') + '; border-radius: var(--radius-md);">';
          html += '<div style="flex: 1;">';
          html += '<div style="font-weight: 600; font-size: 13px;">' + escHtml(name) + (isActive ? ' <span style="color: var(--success); font-size: 11px;">‚óè Active</span>' : '') + '</div>';
          html += '<div style="font-size: 11px; color: var(--text-soft); font-family: monospace;">***' + keys[name].slice(-8) + '</div>';
          html += '</div>';
          html += '<div style="display: flex; gap: 6px;">';
          if (!isActive) {
            html += '<button class="pill-button small" onclick="window.setApiKeyActive(\'' + escHtml(name) + '\')">Use</button>';
          }
          html += '<button class="pill-button danger small" onclick="window.deleteApiKey(\'' + escHtml(name) + '\')">Delete</button>';
          html += '</div>';
          html += '</div>';
        });

        listEl.innerHTML = html;
      };

      window.addNewApiKey = function() {
        var nameInput = document.getElementById('newKeyName');
        var valueInput = document.getElementById('newKeyValue');
        var name = nameInput.value.trim();
        var value = valueInput.value.trim();

        if (!name) {
          window.showToast('Please enter a name for the key', 'error');
          return;
        }

        if (!value) {
          window.showToast('Please enter an API key', 'error');
          return;
        }

        var keys = window.getApiKeys();
        keys[name] = value;
        window.saveApiKeys(keys);

        // Set as active if it's the first key
        if (Object.keys(keys).length === 1 || !window.getActiveKeyName()) {
          window.setActiveKeyName(name);
        }

        nameInput.value = '';
        valueInput.value = '';

        window.showToast('API Key "' + name + '" added!', 'success');
        window.renderApiKeysList();
        window.refreshApiKeySelector();
        window.switchApiKey();
      };

      window.deleteApiKey = function(name) {
        if (!confirm('Delete API key "' + name + '"?')) return;

        var keys = window.getApiKeys();
        delete keys[name];
        window.saveApiKeys(keys);

        // If we deleted the active key, clear it
        if (window.getActiveKeyName() === name) {
          window.setActiveKeyName('');
          document.getElementById('apiKey').value = '';
        }

        window.showToast('API Key "' + name + '" deleted', 'success');
        window.renderApiKeysList();
        window.refreshApiKeySelector();
      };

      window.setApiKeyActive = function(name) {
        window.setActiveKeyName(name);
        window.renderApiKeysList();
        window.refreshApiKeySelector();
        window.switchApiKey();
        window.showToast('Switched to "' + name + '"', 'success');
      };

      // --------------------------------------------------------------------------
      // Navigation / Tabs
      // --------------------------------------------------------------------------
      window.switchType = function (type, e) {
        STATE.type = type;
        try{ saveUiState({ type: type, entryId: null, shiftId: null }); }catch(_e0){}
        STATE.entryId = null;
        STATE.shiftId = null;
        STATE.selectedIds = [];
        STATE.lastSelectedId = null;
        
        var searchInput = document.getElementById("searchInput");
        if (searchInput) {
          searchInput.value = "";
          var clearBtn = document.getElementById("searchClear");
          if(clearBtn) clearBtn.style.display = 'none';
        }

        var btns = document.querySelectorAll(".data-type-btn");
        for (var i = 0; i < btns.length; i++) btns[i].classList.remove("active");
        if (e && e.target) e.target.classList.add("active");

        document.getElementById("btnAddShift").style.display = type === "dynamiclore" ? "inline-flex" : "none";
        document.getElementById("btnAddAiShift").style.display = type === "dynamiclore" ? "inline-flex" : "none";

        renderList();
        renderEditor();
        renderCode();
      };

      window.switchTab = function (tab) {
        try{ saveUiState({ tab: tab }); }catch(_e0){}
        var vis = document.getElementById("visualEditor");
        var code = document.getElementById("codeView");
        var graph = document.getElementById("graphView");
        var lab = document.getElementById("laboratoryView");
        var personality = document.getElementById("personalityEditor");
        var scenario = document.getElementById("scenarioEditor");
        var initialMessage = document.getElementById("initialMessageEditor");

        vis.classList.add("hidden");
        code.classList.add("hidden");
        graph.classList.add("hidden");
        lab.classList.add("hidden");
        personality.classList.add("hidden");
        scenario.classList.add("hidden");
        initialMessage.classList.add("hidden");

        var btns = document.querySelectorAll(".tab-button");
        for (var i = 0; i < btns.length; i++) {
          btns[i].classList.remove("active");
        }

        if (tab === "visual") {
          vis.classList.remove("hidden");
          btns[0].classList.add("active");
        } else if (tab === 'code') {
          code.classList.remove("hidden");
          btns[1].classList.add("active");
          renderCode();
        } else if (tab === 'graph') {
          graph.classList.remove("hidden");
          btns[2].classList.add("active");
          setTimeout(window.renderGraph, GRAPH_RENDER_DELAY);
        } else if (tab === 'laboratory') {
          lab.classList.remove("hidden");
          btns[3].classList.add("active");
          // Populate lab textareas
          window.setQuillText('labPersonality', window.getQuillText('personalityTextarea'));
          window.setQuillText('labScenario', window.getQuillText('scenarioTextarea'));
          window.renderContextDebug();
        } else if (tab === 'personality') {
          personality.classList.remove("hidden");
          btns[4].classList.add("active");
        } else if (tab === 'scenario') {
          scenario.classList.remove("hidden");
          btns[5].classList.add("active");
        } else if (tab === 'initialMessage') {
          initialMessage.classList.remove("hidden");
          btns[6].classList.add("active");
        }
      };

      window.savePersonality = function () {
        var text = window.getQuillText('personalityTextarea');
        var fileTypes = [{ description: 'Text Files', accept: { 'text/plain': ['.txt'] } }];
        saveTextToFile(text, 'personality.txt', fileTypes);
      }

      window.saveScenario = function () {
        var text = window.getQuillText('scenarioTextarea');
        var fileTypes = [{ description: 'Text Files', accept: { 'text/plain': ['.txt'] } }];
        saveTextToFile(text, 'scenario.txt', fileTypes);
      }

      window.saveInitialMessage = function () {
        var text = window.getQuillText('initialMessageTextarea');
        var fileTypes = [{ description: 'Text Files', accept: { 'text/plain': ['.txt'] } }];
        saveTextToFile(text, 'initial_message.txt', fileTypes);
      }

      window.selectEntry = function (entryId, shiftId, event) {
        // Handle multi-select with Ctrl/Shift
        if (event && !shiftId) {
          var arr = STATE.data[STATE.type];

          if (event.ctrlKey || event.metaKey) {
            // Ctrl+click: Toggle selection
            var idx = STATE.selectedIds.indexOf(entryId);
            if (idx > -1) {
              STATE.selectedIds.splice(idx, 1);
            } else {
              STATE.selectedIds.push(entryId);
            }
            STATE.lastSelectedId = entryId;
          } else if (event.shiftKey && STATE.lastSelectedId) {
            // Shift+click: Select range (including shifts in display order)
            var flatList = [];
            var collectIds = function(entries, includeShifts) {
              for (var i = 0; i < entries.length; i++) {
                flatList.push(entries[i].id);
                // Recursively add shifts if they exist and are being shown
                if (includeShifts && entries[i].shifts && entries[i].shifts.length) {
                  collectIds(entries[i].shifts, true);
                }
              }
            };
            collectIds(arr, STATE.type === "dynamiclore");

            var startIdx = flatList.indexOf(STATE.lastSelectedId);
            var endIdx = flatList.indexOf(entryId);
            if (startIdx > -1 && endIdx > -1) {
              var min = Math.min(startIdx, endIdx);
              var max = Math.max(startIdx, endIdx);
              STATE.selectedIds = flatList.slice(min, max + 1);
            }
          } else {
            // Normal click: Single selection
            STATE.selectedIds = [entryId];
            STATE.lastSelectedId = entryId;
          }

          // Set primary selection to first selected (or the clicked one)
          STATE.entryId = STATE.selectedIds.length > 0 ? STATE.selectedIds[0] : entryId;
        } else {
          // Legacy single selection (for shift navigation)
          STATE.entryId = entryId;
          STATE.selectedIds = [entryId];
          STATE.lastSelectedId = entryId;
        }

        STATE.shiftId = shiftId || null;
        try{ saveUiState({ entryId: STATE.entryId, shiftId: STATE.shiftId }); }catch(_e0){}
        renderList(true);
        renderEditor();
        renderCode();
      };

      // --------------------------------------------------------------------------
      // CRUD
      // --------------------------------------------------------------------------
      window.createNew = function () {
        var newId = id(STATE.type);
        var newEntry;

        if (STATE.type === "characters") {
          newEntry = { id: newId, key: "", gender: "N", aliases: [], personality: "" };
        } else if (STATE.type === "pairs") {
          newEntry = { id: newId, pair: ["", ""], requireTags: [], injection: "", group: "" };
        } else {
          newEntry = {
            id: newId,
            id_name: "",
            priority: 2,
            group: "",
            keywords: [],
            tag: "",
            triggers: [],
            probability: "",
            block: [],
            andAny: [],
            andAll: [],
            notAll: [],
            andNone: [],
            andAnyEmotion: [],
            andAllEmotion: [],
            notAnyEmotion: [],
            notAllEmotion: [],
            andAnyLongTermEmotion: [],
            andAllLongTermEmotion: [],
            notAnyLongTermEmotion: [],
            notAllLongTermEmotion: [],
            andAnyEros: [],
            andAllEros: [],
            notAnyEros: [],
            notAllEros: [],
            andAnyLongTermEros: [],
            andAllLongTermEros: [],
            notAnyLongTermEros: [],
            notAllLongTermEros: [],
            andAnyIntent: [],
            andAllIntent: [],
            notAnyIntent: [],
            notAllIntent: [],
            personality: "",
            scenario: "",
            remove_personality: "",
            remove_scenario: "",
            characters: [],
            shifts: []
          };
        }

        STATE.data[STATE.type].push(newEntry);
        STATE.entryId = newId;
        STATE.shiftId = null;
        STATE.selectedIds = [newId];
        STATE.lastSelectedId = newId;

        renderList(true);
        renderEditor();
        renderCode();
        autoSave(); // Auto-save after creating new entry
        window.maybeRefreshGraph();
      };

      window.duplicate = function () {
        var entry = curr();
        if (!entry) return;
        var clone = JSON.parse(JSON.stringify(entry));
        clone.id = id(STATE.type);
        if (STATE.type === "characters" && clone.key) clone.key = String(clone.key) + "_copy";
        if (STATE.type === "dynamiclore" && clone.id_name) clone.id_name = String(clone.id_name) + "_copy";
        STATE.data[STATE.type].push(clone);
        STATE.entryId = clone.id;
        STATE.shiftId = null;
        STATE.selectedIds = [clone.id];
        STATE.lastSelectedId = clone.id;
        renderList(true);
        renderEditor();
        renderCode();
        autoSave(); // Auto-save after duplication
        window.maybeRefreshGraph();
      };

      window.toggleFocusMode = function() {
        document.body.classList.toggle('focus-mode');
      };

      window.toggleZenMode = function() {
        document.body.classList.toggle('zen-mode');
      };

      window.toggleContextPanel = function() {
        var p = document.getElementById('contextPanel');
        p.classList.toggle('hidden');

        // Refresh content
        if (!p.classList.contains('hidden')) {
          window.setQuillText('ctxPersonality', window.getQuillText('personalityTextarea'));
          window.setQuillText('ctxScenario', window.getQuillText('scenarioTextarea'));
          window.setQuillText('ctxInitialMessage', window.getQuillText('initialMessageTextarea'));

          // If graph is visible, resize it
          if (!document.getElementById('graphView').classList.contains('hidden')) {
            setTimeout(window.renderGraph, GRAPH_RESIZE_DELAY);
          }
        }
      };

      window.renderContextDebug = function() {
        var el = document.getElementById('scriptDebug');
        if (!el) return;
        
        var entry = STATE.shiftId ? currShift() : curr();
        if (!entry) {
          el.innerHTML = "(No entry selected)";
          return;
        }

        var out = "<div style='color:var(--text-muted);font-weight:bold;margin-bottom:8px;border-bottom:1px solid var(--border-subtle);'>STATIC PREVIEW (Selected Entry)</div>";
        
        if (entry.personality) {
          out += `&gt;&gt; context.character.personality +=<br><span class="injected"> + ${escHtml(entry.personality)}</span><br><br>`;
        }
        if (entry.scenario) {
          out += `&gt;&gt; context.character.scenario +=<br><span class="injected"> + ${escHtml(entry.scenario)}</span><br><br>`;
        }
        if (entry.injection) {
          out += `&gt;&gt; context.injection +=<br><span class="injected"> + ${escHtml(entry.injection)}</span><br><br>`;
        }
        if (entry.remove_personality) {
          out += `&gt;&gt; context.character.personality -=<br><span class="removed"> - ${escHtml(entry.remove_personality)}</span><br><br>`;
        }
        if (entry.remove_scenario) {
          out += `&gt;&gt; context.character.scenario -=<br><span class="removed"> - ${escHtml(entry.remove_scenario)}</span><br><br>`;
        }
        if (entry.example_dialogs) {
          out += `&gt;&gt; context.character.example_dialogs +=<br><span class="injected"> + ${escHtml(entry.example_dialogs)}</span><br><br>`;
        }
        
        var gates = [];
        var addGate = function(lbl, arr) { if(arr && arr.length) gates.push(lbl + ": " + arr.join(", ")); };
        addGate("Req Emotion", entry.andAnyEmotion);
        addGate("Block Emotion", entry.notAnyEmotion);
        addGate("Req Eros", entry.andAnyEros);
        addGate("Block Eros", entry.notAnyEros);
        addGate("Req Intent", entry.andAnyIntent);
        addGate("Block Intent", entry.notAnyIntent);
        
        if (gates.length > 0) {
           out += `&gt;&gt; Gates (Inference): <span style="color:var(--warning)">${escHtml(gates.join(" | "))}</span><br><br>`;
        }

        if (entry.triggers && entry.triggers.length) {
           out += `&gt;&gt; context.effects.add_tags = <span class="injected">${JSON.stringify(entry.triggers)}</span><br><br>`;
        }

        if (out === "<div style='color:var(--text-muted);font-weight:bold;margin-bottom:8px;border-bottom:1px solid var(--border-subtle);'>STATIC PREVIEW (Selected Entry)</div>") out += "(No active context injections defined in this entry)";
        el.innerHTML = out;
      };

      window.syncFromLab = function(type, val) {
        if (type === 'personality') {
            window.updateGlobal('personality', val);
        } else if (type === 'scenario') {
            window.updateGlobal('scenario', val);
        }
      };

      window.updateGlobal = function(type, val) {
        var elId = type + 'Textarea';
        var storeKey = 'aura_global_' + (type === 'initialMessage' ? 'initial_message' : type);
        var el = document.getElementById(elId);
        if(el) {
            el.value = val;
            localStorage.setItem(storeKey, val);
            window.updateStats(elId, type + 'Stats');
        }
      };

      // --------------------------------------------------------------------------
      // Chat Simulation
      // --------------------------------------------------------------------------
      var chatHistory = [];

      window.clearChat = function() {
        chatHistory = [];
        var c1 = document.getElementById('labChatContainer');
        var c2 = document.getElementById('chatContainer');

        var quill = window.quillInstances && window.quillInstances['initialMessageTextarea'];
        var initMsg = quill ? quill.getText().trim() : "";
        var html = '<div class="chat-msg system">Simulation started.</div>';
        if (initMsg) {
            chatHistory.push({ role: 'model', content: initMsg });
            html += '<div class="chat-msg ai">' + escHtml(initMsg) + '</div>';
        }

        if(c1) c1.innerHTML = html;
        if(c2) c2.innerHTML = html;
      };

      window.copyChatLog = function() {
        var text = chatHistory.map(function(m) { return (m.role === 'user' ? 'User: ' : 'AI: ') + m.content; }).join('\n\n');
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(function() { window.showToast("Chat log copied!", "success"); });
        } else {
            var ta = document.createElement("textarea");
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            document.body.removeChild(ta);
            window.showToast("Chat log copied!", "success");
        }
      };

      window.sendChat = async function() {
        var apiKey = document.getElementById('apiKey').value.trim();
        if (!apiKey) { window.showToast("API Key required.", "error"); return; }

        var input = document.getElementById('labChatInput');
        var btn = document.getElementById('labBtnSendChat');
        var container = document.getElementById('labChatContainer');

        // Fallback to sidebar if lab is hidden/inactive
        if (!input || input.offsetParent === null) {
             input = document.getElementById('chatInput');
             btn = document.getElementById('btnSendChat');
             container = document.getElementById('chatContainer');
        }

        var msg = input.value.trim();

        // If empty and history is empty, treat as "Start Simulation" (auto-generate first message)
        if (!msg && chatHistory.length > 0) return;
        
        btn.disabled = true; 
        btn.innerText = "...";

        if (msg) {
          chatHistory.push({ role: 'user', content: msg });
          container.innerHTML += '<div class="chat-msg user">' + escHtml(msg) + '</div>';
          input.value = '';
        } else {
          // Initial system prompt trigger
          container.innerHTML += '<div class="chat-msg system">Generating initial response...</div>';
        }
        container.scrollTop = container.scrollHeight;

        var globalPers = window.getQuillText('labPersonality');
        var globalScen = window.getQuillText('labScenario');

        // 0. Run Active Scripts (PULSE, etc.)
        var scriptInjections = [];
        var mockContext = {
            chat: {
                last_messages: chatHistory.map(function(m) { return { message: m.content, is_user: m.role === 'user', name: m.role === 'user' ? 'User' : 'Char' }; }),
                lastMessage: msg,
                last_message: msg
            },
            character: {
                personality: globalPers,
                scenario: globalScen,
                example_dialogs: ""
            }
        };

        // Execute active scripts
        // WARNING: Script execution uses dynamic code evaluation
        // Only load scripts from trusted sources
        if (STATE.activeScripts && STATE.activeScripts.length > 0) {
            STATE.activeScripts.forEach(function(s) {
                try {
                    var initialScen = mockContext.character.scenario;
                    // Execute script in a sandboxed context
                    // eslint-disable-next-line no-new-func
                    var scriptFunc = new Function('context', s.content);
                    scriptFunc(mockContext);

                    // Track changes made by the script
                    if (mockContext.character.scenario !== initialScen) {
                        var diff = mockContext.character.scenario.substring(initialScen.length);
                        scriptInjections.push({ name: s.name, diff: diff });
                    }
                } catch (e) {
                    console.error("Error running script '" + s.name + "':", e);
                    scriptInjections.push({ name: s.name, error: e.message });
                }
            });
        }

        // Calculate triggers from all entries (Recursive)
        var triggeredEntries = []; // Array of { entry: e, reason: string }
        var activeTags = new Set();
        var processedIds = new Set();
        var lowerMsg = msg ? msg.toLowerCase() : "";
            
        // Extract tags from script injections to influence triggers
        scriptInjections.forEach(function(inj) {
            if (inj.diff) {
                var tags = inj.diff.match(/\[(.*?)\]/g);
                if (tags) {
                    tags.forEach(function(t) { activeTags.add(t.replace(/[\[\]]/g, '').toUpperCase()); });
                }
            }
        });

        // Multi-pass loop to handle tag propagation (e.g. Entry A adds tag -> Entry B requires tag)
        for (var pass = 0; pass < 3; pass++) {
            var newTriggers = 0;

            var checkEntry = function(e) {
                if (processedIds.has(e.id)) return;

                var match = false;
                var reasons = [];

                // 1. Keyword match
                if (e.keywords && e.keywords.length) {
                    for (var k of e.keywords) {
                        if (k === '*' || lowerMsg.includes(k.toLowerCase())) {
                            match = true;
                            reasons.push("Keyword: " + k);
                            break;
                        }
                    }
                }

                // 2. Inference Gates (Simple simulation)
                if (e.andAnyEmotion && e.andAnyEmotion.length) {
                    for (var emo of e.andAnyEmotion) {
                        if (lowerMsg.includes(emo.toLowerCase())) { match = true; reasons.push("Emotion: " + emo); break; }
                    }
                }
                if (e.andAnyEros && e.andAnyEros.length) {
                    for (var eros of e.andAnyEros) {
                        if (lowerMsg.includes(eros.toLowerCase())) { match = true; reasons.push("Eros: " + eros); break; }
                    }
                }
                if (e.andAnyIntent && e.andAnyIntent.length) {
                    for (var intent of e.andAnyIntent) {
                        if (lowerMsg.includes(intent.toLowerCase())) { match = true; reasons.push("Intent: " + intent); break; }
                    }
                }

                // 3. Tag Requirements (Check against activeTags)
                if (activeTags.size > 0) {
                    var reqAny = (e.andAny || []).concat(e.requireTags || []);
                    if (reqAny.length > 0) {
                        for (var t of reqAny) {
                            if (activeTags.has(t)) { match = true; reasons.push("Tag: " + t); break; }
                        }
                    }
                    if (e.andAll && e.andAll.length > 0) {
                        var allMatch = true;
                        for (var t of e.andAll) {
                            if (!activeTags.has(t)) { allMatch = false; break; }
                        }
                        if (allMatch) { match = true; reasons.push("All Tags: " + e.andAll.join(', ')); }
                    }
                }

                if (match) {
                    // Blocking logic
                    var blocked = false;
                    var blockList = (e.block || []).concat(e.notAny || []).concat(e.notAnyEmotion || []).concat(e.notAnyEros || []).concat(e.notAnyIntent || []);
                    for (var b of blockList) {
                        if (lowerMsg.includes(b.toLowerCase()) || activeTags.has(b)) { blocked = true; break; }
                    }

                    if (!blocked) {
                        triggeredEntries.push({ entry: e, reason: reasons.join(", ") });
                        processedIds.add(e.id);
                        newTriggers++;
                        if (e.triggers) e.triggers.forEach(function(t) { activeTags.add(t); });
                        if (e.shifts) e.shifts.forEach(checkEntry);
                    }
                }
            };

            STATE.data.dynamiclore.forEach(checkEntry);
            if (newTriggers === 0) break;
        } // end pass loop

        // Render Simulation Debug
        var debugHtml = "<div style='color:var(--accent);font-weight:bold;margin-bottom:8px;border-bottom:1px solid var(--border-subtle);'>RUNTIME LOG</div>";
        
        if (scriptInjections.length > 0) {
            debugHtml += '<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--border-subtle);">';
            debugHtml += '<span style="color:var(--text-muted)">Script Execution:</span><br>';
            scriptInjections.forEach(function(inj) {
                if (inj.error) debugHtml += '<div style="color:var(--danger)">' + escHtml(inj.name) + ': ' + escHtml(inj.error) + '</div>';
                else debugHtml += '<div>' + escHtml(inj.name) + ': <span class="injected">' + escHtml(inj.diff) + '</span></div>';
            });
            debugHtml += '</div>';
        }

        if (activeTags.size > 0) {
             debugHtml += '<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--border-subtle);">';
             debugHtml += '<span style="color:var(--text-muted)">Active Tags:</span><br>';
             debugHtml += '<div class="tag-cloud">';
             activeTags.forEach(function(t) {
                 debugHtml += '<span class="tag">' + escHtml(t) + '</span>';
             });
             debugHtml += '</div></div>';
        }

        if (triggeredEntries.length === 0) {
            debugHtml += '<span style="color:var(--text-soft)">(No triggers detected in last message)</span>';
        } else {
            triggeredEntries.forEach(function(item) {
                var entry = item.entry;
                debugHtml += '<div style="margin-bottom:10px;border-bottom:1px solid var(--border-subtle);padding-bottom:4px;">';
                debugHtml += '<strong>Entry: ' + escHtml(entry.id_name || entry.id || "Unnamed") + '</strong>';
                debugHtml += ' <span style="font-size:10px;color:var(--success);">(' + escHtml(item.reason) + ')</span><br>';
                
                if (entry.personality) {
                    debugHtml += '<span style="color:var(--text-muted)">context.character.personality +=</span><br>';
                    debugHtml += '<span class="injected"> + ' + escHtml(entry.personality) + '</span><br>';
                }
                if (entry.scenario) {
                    debugHtml += '<span style="color:var(--text-muted)">context.character.scenario +=</span><br>';
                    debugHtml += '<span class="injected"> + ' + escHtml(entry.scenario) + '</span><br>';
                }
                if (entry.injection) {
                    debugHtml += '<span style="color:var(--text-muted)">context.injection +=</span><br>';
                    debugHtml += '<span class="injected"> + ' + escHtml(entry.injection) + '</span><br>';
                }
                if (entry.remove_personality) {
                    debugHtml += '<span style="color:var(--text-muted)">context.character.personality -=</span><br>';
                    debugHtml += '<span class="removed"> - ' + escHtml(entry.remove_personality) + '</span><br>';
                }
                if (entry.remove_scenario) {
                    debugHtml += '<span style="color:var(--text-muted)">context.character.scenario -=</span><br>';
                    debugHtml += '<span class="removed"> - ' + escHtml(entry.remove_scenario) + '</span><br>';
                }
                
                var gates = [];
                var addGate = function(lbl, arr) { if(arr && arr.length) gates.push(lbl + ": " + arr.join(", ")); };
                addGate("Req Emotion", entry.andAnyEmotion);
                addGate("Block Emotion", entry.notAnyEmotion);
                addGate("Req Eros", entry.andAnyEros);
                addGate("Block Eros", entry.notAnyEros);
                addGate("Req Intent", entry.andAnyIntent);
                addGate("Block Intent", entry.notAnyIntent);
                
                if (gates.length > 0) {
                    debugHtml += '<span style="color:var(--warning)">Inference Gates:</span> <span style="font-size:10px;color:var(--text-soft);">' + escHtml(gates.join(" | ")) + '</span><br>';
                }

                if (entry.triggers && entry.triggers.length) {
                    debugHtml += '<span style="color:var(--text-muted)">Effects:</span> <span class="injected">Add Tags: ' + JSON.stringify(entry.triggers) + '</span><br>';
                }
                debugHtml += '</div>';
            });
        }
        
        var labDebug = document.getElementById('labScriptDebug');
        if(labDebug) labDebug.innerHTML = debugHtml;

        // Build Prompt
        var entryJson = "";
        if (triggeredEntries.length > 0) {
             var simpleEntries = triggeredEntries.map(function(item) {
                 var e = item.entry;
                 return {
                     id: e.id_name || e.id,
                     personality: e.personality,
                     scenario: e.scenario,
                     injection: e.injection,
                     remove_personality: e.remove_personality,
                     remove_scenario: e.remove_scenario
                 };
             });
             entryJson += "TRIGGERED ENTRIES (Keywords matched):\n" + JSON.stringify(simpleEntries, null, 2);
        } else {
             entryJson = "None (General Conversation)";
        }
        
        var initEl = document.getElementById('labInitialMessage');
        var initMsg = initEl ? initEl.value.trim() : "";
        var initContext = initMsg ? ("\nInitial Message: " + initMsg) : "";

        var systemPrompt = "Roleplay Simulation.\nGlobal Personality: " + globalPers + "\nGlobal Scenario: " + globalScen + initContext + "\nActive Context (Lore Entry): " + entryJson + "\nTask: Roleplay as the character. Incorporate the Active Context if relevant. Keep responses concise (under 100 words).";

        var messages = [{ role: 'user', parts: [{ text: systemPrompt }] }];
        chatHistory.forEach(function(m) { messages.push({ role: m.role === 'user' ? 'user' : 'model', parts: [{ text: m.content }] }); });
        
        // If history is empty (first run), add a prompt to start the scene
        if (chatHistory.length === 0) messages.push({ role: 'user', parts: [{ text: "Start the scene based on the context." }] });

        try {
          var model = document.getElementById('aiModel').value || "gemini-2.5-flash";
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${encodeURIComponent(apiKey)}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: messages })
          });
          const data = await response.json();
          var text = data.candidates[0].content.parts[0].text;
          
          chatHistory.push({ role: 'model', content: text });
          container.innerHTML += '<div class="chat-msg ai">' + escHtml(text) + '</div>';
          container.scrollTop = container.scrollHeight;
        } catch(e) {
          container.innerHTML += '<div class="chat-msg system" style="color:var(--danger)">Error: ' + escHtml(e.message) + '</div>';
        } finally {
          btn.disabled = false;
          btn.innerText = "Send";
        }
      };

      window.openDupModal = function() {
        var entry = STATE.shiftId ? currShift() : curr();
        if (!entry) { window.showToast("No entry selected", "error"); return; }
        (window.ModalManager&&window.ModalManager.open?window.ModalManager.open(document.getElementById('dupModal')):document.getElementById('dupModal').classList.remove('hidden'));
        document.getElementById('dupTargetType').value = 'same';
        document.getElementById('dupTargetGroup').value = entry.group || "";
      };

      window.executeDuplicateTo = function() {
        var source = STATE.shiftId ? currShift() : curr();
        if (!source) return;

        var targetType = document.getElementById('dupTargetType').value;
        if (targetType === 'same') targetType = STATE.type;
        
        var newGroup = document.getElementById('dupTargetGroup').value.trim();
        var newEntry = {};

        // Mapping Logic
        if (targetType === 'characters') {
          newEntry.id = id('char');
          newEntry.key = (source.key || source.id_name || (source.pair ? source.pair.join('_') : "") || "new_char").toLowerCase();
          newEntry.gender = source.gender || "N";
          newEntry.aliases = source.aliases || (source.keywords ? source.keywords.slice() : []);
          newEntry.personality = source.personality || source.injection || "";
        } else if (targetType === 'pairs') {
          newEntry.id = id('pair');
          newEntry.pair = source.pair ? source.pair.slice() : ["", ""];
          newEntry.requireTags = source.requireTags || source.keywords || [];
          newEntry.injection = source.injection || source.personality || source.scenario || "";
          newEntry.group = newGroup || source.group || "";
        } else {
          // Dynamic Lore
          newEntry.id = id('lore');
          newEntry.id_name = source.id_name || source.key || "new_lore";
          newEntry.priority = source.priority || 10;
          newEntry.group = newGroup || source.group || "";
          newEntry.keywords = source.keywords ? source.keywords.slice() : (source.key ? [source.key] : []);
          newEntry.tag = source.tag || "";
          newEntry.triggers = source.triggers ? source.triggers.slice() : [];
          newEntry.personality = source.personality || "";
          newEntry.scenario = source.scenario || source.injection || "";
          // Copy gates if they exist
          if(source.andAnyEmotion) newEntry.andAnyEmotion = source.andAnyEmotion.slice();
          if(source.andAnyEros) newEntry.andAnyEros = source.andAnyEros.slice();
          if(source.andAnyIntent) newEntry.andAnyIntent = source.andAnyIntent.slice();
          newEntry.shifts = [];
        }

        STATE.data[targetType].push(newEntry);
        (window._closeModalById?window._closeModalById('dupModal'):document.getElementById('dupModal').classList.add('hidden'));
        window.showToast("Duplicated to " + targetType, "success");
        
        // If we stayed in same view, refresh. If moved, maybe switch? Let's just refresh current view.
        if (targetType === STATE.type) renderList(true);
      };

      window.deleteEntry = function () {
        if (!STATE.entryId && (!STATE.selectedIds || STATE.selectedIds.length === 0)) {
          window.showToast("No entry selected", "error");
          return;
        }

        // Check if user has disabled confirmation
        var skipConfirm = localStorage.getItem('aura_skip_delete_confirm') === 'true';

        // Determine what to delete
        var idsToDelete = STATE.selectedIds && STATE.selectedIds.length > 0 ? STATE.selectedIds.slice() : [STATE.entryId];

        if (skipConfirm) {
          // Delete immediately without confirmation
          window._performDelete(idsToDelete);
        } else {
          // Show confirmation modal
          window._showDeleteModal(idsToDelete);
        }
      };

      window._showDeleteModal = function(idsToDelete) {
        var modal = document.getElementById('deleteConfirmModal');
        var msgEl = document.getElementById('deleteConfirmMessage');
        var checkbox = document.getElementById('deleteConfirmDontAsk');

        // Build message
        var message = '';
        if (idsToDelete.length === 1) {
          var entry = findEntry(idsToDelete[0], STATE.data[STATE.type]);
          var entryName = "this entry";
          if (entry) {
            if (STATE.type === 'characters') {
              entryName = entry.key || "Unnamed character";
            } else if (STATE.type === 'pairs') {
              entryName = (entry.pair && entry.pair.length) ? (entry.pair[0] + " & " + entry.pair[1]) : "Unnamed pair";
            } else {
              entryName = entry.id_name || "Unnamed lore entry";
            }
          }
          message = 'Delete "<b>' + entryName + '</b>"?<br><br>This cannot be undone.';
        } else {
          message = 'Delete <b>' + idsToDelete.length + ' entries</b>?<br><br>This cannot be undone.';
        }

        msgEl.innerHTML = message;
        checkbox.checked = false;

        // Store IDs for confirmation
        window._pendingDeleteIds = idsToDelete;

        modal.classList.remove('hidden');
      };

      window.confirmDelete = function() {
        var checkbox = document.getElementById('deleteConfirmDontAsk');

        // Save preference if checked
        if (checkbox.checked) {
          localStorage.setItem('aura_skip_delete_confirm', 'true');
        }

        // Close modal
        window._closeModalById('deleteConfirmModal');

        // Perform delete
        if (window._pendingDeleteIds) {
          window._performDelete(window._pendingDeleteIds);
          window._pendingDeleteIds = null;
        }
      };

      window._performDelete = function(idsToDelete) {
        var findAndDelete = function (entries, id) {
          for (var i = 0; i < entries.length; i++) {
            if (entries[i].id === id) {
              entries.splice(i, 1);
              return true;
            }
            if (entries[i].shifts) {
              if (findAndDelete(entries[i].shifts, id)) {
                return true;
              }
            }
          }
          return false;
        };

        var deletedCount = 0;
        for (var i = 0; i < idsToDelete.length; i++) {
          if (findAndDelete(STATE.data[STATE.type], idsToDelete[i])) {
            deletedCount++;
          }
        }

        if (deletedCount > 0) {
          STATE.entryId = null;
          STATE.shiftId = null;
          STATE.selectedIds = [];
          STATE.lastSelectedId = null;
          renderList();
          renderEditor();
          renderCode();
          autoSave(); // Auto-save after deletion
          window.maybeRefreshGraph();
          window.showToast(deletedCount + " entr" + (deletedCount === 1 ? "y" : "ies") + " deleted", "success");
        }
      };

      window.addShift = function () {
        if (STATE.type !== "dynamiclore") return;

        var parent = curr();
        if (!parent) {
          alert("Please select a lore entry or shift first");
          return;
        }

        if (STATE.shiftId) {
          var findParentShift = function (entries, shiftId) {
            for (const entry of entries) {
              if (entry.id === shiftId) {
                return entry;
              }
              if (entry.shifts) {
                const found = findParentShift(entry.shifts, shiftId);
                if (found) {
                  return found;
                }
              }
            }
            return null;
          };
          parent = findParentShift(STATE.data.dynamiclore, STATE.shiftId);
        }


        if (!parent.shifts) parent.shifts = [];

        var shift = {
          id: id("shift"),
          id_name: "",
          priority: null,
          group: "",
          keywords: [],
          tag: "",
          triggers: [],
          probability: "",
          block: [],
          andAny: [],
          andAll: [],
          notAll: [],
          andNone: [],
          andAnyEmotion: [],
          andAllEmotion: [],
          notAnyEmotion: [],
          notAllEmotion: [],
          andAnyLongTermEmotion: [],
          andAllLongTermEmotion: [],
          notAnyLongTermEmotion: [],
          notAllLongTermEmotion: [],
          andAnyEros: [],
          andAllEros: [],
          notAnyEros: [],
          notAllEros: [],
          andAnyLongTermEros: [],
          andAllLongTermEros: [],
          notAnyLongTermEros: [],
          notAllLongTermEros: [],
          andAnyIntent: [],
          andAllIntent: [],
          notAnyIntent: [],
          notAllIntent: [],
          personality: "",
          scenario: "",
          remove_personality: "",
          remove_scenario: "",
          characters: [],
          shifts: []
        };

        parent.shifts.push(shift);
        STATE.shiftId = shift.id;
        renderList(true);
        renderEditor();
        renderCode();
        window.maybeRefreshGraph();
      };

      // --------------------------------------------------------------------------
      // Import / Export
      // --------------------------------------------------------------------------
      var importedFileName = "aura_v15_export.js";

      window.exportData = function () {
        var txt = genExport();
        var fileTypes = [{ description: 'JavaScript Files', accept: { 'application/javascript': ['.js'] } }];
        saveTextToFile(txt, importedFileName, fileTypes);
        // Mark as not-dirty after a successful export attempt (safety net)
        clearDirty();
      };

      window.importData = function () {
        window.openScriptLoader();
      };

      window.handleFileImport = function (e) {
        var file = e.target.files[0];
        if (!file) return;
        importedFileName = file.name;
        var reader = new FileReader();
        reader.onload = function (ev) {
          try {
            parseImport(ev.target.result);
            STATE.templateText = ev.target.result;
            window.showToast("Import successful!", "success");
            renderList();
            renderEditor();
            renderCode();
            autoSave();
          } catch (err) {
            window.showToast("Import error: " + err.message, "error");
            console.error("Import error:", err);
          }
        };
        reader.readAsText(file);
      };

      window.handlePersonalityImport = function (e) {
        var file = e.target.files[0];
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function (ev) {
          var val = ev.target.result;
          window.setQuillText('personalityTextarea', val);
          localStorage.setItem('aura_global_personality', val);
          window.updateStats('personalityTextarea', 'personalityStats');
          window.setQuillText('labPersonality', val);
          window.setQuillText('ctxPersonality', val);
        };
        reader.readAsText(file);
      };

      window.handleScenarioImport = function (e) {
        var file = e.target.files[0];
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function (ev) {
          var val = ev.target.result;
          window.setQuillText('scenarioTextarea', val);
          localStorage.setItem('aura_global_scenario', val);
          window.updateStats('scenarioTextarea', 'scenarioStats');
          window.setQuillText('labScenario', val);
          window.setQuillText('ctxScenario', val);
        };
        reader.readAsText(file);
      };

      window.handleInitialMessageImport = function (e) {
        var file = e.target.files[0];
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function (ev) {
          var val = ev.target.result;
          window.setQuillText('initialMessageTextarea', val);
          localStorage.setItem('aura_global_initial_message', val);
          window.setQuillText('ctxInitialMessage', val);
          window.updateStats('initialMessageTextarea', 'initialMessageStats');
          window.clearChat(); // Reset chat with new initial message
        };
        reader.readAsText(file);
      };

      // Script Loader Logic
      var scriptLoaderState = { scripts: [] };

      window.openScriptLoader = function() {
        (window.ModalManager&&window.ModalManager.open?window.ModalManager.open(document.getElementById('scriptLoaderModal')):document.getElementById('scriptLoaderModal').classList.remove('hidden'));
        window.renderScriptList();
      };

      window.handleScriptLoaderFiles = function(e) {
        var files = Array.from(e.target.files);
        if (!files.length) return;
        
        var promises = files.map(function(file) {
          return new Promise(function(resolve) {
            var reader = new FileReader();
            reader.onload = function(ev) {
              resolve({ name: file.name, content: ev.target.result, primary: false });
            };
            reader.readAsText(file);
          });
        });

        Promise.all(promises).then(function(results) {
          if (scriptLoaderState.scripts.length === 0 && results.length > 0) {
            results[0].primary = true;
          }
          scriptLoaderState.scripts = scriptLoaderState.scripts.concat(results);
          window.renderScriptList();
          document.getElementById('scriptLoaderInput').value = '';
        });
      };

      window.renderScriptList = function() {
        var list = document.getElementById('scriptLoaderList');
        if (scriptLoaderState.scripts.length === 0) {
          list.innerHTML = '<div class="empty-state" style="height:100px; font-size:12px;">No scripts added</div>';
          return;
        }
        
        var html = '';
        scriptLoaderState.scripts.forEach(function(s, i) {
          var isPrim = s.primary ? 'primary' : '';
          html += '<div class="script-item ' + isPrim + '">';
          html += '<div class="script-name" title="' + escHtml(s.name) + '">' + escHtml(s.name) + '</div>';
          html += '<div class="script-controls">';
          html += '<button class="pill-button small" onclick="window.setScriptPrimary(' + i + ')" title="Set as Primary" style="' + (s.primary ? 'background:var(--accent);color:white;' : '') + '">' + (s.primary ? 'Primary' : 'Set Primary') + '</button>';
          html += '<button class="pill-button small" onclick="window.moveScript(' + i + ', -1)" title="Move Up">‚Üë</button>';
          html += '<button class="pill-button small" onclick="window.moveScript(' + i + ', 1)" title="Move Down">‚Üì</button>';
          html += '<button class="pill-button small danger" onclick="window.removeScript(' + i + ')" title="Remove">√ó</button>';
          html += '</div></div>';
        });
        list.innerHTML = html;
      };

      window.setScriptPrimary = function(idx) {
        scriptLoaderState.scripts.forEach(function(s, i) { s.primary = (i === idx); });
        window.renderScriptList();
      };

      window.moveScript = function(idx, dir) {
        var arr = scriptLoaderState.scripts;
        var newIdx = idx + dir;
        if (newIdx < 0 || newIdx >= arr.length) return;
        var temp = arr[idx];
        arr[idx] = arr[newIdx];
        arr[newIdx] = temp;
        window.renderScriptList();
      };

      window.removeScript = function(idx) {
        scriptLoaderState.scripts.splice(idx, 1);
        if (scriptLoaderState.scripts.length > 0 && !scriptLoaderState.scripts.some(s => s.primary)) {
          scriptLoaderState.scripts[0].primary = true;
        }
        window.renderScriptList();
      };

      window.clearScriptLoader = function() {
        scriptLoaderState.scripts = [];
        window.renderScriptList();
      };

      window.processLoadedScripts = function(mode) {
        if (scriptLoaderState.scripts.length === 0) return;

        var isAppend = mode === 'append';
        if (!isAppend) {
          STATE.data.characters = [];
          STATE.data.pairs = [];
          STATE.data.dynamiclore = [];
          STATE.entryId = null;
          STATE.shiftId = null;
          STATE.templateText = null;
          STATE.activeScripts = [];
        }

        for (var i = 0; i < scriptLoaderState.scripts.length; i++) {
          var s = scriptLoaderState.scripts[i];
          try {
            // Only append after the first script in non-append mode, or always append in append mode
            var shouldAppend = isAppend || i > 0;
            parseImport(s.content, shouldAppend);
            if (s.primary) {
              importedFileName = s.name;
              STATE.templateText = s.content;
            }
            STATE.activeScripts.push({ name: s.name, content: s.content });
          } catch(e) {
            console.error("Error loading script " + s.name, e);
            window.showToast("Error loading " + s.name + ": " + e.message, "error");
          }
        }
        
        if (!STATE.templateText && scriptLoaderState.scripts.length > 0 && !isAppend) {
           importedFileName = scriptLoaderState.scripts[0].name;
           STATE.templateText = scriptLoaderState.scripts[0].content;
        }

        window.showToast(isAppend ? "Scripts merged!" : "Scripts loaded!", "success");
        (window._closeModalById?window._closeModalById('scriptLoaderModal'):document.getElementById('scriptLoaderModal').classList.add('hidden'));
        renderList();
        renderEditor();
        renderCode();
        autoSave();
      };

      window.copyCode = function () {
        var ta = document.getElementById("fullExportCode");
        if (!ta) return;
        var text = String(ta.value || '');

        // Modern API (secure contexts), with fallback
        if (navigator && navigator.clipboard && navigator.clipboard.writeText) {
          try {
            navigator.clipboard.writeText(text).then(function () {
              window.showToast("Copied to clipboard!", "success");
            }, function () {
              // fallback
              try {
                ta.focus();
                ta.select();
                document.execCommand("copy");
                window.showToast("Copied to clipboard!", "success");
              } catch (_e1) {
                window.showToast("Copy failed. Select the text and copy manually.", "error");
              }
            });
            return;
          } catch (_e0) {}
        }

        // Fallback
        try {
          ta.focus();
          ta.select();
          document.execCommand("copy");
          window.showToast("Copied to clipboard!", "success");
        } catch (_e2) {
          window.showToast("Copy failed. Select the text and copy manually.", "error");
        }
      };

      window.syncFromJson = function () {
        try {
          var json = JSON.parse(document.getElementById("entryJsonCode").value);
          if (!STATE.entryId) return;
          save(json);
          renderEditor();
          window.showToast("Synced from JSON!", "success");
        } catch (e) {
          window.showToast("Invalid JSON: " + e.message, "error");
        }
      };

      function genExport() {
        // If the user imported a full AURA script, patch into that script so Export stays fully working.
        if (STATE.templateText && typeof STATE.templateText === "string" && STATE.templateText.length > 0) {
          return patchFullFile(STATE.templateText);
        }
        return genBlocksExport();
      }

      function genBlocksExport() {
        var out = [];

        // ENTITY_DB
        out.push("// ENTITY_DB");
        out.push("const ENTITY_DB = {");
        for (var i = 0; i < STATE.data.characters.length; i++) {
          var c = STATE.data.characters[i];
          if (!c.key) continue;
          var meta = {
            gender: c.gender || "N",
            aliases: (c.aliases && c.aliases.length) ? c.aliases.slice() : []
          };
          if (c.personality && String(c.personality).trim()) {
            meta.lore = [{
              group: (c.key + "_base"),
              keywords: ["char." + c.key],
              personality: c.personality
            }];
          } else {
            meta.lore = [{
              group: (c.key + "_base"),
              keywords: ["char." + c.key],
              personality: ""
            }];
          }
          out.push('  "' + c.key + '": ' + JSON.stringify(meta, null, 2).split("\n").join("\n  ") + (i < STATE.data.characters.length - 1 ? "," : ""));
        }
        out.push("};");
        out.push("");

        // RELATIONSHIP_DB
        out.push("// RELATIONSHIP_DB");
        out.push("const RELATIONSHIP_DB = [");
        for (var j = 0; j < STATE.data.pairs.length; j++) {
          var p = STATE.data.pairs[j];
          var cleanP = {
            pair: p.pair || ["", ""],
            requireTags: p.requireTags || [],
            injection: p.injection || "",
            group: p.group || ""
          };
          out.push("  " + JSON.stringify(cleanP, null, 2).split("\n").join("\n  ") + (j < STATE.data.pairs.length - 1 ? "," : ""));
        }
        out.push("];");
        out.push("");

        // DYNAMIC_LORE
        out.push("// DYNAMIC_LORE");
        out.push("const DYNAMIC_LORE = [");
        for (var k = 0; k < STATE.data.dynamiclore.length; k++) {
          var l = STATE.data.dynamiclore[k];
          var cleanL = stripLoreForExport(l, true);
          out.push("  " + JSON.stringify(cleanL, null, 2).split("\n").join("\n  ") + (k < STATE.data.dynamiclore.length - 1 ? "," : ""));
        }
        out.push("];");

        return out.join("\n");
      }

      function stripAddEntryCalls(src) {
        var txt = src;
        var ranges = [];
        
        // Helper to find next occurrence outside strings/comments
        var findNext = function(startIdx) {
            var inString = false;
            var strChar = null;
            var inComment = false;
            var inMulti = false;
            
            for (var i = startIdx; i < txt.length; i++) {
                var c = txt[i];
                
                if (inComment) { if (c === '\n') inComment = false; continue; }
                if (inMulti) { if (c === '*' && txt[i+1] === '/') { inMulti = false; i++; } continue; }
                if (inString) {
                    if (c === strChar) {
                        var esc = false;
                        var k = i - 1;
                        while (k >= 0 && txt[k] === '\\') { esc = !esc; k--; }
                        if (!esc) inString = false;
                    }
                    continue;
                }
                
                if (c === '/' && txt[i+1] === '/') { inComment = true; i++; continue; }
                if (c === '/' && txt[i+1] === '*') { inMulti = true; i++; continue; }
                
                if (c === '"' || c === "'" || c === '`') { inString = true; strChar = c; continue; }
                
                if (txt.substr(i, 9) === "addEntry(") {
                    return i;
                }
            }
            return -1;
        };

        var searchIdx = 0;
        while (true) {
          var start = findNext(searchIdx);
          if (start === -1) break;

          var openParen = start + 8;
          var end = findMatchingBracket(txt, openParen, '(', ')');

          if (end !== -1) {
            var removeEnd = end + 1;
            while (removeEnd < txt.length && /\s/.test(txt.charAt(removeEnd))) removeEnd++;
            if (txt.charAt(removeEnd) === ';') removeEnd++;
            
            ranges.push({start: start, end: removeEnd});
            searchIdx = removeEnd;
          } else {
            searchIdx = start + 1;
          }
        }
        
        for (var i = ranges.length - 1; i >= 0; i--) {
          var r = ranges[i];
          txt = txt.slice(0, r.start) + txt.slice(r.end);
        }
        
        return txt;
      }

      function patchFullFile(src) {
        // Replace the three exported blocks inside the imported script.
        // We do bracket matching instead of brittle regex.
        var patched = src;

        // Strip addEntry calls to prevent duplication/zombie entries
        patched = stripAddEntryCalls(patched);

        patched = replaceConstBlock(patched, "ENTITY_DB", "{", "}", genEntityDbBlock());
        patched = replaceConstBlock(patched, "RELATIONSHIP_DB", "[", "]", genRelationshipDbBlock());
        patched = replaceConstBlock(patched, "DYNAMIC_LORE", "[", "]", genDynamicLoreBlock());

        return patched;
      }

      function replaceConstBlock(src, constName, openChar, closeChar, newBlockText) {
        var needle = "const " + constName + " = ";
        var idx = src.indexOf(needle);
        if (idx < 0) return src;

        // Find start of the opening bracket after '='
        var start = src.indexOf(openChar, idx);
        if (start < 0) return src;

        var end = findMatchingBracket(src, start, openChar, closeChar);
        if (end < 0) return src;

        // Include trailing semicolon if present.
        var after = end + 1;
        while (after < src.length && /\s/.test(src.charAt(after))) after++;
        if (src.charAt(after) === ";") after++;

        return src.slice(0, idx) + newBlockText + src.slice(after);
      }

      function genEntityDbBlock() {
        var out = [];
        out.push("const ENTITY_DB = {");
        // Keep stable order: as listed
        for (var i = 0; i < STATE.data.characters.length; i++) {
          var c = STATE.data.characters[i];
          if (!c.key) continue;
          var meta = {
            gender: c.gender || "N",
            aliases: (c.aliases && c.aliases.length) ? c.aliases.slice() : []
          };
          meta.lore = [{
            group: (c.key + "_base"),
            keywords: ["char." + c.key],
            personality: (c.personality || "")
          }];
          out.push('  "' + c.key + '": ' + JSON.stringify(meta, null, 2).split("\n").join("\n  ") + (i < STATE.data.characters.length - 1 ? "," : ""));
        }
        out.push("};");
        return out.join("\n");
      }

      function genRelationshipDbBlock() {
        var out = [];
        out.push("const RELATIONSHIP_DB = [");
        for (var j = 0; j < STATE.data.pairs.length; j++) {
          var p = STATE.data.pairs[j];
          var cleanP = {
            pair: p.pair || ["", ""],
            requireTags: p.requireTags || [],
            injection: p.injection || "",
            group: p.group || ""
          };
          out.push("  " + JSON.stringify(cleanP, null, 2).split("\n").join("\n  ") + (j < STATE.data.pairs.length - 1 ? "," : ""));
        }
        out.push("];");
        return out.join("\n");
      }

      function genDynamicLoreBlock() {
        var out = [];
        out.push("const DYNAMIC_LORE = [");
        for (var k = 0; k < STATE.data.dynamiclore.length; k++) {
          var l = STATE.data.dynamiclore[k];
          var cleanL = stripLoreForExport(l, true);
          out.push("  " + JSON.stringify(cleanL, null, 2).split("\n").join("\n  ") + (k < STATE.data.dynamiclore.length - 1 ? "," : ""));
        }
        out.push("];");
        return out.join("\n");
      }

      function stripLoreForExport(l, includeShifts) {
        var o = {};
        // id/name helpers
        if (l.id_name && String(l.id_name).trim()) o.id = l.id_name;

        if (l.group && String(l.group).trim()) o.group = l.group;
        if (l.priority != null && l.priority !== 0) o.priority = l.priority;

        if (l.keywords && l.keywords.length) o.keywords = l.keywords.slice();
        if (l.tag && String(l.tag).trim()) o.tag = l.tag;
        if (l.triggers && l.triggers.length) o.triggers = l.triggers.slice();
        if (l.probability && String(l.probability).trim()) o.probability = l.probability;
        if (l.block && l.block.length) o.block = l.block.slice();

        // Tag gates (AURA+v15): andAll / notAny / notAll
        if (l.andAll && l.andAll.length) o.andAll = l.andAll.slice();
        // notAny is intentionally synonymous with block in this manager
        if (l.block && l.block.length) o.notAny = l.block.slice();
        if (l.notAll && l.notAll.length) o.notAll = l.notAll.slice();

        // v15 emotion gates (export as these names)
        if (l.andAnyEmotion && l.andAnyEmotion.length) o.andAnyEmotion = l.andAnyEmotion.slice();
        if (l.andAllEmotion && l.andAllEmotion.length) o.andAllEmotion = l.andAllEmotion.slice();
        if (l.notAnyEmotion && l.notAnyEmotion.length) o.notAnyEmotion = l.notAnyEmotion.slice();
        if (l.notAllEmotion && l.notAllEmotion.length) o.notAllEmotion = l.notAllEmotion.slice();

        if (l.andAnyLongTermEmotion && l.andAnyLongTermEmotion.length) o.andAnyLongTermEmotion = l.andAnyLongTermEmotion.slice();
        if (l.andAllLongTermEmotion && l.andAllLongTermEmotion.length) o.andAllLongTermEmotion = l.andAllLongTermEmotion.slice();
        if (l.notAnyLongTermEmotion && l.notAnyLongTermEmotion.length) o.notAnyLongTermEmotion = l.notAnyLongTermEmotion.slice();
        if (l.notAllLongTermEmotion && l.notAllLongTermEmotion.length) o.notAllLongTermEmotion = l.notAllLongTermEmotion.slice();

        // v15 eros gates (export as these names)
        if (l.andAnyEros && l.andAnyEros.length) o.andAnyEros = l.andAnyEros.slice();
        if (l.andAllEros && l.andAllEros.length) o.andAllEros = l.andAllEros.slice();
        if (l.notAnyEros && l.notAnyEros.length) o.notAnyEros = l.notAnyEros.slice();
        if (l.notAllEros && l.notAllEros.length) o.notAllEros = l.notAllEros.slice();

        if (l.andAnyLongTermEros && l.andAnyLongTermEros.length) o.andAnyLongTermEros = l.andAnyLongTermEros.slice();
        if (l.andAllLongTermEros && l.andAllLongTermEros.length) o.andAllLongTermEros = l.andAllLongTermEros.slice();
        if (l.notAnyLongTermEros && l.notAnyLongTermEros.length) o.notAnyLongTermEros = l.notAnyLongTermEros.slice();
        if (l.notAllLongTermEros && l.notAllLongTermEros.length) o.notAllLongTermEros = l.notAllLongTermEros.slice();

        // v15 intent gates (export as these names)
        if (l.andAnyIntent && l.andAnyIntent.length) o.andAnyIntent = l.andAnyIntent.slice();
        if (l.andAllIntent && l.andAllIntent.length) o.andAllIntent = l.andAllIntent.slice();
        if (l.notAnyIntent && l.notAnyIntent.length) o.notAnyIntent = l.notAnyIntent.slice();
        if (l.notAllIntent && l.notAllIntent.length) o.notAllIntent = l.notAllIntent.slice();

        if (l.characters && l.characters.length) o.characters = l.characters.slice();

        if (l.personality && String(l.personality).length) o.personality = l.personality;
        if (l.scenario && String(l.scenario).length) o.scenario = l.scenario;
        if (l.remove_personality && String(l.remove_personality).length) o.remove_personality = l.remove_personality;
        if (l.remove_scenario && String(l.remove_scenario).length) o.remove_scenario = l.remove_scenario;

        if (includeShifts && l.shifts && l.shifts.length) {
          o.Shifts = [];
          for (var i = 0; i < l.shifts.length; i++) o.Shifts.push(stripLoreForExport(l.shifts[i], false));
        }
        return o;
      }

      function parseImport(txt, append) {
        // Safety: create a backup before overwrite imports
        if (!append) {
          try {
            if ((STATE.data.characters && STATE.data.characters.length) ||
                (STATE.data.pairs && STATE.data.pairs.length) ||
                (STATE.data.dynamiclore && STATE.data.dynamiclore.length) ||
                (STATE.templateText && String(STATE.templateText).length)) {
              window.downloadBackupJson('backup-before-import');
              window.showToast('Backup created before import.', 'info');
            }
          } catch (_e0) {}
        }
        if (!append) {
          // Reset
          STATE.data.characters = [];
          STATE.data.pairs = [];
          STATE.data.dynamiclore = [];
          STATE.entryId = null;
          STATE.shiftId = null;
        }

        // Extract Globals (personality, scenario, initialMessage)
        var extractGlobal = function(varName, elementId, storageKey) {
           var re = new RegExp("\\b" + varName + "\\s*(\\+?=)\\s*", "g");
           var match;
           while ((match = re.exec(txt)) !== null) {
              var op = match[1];
              var startQuote = match.index + match[0].length;
              var char = txt[startQuote];
              if (char === '`' || char === '"' || char === "'") {
                 var end = -1;
                 for (var k = startQuote + 1; k < txt.length; k++) {
                    if (txt[k] === char && txt[k-1] !== '\\') {
                       end = k;
                       break;
                    }
                 }
                 if (end !== -1) {
                    var val = txt.substring(startQuote + 1, end);
                    var el = document.getElementById(elementId);
                    if (el) {
                        var currentVal = window.getQuillText(elementId);
                        var newVal = (op === '+=' && currentVal) ? currentVal + val : val;
                        window.setQuillText(elementId, newVal);
                        if (storageKey) localStorage.setItem(storageKey, newVal);
                        el.dispatchEvent(new Event('input'));

                        if (varName === 'personality') {
                           window.setQuillText('labPersonality', newVal);
                           window.setQuillText('ctxPersonality', newVal);
                        } else if (varName === 'scenario') {
                           window.setQuillText('labScenario', newVal);
                           window.setQuillText('ctxScenario', newVal);
                        } else if (varName === 'initialMessage' || varName === 'initial') {
                           window.setQuillText('ctxInitialMessage', newVal);
                        }
                    }
                 }
              }
           }
        };
        extractGlobal("personality", "personalityTextarea", "aura_global_personality");
        extractGlobal("scenario", "scenarioTextarea", "aura_global_scenario");        
        extractGlobal("initialMessage", "initialMessageTextarea", "aura_global_initial_message");
        extractGlobal("initial", "initialMessageTextarea", "aura_global_initial_message");

        // ENTITY_DB
        // WARNING: Using eval() for parsing JavaScript object literals
        // Only use this with trusted files that you created yourself
        var entIdx = txt.indexOf("const ENTITY_DB = {");
        if (entIdx >= 0) {
          var entStart = txt.indexOf("{", entIdx);
          var entEnd = findMatchingBracket(txt, entStart, "{", "}");
          if (entEnd >= 0) {
            var entBlock = txt.substring(entStart, entEnd + 1);
            try {
              // eslint-disable-next-line no-eval
              var ENTITY_DB = eval("(" + entBlock + ")");

              // Validate that ENTITY_DB is an object
              if (typeof ENTITY_DB !== 'object' || ENTITY_DB === null || Array.isArray(ENTITY_DB)) {
                throw new Error("ENTITY_DB must be an object");
              }

              for (var name in ENTITY_DB) {
                if (!Object.prototype.hasOwnProperty.call(ENTITY_DB, name)) continue;
                var meta = ENTITY_DB[name] || {};
                var basePersonality = "";
                if (meta.lore && meta.lore.length && meta.lore[0] && meta.lore[0].personality != null) {
                  basePersonality = meta.lore[0].personality;
                }
                STATE.data.characters.push({
                  id: id("char"),
                  key: String(name), // Sanitize key
                  gender: meta.gender || "N",
                  aliases: toArray(meta.aliases).filter(Boolean),
                  personality: basePersonality || ""
                });
              }
            } catch (err) {
              console.error("Error parsing ENTITY_DB:", err);
              window.showToast("Error parsing ENTITY_DB: " + err.message, "error");
            }
          }
        }

        // RELATIONSHIP_DB
        // WARNING: Using eval() for parsing JavaScript array literals
        // Only use this with trusted files that you created yourself
        var relIdx = txt.indexOf("const RELATIONSHIP_DB = [");
        if (relIdx >= 0) {
          var relStart = txt.indexOf("[", relIdx);
          var relEnd = findMatchingBracket(txt, relStart, "[", "]");
          if (relEnd >= 0) {
            var relBlock = txt.substring(relStart, relEnd + 1);
            try {
              // eslint-disable-next-line no-eval
              var RELATIONSHIP_DB = eval(relBlock);

              // Validate that RELATIONSHIP_DB is an array
              if (!Array.isArray(RELATIONSHIP_DB)) {
                throw new Error("RELATIONSHIP_DB must be an array");
              }

              for (var i = 0; i < RELATIONSHIP_DB.length; i++) {
                var r = RELATIONSHIP_DB[i] || {};
                STATE.data.pairs.push({
                  id: id("pair"),
                  pair: r.pair || ["", ""],
                  requireTags: r.requireTags || r.andAll || r.andAny || [],
                  injection: r.injection || r.scenario || "",
                  group: r.group || ""
                });
              }
            } catch (err) {
              console.error("Error parsing RELATIONSHIP_DB:", err);
              window.showToast("Error parsing RELATIONSHIP_DB: " + err.message, "error");
            }
          }
        }

        // DYNAMIC_LORE
        // WARNING: Using eval() for parsing JavaScript array literals
        // Only use this with trusted files that you created yourself
        var loreIdx = txt.indexOf("const DYNAMIC_LORE = [");
        if (loreIdx >= 0) {
          var loreStart = txt.indexOf("[", loreIdx);
          var loreEnd = findMatchingBracket(txt, loreStart, "[", "]");
          if (loreEnd >= 0) {
            var loreBlock = txt.substring(loreStart, loreEnd + 1);
            try {
              // eslint-disable-next-line no-eval
              var DYNAMIC_LORE = eval(loreBlock);

              // Validate that DYNAMIC_LORE is an array
              if (!Array.isArray(DYNAMIC_LORE)) {
                throw new Error("DYNAMIC_LORE must be an array");
              }

              for (var j = 0; j < DYNAMIC_LORE.length; j++) {
                var e = DYNAMIC_LORE[j] || {};
                var entry = inflateLoreFromImport(e);
                STATE.data.dynamiclore.push(entry);
              }
            } catch (err) {
              console.error("Error parsing DYNAMIC_LORE:", err);
              window.showToast("Error parsing DYNAMIC_LORE: " + err.message, "error");
            }
          }
        }

        // addEntry parsing (robust)
        // WARNING: Using eval() for parsing JavaScript object literals
        // Only use this with trusted files that you created yourself
        var searchIdx = 0;
        while (true) {
          var start = txt.indexOf("addEntry(", searchIdx);
          if (start === -1) break;

          var openParen = start + 8;
          var end = findMatchingBracket(txt, openParen, '(', ')');

          if (end !== -1) {
            var entryCode = txt.substring(openParen + 1, end);
            try {
              // eslint-disable-next-line no-eval
              var entry = eval('(' + entryCode + ')');
              if (entry && typeof entry === 'object') {
                STATE.data.dynamiclore.push(inflateLoreFromImport(entry));
              } else {
                console.warn("Invalid entry object at position " + start);
              }
            } catch (e) {
              console.error("Could not parse addEntry at position " + start + ":", e);
              window.showToast("Error parsing addEntry: " + e.message, "error");
            }
            searchIdx = end + 1;
          } else {
            searchIdx = start + 1;
          }
        }
      }

      function inflateLoreFromImport(e) {
        var entry = {
          id: id("lore"),
          id_name: e.id || e.id_name || "",
          priority: e.priority || 0,
          group: e.group || "",
          keywords: e.keywords || [],
          tag: e.tag || "",
          triggers: e.triggers || [],
          probability: e.probability || "",
          block: (e.block || e.notAny || e.andNone || e.requireNone || e.ifNot || e.notTags || []),

          andAny: e.andAny || e.requireAny || [],
          andAll: e.andAll || e.requireAll || [],
          notAll: (e.notAll || []),
          andNone: [],

          andAnyEmotion: e.andAnyEmotion || e.requireAnyEmotion || toArray(e.requireEmotion),
          andAllEmotion: e.andAllEmotion || e.requireAllEmotion || [],
          notAnyEmotion: e.notAnyEmotion || e.blockAnyEmotion || toArray(e.blockEmotion),
          notAllEmotion: e.notAllEmotion || e.blockAllEmotion || [],

          andAnyLongTermEmotion: e.andAnyLongTermEmotion || [],
          andAllLongTermEmotion: e.andAllLongTermEmotion || [],
          notAnyLongTermEmotion: e.notAnyLongTermEmotion || [],
          notAllLongTermEmotion: e.notAllLongTermEmotion || [],

          andAnyEros: e.andAnyEros || e.requireAnyEros || toArray(e.requireEros),
          andAllEros: e.andAllEros || e.requireAllEros || [],
          notAnyEros: e.notAnyEros || e.blockAnyEros || toArray(e.blockEros),
          notAllEros: e.notAllEros || e.blockAllEros || [],

          andAnyLongTermEros: e.andAnyLongTermEros || [],
          andAllLongTermEros: e.andAllLongTermEros || [],
          notAnyLongTermEros: e.notAnyLongTermEros || [],
          notAllLongTermEros: e.notAllLongTermEros || [],

          andAnyIntent: e.andAnyIntent || e.requireAnyIntent || toArray(e.requireIntent),
          andAllIntent: e.andAllIntent || e.requireAllIntent || [],
          notAnyIntent: e.notAnyIntent || e.blockAnyIntent || toArray(e.blockIntent),
          notAllIntent: e.notAllIntent || e.blockAllIntent || [],

          personality: e.personality || "",
          scenario: e.scenario || "",
          remove_personality: e.remove_personality || "",
          remove_scenario: e.remove_scenario || "",
          characters: e.characters || [],
          shifts: []
        };

        if (e.Shifts && Array.isArray(e.Shifts)) {
          for (var i = 0; i < e.Shifts.length; i++) {
            var s = inflateLoreFromImport(e.Shifts[i] || {});
            s.id = (e.Shifts[i] && e.Shifts[i].id) ? e.Shifts[i].id : id("shift");
            entry.shifts.push(s);
          }
        }

        return entry;
      }

      // --------------------------------------------------------------------------
      // Rendering
      // --------------------------------------------------------------------------
      function renderList(scrollToActive) {
        var list = document.getElementById("entriesList");
        var arr = STATE.data[STATE.type];
        var term = document.getElementById("searchInput") ? document.getElementById("searchInput").value.toLowerCase().trim() : "";

        if (!arr || arr.length === 0) {
          list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div><div class="empty-state-text">No entries</div></div>';
          return;
        }

        var html = "";
        for (var i = 0; i < arr.length; i++) {
          var e = arr[i];
          if (term) {
             var text = "";
             if (STATE.type === "characters") text = (e.key || "") + " " + (e.aliases ? e.aliases.join(" ") : "");
             else if (STATE.type === "pairs") text = (e.pair ? e.pair.join(" ") : "") + " " + (e.group || "");
             else text = (e.id_name || "") + " " + (e.group || "") + " " + (e.keywords ? e.keywords.join(" ") : "");
             
             var shiftMatch = false;
             if (e.shifts) {
               for(var s of e.shifts) {
                 var sText = (s.id_name||"") + " " + (s.group||"") + " " + (s.keywords?s.keywords.join(" "):"");
                 if (sText.toLowerCase().includes(term)) shiftMatch = true;
               }
             }

             if (!text.toLowerCase().includes(term) && !shiftMatch) continue;
          }
          html += renderEntry(e, 0);
        }

        list.innerHTML = html;

        if (scrollToActive) {
          setTimeout(function() {
            var activeEl = list.querySelector(".entry-item.active");
            if (activeEl) activeEl.scrollIntoView({ behavior: "smooth", block: "nearest" });
          }, SCROLL_DELAY);
        }
      }

      function renderEntry(e, depth) {
        var title = "Unnamed";
        var sub = "";
        var html = "";

        if (STATE.type === "characters") {
          title = e.key || "Unnamed";
          sub = (e.gender || "?") + " ¬∑ " + ((e.aliases && e.aliases.length) ? ("Aliases: " + e.aliases.length) : "No aliases");
        } else if (STATE.type === "pairs") {
          title = (e.pair && e.pair.length) ? (e.pair[0] + " & " + e.pair[1]) : "Unnamed";
          sub = (e.requireTags ? e.requireTags.length : 0) + " tag(s)" + (e.group ? (" ¬∑ " + e.group) : "");
        } else {
          title = e.id_name || "Unnamed";
          sub = "Priority " + (e.priority || 0) + (e.group ? (" ¬∑ Group: " + e.group) : "");
        }

        var active = (e.id === STATE.entryId && (!STATE.shiftId || STATE.shiftId === e.id)) ? "active" : "";
        var selected = (STATE.selectedIds && STATE.selectedIds.indexOf(e.id) > -1 && !active) ? "selected" : "";
        var groupColor = e.group ? stringToColor(e.group) : 'transparent';
        var itemClass = depth > 0 ? "entry-item shift-item" : "entry-item";

        html += '<div class="' + itemClass + ' ' + active + ' ' + selected + '" style="margin-left:' + (depth * 20) + 'px" onclick="window.selectEntry(\'' + e.id + '\', null, event)">';
        html += '<div><span class="group-indicator" style="background-color:' + groupColor + '"></span><span class="entry-item-title">' + (depth > 0 ? 'Shift: ' : '') + escHtml(title) + "</span></div>";
        html += '<div class="entry-item-subtitle">' + escHtml(sub) + "</div>";
        html += "</div>";

        if (STATE.type === "dynamiclore" && e.shifts && e.shifts.length) {
          for (var j = 0; j < e.shifts.length; j++) {
            html += renderEntry(e.shifts[j], depth + 1);
          }
        }
        return html;
      }

      function renderEditor() {
        var ed = document.getElementById("visualEditor");
        var entry = curr();
        if (!entry) {
          ed.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üëà</div><div class="empty-state-text">Select an entry</div></div>';
          return;
        }

        if (STATE.shiftId) {
          renderShiftEditor(entry, currShift());
          window.renderContextDebug();
          return;
        }

        if (STATE.type === "characters") renderCharEditor(entry);
        else if (STATE.type === "pairs") renderPairEditor(entry);
        else renderLoreEditor(entry);
        window.renderContextDebug();
      }

      function renderCharEditor(e) {
        var ed = document.getElementById("visualEditor");
        var aliasesText = joinCsv(e.aliases || []);
        ed.innerHTML =
          '<div class="form-section">' +
          '<div class="section-title"><div style="display:flex;align-items:center;gap:10px;"><button class="pill-button small" onclick="window.openAiEditModal()">AI Edit</button> Entity (ENTITY_DB)</div></div>' +
          '<div class="form-group">' +
          '<label class="form-label">Key</label>' +
          '<input class="form-input" value="' + escHtml(e.key || "") + '" oninput="window._saveCharKey(this.value)">' +
          '<div class="form-help">Lowercase identifier. Export becomes ENTITY_DB[\"key\"].</div>' +
          '</div>' +
          '<div class="form-grid">' +
          '<div class="form-group">' +
          '<label class="form-label">Gender</label>' +
          '<div class="radio-group">' +
          radioPill("gender", "M", e.gender === "M", "Male") +
          radioPill("gender", "F", e.gender === "F", "Female") +
          radioPill("gender", "N", e.gender === "N", "Neutral") +
          '</div>' +
          '</div>' +
          '<div class="form-group">' +
          '<label class="form-label">Aliases</label>' +
          renderSmartTagInput('entry', 'aliases', 'Aliases', e.aliases, null, 'Comma-separated aliases (e.g., "aves", "avie").') +
          "</div>" +
          "</div>" +
          '<div class="form-group">' +
          '<label class="form-label" style="display:flex;justify-content:space-between;align-items:center;">Base Personality <button class="pill-button small" onclick="window.openAiModal(\'char-personality-' + e.id + '\')">AI</button></label>' +
          '<textarea id="char-personality-' + e.id + '" class="form-textarea" style="min-height:120px;" oninput="save({personality:this.value})">' + escHtml(e.personality || "") + "</textarea>" +
          "</div>" +
          "</div>";
      }

      function radioPill(name, value, checked, label) {
        return '<label class="radio-pill"><input type="radio" name="' + name + '" value="' + value + '" ' + (checked ? "checked" : "") + ' onchange="save({gender:\'' + value + '\'})"><span>' + label + "</span></label>";
      }

      window._saveCharKey = function (v) {
        v = String(v || "").trim().toLowerCase();
        save({ key: v });
      };

      function renderPairEditor(e) {
        var ed = document.getElementById("visualEditor");
        var chars = charKeys();
        var pair = e.pair || ["", ""];
        var requireTagsText = joinCsv(e.requireTags || []);

        var c1opts = '<option value="">Select</option>';
        var c2opts = '<option value="">Select</option>';
        for (var i = 0; i < chars.length; i++) {
          c1opts += '<option value="' + escHtml(chars[i]) + '" ' + (pair[0] === chars[i] ? "selected" : "") + ">" + escHtml(chars[i]) + "</option>";
          c2opts += '<option value="' + escHtml(chars[i]) + '" ' + (pair[1] === chars[i] ? "selected" : "") + ">" + escHtml(chars[i]) + "</option>";
        }

        ed.innerHTML =
          '<div class="form-section">' +
          '<div class="section-title"><div style="display:flex;align-items:center;gap:10px;"><button class="pill-button small" onclick="window.openAiEditModal()">AI Edit</button> Relationship Trigger (RELATIONSHIP_DB)</div></div>' +
          '<div class="form-group">' +
          '<label class="form-label">Pair</label>' +
          '<div class="pair-selector">' +
          '<select class="form-select" onchange="window._savePairSide(0,this.value)">' + c1opts + "</select>" +
          "<span>+</span>" +
          '<select class="form-select" onchange="window._savePairSide(1,this.value)">' + c2opts + "</select>" +
          "</div>" +
          "</div>" +
          '<div class="form-grid">' +
          '<div class="form-group">' +
          '<label class="form-label">Require Tags</label>' +
          renderSmartTagInput('entry', 'requireTags', 'Require Tags', e.requireTags, null, 'Tags that must be active (e.g., banter, teasing).') +
          "</div>" +
          '<div class="form-group">' +
          '<label class="form-label">Group</label>' +
          '<input class="form-input" value="' + escHtml(e.group || "") + '" oninput="save({group:this.value})">' +
          '<div class="form-help">Optional grouping label for debugging / organization.</div>' +
          "</div>" +
          "</div>" +
          '<div class="form-group">' +
          '<label class="form-label" style="display:flex;justify-content:space-between;align-items:center;">Injection <button class="pill-button small" onclick="window.openAiModal(\'pair-injection-' + e.id + '\')">AI</button></label>' +
          '<textarea id="pair-injection-' + e.id + '" class="form-textarea" style="min-height:140px;" oninput="save({injection:this.value})">' + escHtml(e.injection || "") + "</textarea>" +
          "</div>" +
          "</div>";
      }

      window._savePairSide = function (idx, v) {
        var e = curr();
        if (!e) return;
        var p = e.pair && e.pair.length ? e.pair.slice() : ["", ""];
        p[idx] = v;
        save({ pair: p });
      };

      function renderLoreEditor(e) {
        var ed = document.getElementById("visualEditor");
        var chars = charKeys();
        var selectedChars = e.characters || [];

        var charCheckboxes = "";
        if (chars.length) {
          for (var i = 0; i < chars.length; i++) {
            var checked = selectedChars.indexOf(chars[i]) >= 0 ? "checked" : "";
            charCheckboxes += '<label class="radio-pill"><input type="checkbox" ' + checked + ' onchange="window._toggleLoreChar(\'' + chars[i] + '\')"><span>' + escHtml(chars[i]) + "</span></label>";
          }
        } else {
          charCheckboxes = '<div class="form-help">No entities defined yet. Create entities first.</div>';
        }

        ed.innerHTML =
          '<div class="form-section">' +
          '<div class="section-title" onclick="this.parentNode.classList.toggle(\'collapsed\')"><div style="display:flex;align-items:center;gap:10px;"><button class="pill-button small" onclick="event.stopPropagation();window.openAiEditModal()">AI Edit</button> Lore Entry (DYNAMIC_LORE)</div></div>' +
          '<div class="form-grid">' +
          '<div class="form-group">' +
          '<label class="form-label">ID Name (optional)</label>' +
          '<input id="fld_idname" class="form-input" value="' + escHtml(e.id_name || "") + '" oninput="save({id_name:this.value})">' +
          "</div>" +
          '<div class="form-group">' +
          '<label class="form-label">Priority</label>' +
          '<input id="fld_priority" type="number" class="form-input" value="' + escHtml(e.priority || 0) + '" oninput="save({priority:parseInt(this.value)||0})">' +
          "</div>" +
          '<div class="form-group">' +
          '<label class="form-label">Group</label>' +
          '<input id="fld_group" class="form-input" value="' + escHtml(e.group || "") + '" oninput="save({group:this.value})">' +
          "</div>" +
          "</div>" +
          "</div>" +

          '<div class="form-section">' +
          '<div class="section-title">Keyword + Tag Controls</div>' +
          '<div class="form-grid">' +
          '<div class="form-group">' +
          renderSmartTagInput('entry', 'keywords', 'Keywords', e.keywords, 'fld_keywords', 'Phrases that trigger this entry.') +
          "</div>" +
          '<div class="form-group">' +
          '<label class="form-label">tag</label>' +
          '<input id="fld_tag" class="form-input" value="' + escHtml(e.tag || "") + '" oninput="save({tag:this.value})">' +
          '<div class="form-help">Trigger-only entry tag (optional).</div>' +
          "</div>" +
          "</div>" +
          '<div class="form-grid">' +
          '<div class="form-group">' +
          renderSmartTagInput('entry', 'triggers', 'Triggers', e.triggers, 'fld_triggers', 'Tags to emit when this entry fires.') +
          "</div>" +
          '<div class="form-group">' +
          '<label class="form-label">probability</label>' +
          '<input id="fld_probability" class="form-input" value="' + escHtml(e.probability || "") + '" oninput="save({probability:this.value})">' +
          '<div class="form-help">Example: \"40%\" (optional).</div>' +
          "</div>" +
          '<div class="form-group">' +
          renderSmartTagInput('entry', 'block', 'Block', e.block, 'fld_block', 'Blocks if ANY of these tags are present.') +
          "</div>" +
          "</div>" +
          "</div>" +


          '<div id="sec_personality" class="form-section">' +
          '<div class="section-title" onclick="this.parentNode.classList.toggle(\'collapsed\')">Personality <button id="btn_ai_pers" class="pill-button small" onclick="event.stopPropagation();window.openAiModal(\'lore-personality-' + e.id + '\')">AI</button></div>' +
          '<textarea id="lore-personality-' + e.id + '" class="form-textarea" style="min-height:120px;" oninput="save({personality:this.value})">' + escHtml(e.personality || "") + "</textarea>" +
          '<div style="margin-top:8px;"><label class="form-label" style="font-size:10px;">Remove Text (Optional)</label><textarea class="form-textarea" style="min-height:60px;font-size:11px;" oninput="save({remove_personality:this.value})">' + escHtml(e.remove_personality || "") + '</textarea></div>' +
          "</div>" +

          '<div id="sec_scenario" class="form-section">' +
          '<div class="section-title" onclick="this.parentNode.classList.toggle(\'collapsed\')">Scenario <button class="pill-button small" onclick="event.stopPropagation();window.openAiModal(\'lore-scenario-' + e.id + '\')">AI</button></div>' +
          '<textarea id="lore-scenario-' + e.id + '" class="form-textarea" style="min-height:140px;" oninput="save({scenario:this.value})">' + escHtml(e.scenario || "") + "</textarea>" +
          '<div style="margin-top:8px;"><label class="form-label" style="font-size:10px;">Remove Text (Optional)</label><textarea class="form-textarea" style="min-height:60px;font-size:11px;" oninput="save({remove_scenario:this.value})">' + escHtml(e.remove_scenario || "") + '</textarea></div>' +
          "</div>" +

          '<div id="sec_tag_gates" class="form-section">' +
          '<div class="section-title" onclick="this.parentNode.classList.toggle(\'collapsed\')">Tag Gates</div>' +
          gateTextarea("andAll", "andAll (require ALL tags)", e.andAll) +
          gateTextarea("notAll", "notAll (block if ALL tags present)", e.notAll) +
          '<div class="form-help">Note: <strong>block</strong> above acts as notAny (block if ANY present).</div>' +
          "</div>" +

          '<div id="sec_emotion" class="form-section">' +
          '<div class="section-title" onclick="this.parentNode.classList.toggle(\'collapsed\')">Emotion Gates</div>' +
          '<div class="form-grid" style="align-items:start">' +
          '<div>' +
          '<div style="font-size:11px;font-weight:700;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;">Current Mood</div>' +
          emotionGatePicker("andAnyEmotion", "andAnyEmotion (require ANY)", e.andAnyEmotion) +
          emotionGatePicker("andAllEmotion", "andAllEmotion (require ALL)", e.andAllEmotion) +
          emotionGatePicker("notAnyEmotion", "notAnyEmotion (block if ANY)", e.notAnyEmotion) +
          emotionGatePicker("notAllEmotion", "notAllEmotion (block if ALL)", e.notAllEmotion) +
          '</div><div>' +
          '<div style="font-size:11px;font-weight:700;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;">Long Term State</div>' +
          emotionGatePicker("andAnyLongTermEmotion", "andAnyLongTermEmotion (require ANY)", e.andAnyLongTermEmotion) +
          emotionGatePicker("andAllLongTermEmotion", "andAllLongTermEmotion (require ALL)", e.andAllLongTermEmotion) +
          emotionGatePicker("notAnyLongTermEmotion", "notAnyLongTermEmotion (block if ANY)", e.notAnyLongTermEmotion) +
          emotionGatePicker("notAllLongTermEmotion", "notAllLongTermEmotion (block if ALL)", e.notAllLongTermEmotion) +
          '</div></div>' +
          '<div class="form-help">Dropdowns write arrays of emotion names. Engine accepts aliases like requireEmotion/blockEmotion too.</div>' +
          "</div>" +

          '<div id="sec_eros" class="form-section">' +
          '<div class="section-title" onclick="this.parentNode.classList.toggle(\'collapsed\')">EROS Gates</div>' +
          '<div class="form-grid" style="align-items:start">' +
          '<div>' +
          '<div style="font-size:11px;font-weight:700;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;">Current Vibe</div>' +
          erosGatePicker("andAnyEros", "andAnyEros (require ANY)", e.andAnyEros) +
          erosGatePicker("andAllEros", "andAllEros (require ALL)", e.andAllEros) +
          erosGatePicker("notAnyEros", "notAnyEros (block if ANY)", e.notAnyEros) +
          erosGatePicker("notAllEros", "notAllEros (block if ALL)", e.notAllEros) +
          '</div><div>' +
          '<div style="font-size:11px;font-weight:700;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;">Long Term State</div>' +
          erosGatePicker("andAnyLongTermEros", "andAnyLongTermEros (require ANY)", e.andAnyLongTermEros) +
          erosGatePicker("andAllLongTermEros", "andAllLongTermEros (require ALL)", e.andAllLongTermEros) +
          erosGatePicker("notAnyLongTermEros", "notAnyLongTermEros (block if ANY)", e.notAnyLongTermEros) +
          erosGatePicker("notAllLongTermEros", "notAllLongTermEros (block if ALL)", e.notAllLongTermEros) +
          '</div></div>' +
          '<div class="form-help">Dropdowns write arrays of eros intensity names. Engine accepts aliases like requireEros/blockEros too.</div>' +
          "</div>" +

          '<div id="sec_intent" class="form-section">' +
          '<div class="section-title" onclick="this.parentNode.classList.toggle(\'collapsed\')">Intent Gates</div>' +
          intentGatePicker("andAnyIntent", "andAnyIntent (require ANY intent)", e.andAnyIntent) +
          intentGatePicker("andAllIntent", "andAllIntent (require ALL intents)", e.andAllIntent) +
          intentGatePicker("notAnyIntent", "notAnyIntent (block if ANY intent)", e.notAnyIntent) +
          intentGatePicker("notAllIntent", "notAllIntent (block if ALL intents)", e.notAllIntent) +
          '<div class="form-help">Dropdowns write arrays of intent names. Engine accepts aliases like requireIntent/blockIntent too.</div>' +
          "</div>" +

          '<div id="sec_entities" class="form-section">' +
          '<div class="section-title" onclick="this.parentNode.classList.toggle(\'collapsed\')">Entities (optional)</div>' +
          '<div class="form-group"><div class="radio-group">' + charCheckboxes + '</div><div class="form-help">If set, entry can be restricted to detected entities.</div></div>' +
          "</div>";

        if (e.shifts && e.shifts.length) {
          var shiftsHtml = '<div class="form-section"><div class="section-title">Shifts (' + e.shifts.length + ")</div>";
          for (var si = 0; si < e.shifts.length; si++) {
            var s = e.shifts[si];
            shiftsHtml +=
              '<div style="padding:8px;margin-bottom:6px;background:rgba(15,23,42,0.8);border:1px solid var(--border-subtle);border-left:3px solid var(--accent);border-radius:var(--radius-md);cursor:pointer;" onclick="window.selectEntry(\'' + e.id + '\', \'' + s.id + '\')">' +
              '<div style="font-size:12px;font-weight:600;">' + escHtml(s.id_name || s.id || ("Shift " + (si + 1))) + "</div>" +
              '<div style="font-size:10px;color:var(--text-soft);">Priority: ' + (s.priority != null ? s.priority : "inherit") + "</div>" +
              "</div>";
          }
          shiftsHtml += "</div>";
          ed.innerHTML += shiftsHtml;
        }
      }

      // --------------------------------------------------------------------------
      // Smart Tag Input Logic
      // --------------------------------------------------------------------------
      function renderSmartTagInput(context, field, label, arr, domId, helpText) {
        var vals = toArray(arr);
        var html = '<div class="form-group">';
        
        html += '<label class="form-label" style="display:flex;justify-content:space-between;align-items:center;">' + escHtml(label);
        if (domId) {
           html += '<button class="pill-button small" onclick="window.openAiModal(\'' + domId + '\')">AI</button>';
        }
        html += '</label>';

        html += '<div class="smart-tag-container" onclick="document.getElementById(\'input_' + field + '_' + context + '\').focus()">';
        for (var i = 0; i < vals.length; i++) {
          html += '<div class="smart-tag">' + escHtml(vals[i]) + '<span class="smart-tag-remove" onclick="window._removeSmartTag(\'' + context + '\', \'' + field + '\', ' + i + ', event)">√ó</span></div>';
        }
        html += '<input id="input_' + field + '_' + context + '" class="smart-tag-input" placeholder="+ Add..." onkeydown="window._handleSmartTagKey(event, \'' + context + '\', \'' + field + '\')" onblur="window._finalizeSmartTag(this, \'' + context + '\', \'' + field + '\', false)">';
        html += '</div>';

        if (helpText) html += '<div class="form-help">' + escHtml(helpText) + '</div>';

        // Hidden input for AI / compatibility
        if (domId) {
           html += '<input type="hidden" id="' + domId + '" value="' + escHtml(joinCsv(vals)) + '" oninput="window._syncSmartTagFromHidden(this, \'' + context + '\', \'' + field + '\')">';
        }
        
        html += '</div>';
        return html;
      }

      window.openSearchReplaceModal = function() {
        var m = document.getElementById('searchReplaceModal');
        if (m) {
          if (window.ModalManager && window.ModalManager.open) window.ModalManager.open(m);
          else m.classList.remove('hidden');
        }
        try { var f = document.getElementById('srFind'); if (f) f.focus(); } catch (_e) {}
      };

      window.openResetAllModal = function() {
        var modal = document.getElementById('resetAllModal');
        var inp = document.getElementById('resetAllConfirmInput');
        var btn = document.getElementById('btnResetAllConfirm');
        if (inp) inp.value = '';
        if (btn) btn.disabled = true;
        if (window.ModalManager && window.ModalManager.open) window.ModalManager.open(modal);
        else if (modal) modal.classList.remove('hidden');
        try { if (inp) inp.focus(); } catch(_e){}
      };

      window._onResetConfirmInput = function(inp) {
        var v = '';
        try { v = String(inp.value || ''); } catch(_e){}
        var ok = (v === 'RESET');
        var btn = document.getElementById('btnResetAllConfirm');
        if (btn) btn.disabled = !ok;
      };

      window.confirmResetAll = function() {
        var inp = document.getElementById('resetAllConfirmInput');
        var v = '';
        try { v = String(inp.value || ''); } catch(_e){}
        if (v !== 'RESET') return;

        try {
          // Clear localStorage keys used by this tool
          localStorage.removeItem('aura_data_autosave');
          localStorage.removeItem('aura_global_personality');
          localStorage.removeItem('aura_global_scenario');
          localStorage.removeItem('aura_global_initial_message');
          localStorage.removeItem('aura_gemini_key');
          localStorage.removeItem('aura_api_keys');
          localStorage.removeItem('aura_active_key');
          localStorage.removeItem('aura_ui_state');
        } catch(_e0){}

        // Reset in-memory state
        try {
          STATE.templateText = null;
          STATE.activeScripts = [];
          STATE.type = 'characters';
          STATE.entryId = null;
          STATE.shiftId = null;
          STATE.data.characters = [];
          STATE.data.pairs = [];
          STATE.data.dynamiclore = [];
          clearDirty();
          updateSaveIndicator('saved');
        } catch(_e1){}

        try { window._closeModalById('resetAllModal'); } catch(_e2){}
        try { renderList(); renderEditor(); renderCode(); } catch(_e3){}
        window.showToast('All values reset.', 'success');
      };



      window.executeSearchReplace = function() {
        var findText = document.getElementById('srFind').value;
        var replaceText = document.getElementById('srReplace').value;
        
        if (!findText) {
          window.showToast("'Find' text cannot be empty.", "error");
          return;
        }

        var isCaseSensitive = document.getElementById('srCaseSensitive').checked;
        var flags = isCaseSensitive ? 'g' : 'gi';
        var findRegex = new RegExp(findText.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), flags);
        
        var scopes = {
          ids: document.getElementById('srScopeIds').checked,
          group: document.getElementById('srScopeGroup').checked,
          tags: document.getElementById('srScopeTags').checked,
          personality: document.getElementById('srScopePersonality').checked,
          scenario: document.getElementById('srScopeScenario').checked
        };

        var replacementCount = 0;

        var replaceInString = function(str) {
          if (typeof str !== 'string' || !str) return str;
          var matches = str.match(findRegex);
          if (matches) {
            replacementCount += matches.length;
            return str.replace(findRegex, replaceText);
          }
          return str;
        };

        var replaceInArray = function(arr) {
          if (!Array.isArray(arr)) return arr;
          return arr.map(function(item) { return replaceInString(item); });
        };

        var processEntry = function(entry, type) {
          if (!entry) return;

          if (type === 'characters') {
            if (scopes.ids && entry.key) entry.key = replaceInString(entry.key);
            if (scopes.tags && entry.aliases) entry.aliases = replaceInArray(entry.aliases);
            if (scopes.personality && entry.personality) entry.personality = replaceInString(entry.personality);
          }
          else if (type === 'pairs') {
            if (scopes.tags && entry.requireTags) entry.requireTags = replaceInArray(entry.requireTags);
            if (scopes.personality && entry.injection) entry.injection = replaceInString(entry.injection);
            if (scopes.group && entry.group) entry.group = replaceInString(entry.group);
          }
          else if (type === 'dynamiclore') {
            if (scopes.ids && entry.id_name) entry.id_name = replaceInString(entry.id_name);
            if (scopes.group && entry.group) entry.group = replaceInString(entry.group);
            if (scopes.tags) {
              if (entry.keywords) entry.keywords = replaceInArray(entry.keywords);
              if (entry.tag) entry.tag = replaceInString(entry.tag);
              if (entry.triggers) entry.triggers = replaceInArray(entry.triggers);
              if (entry.block) entry.block = replaceInArray(entry.block);
              if (entry.andAny) entry.andAny = replaceInArray(entry.andAny);
              if (entry.andAll) entry.andAll = replaceInArray(entry.andAll);
              if (entry.notAll) entry.notAll = replaceInArray(entry.notAll);
            }
            if (scopes.personality && entry.personality) entry.personality = replaceInString(entry.personality);
            if (scopes.scenario && entry.scenario) entry.scenario = replaceInString(entry.scenario);
            
            if (entry.shifts && entry.shifts.length) {
              entry.shifts.forEach(function(s) { processEntry(s, 'dynamiclore'); });
            }
          }
        };

        STATE.data.characters.forEach(function(e) { processEntry(e, 'characters'); });
        STATE.data.pairs.forEach(function(e) { processEntry(e, 'pairs'); });
        STATE.data.dynamiclore.forEach(function(e) { processEntry(e, 'dynamiclore'); });

        (window._closeModalById?window._closeModalById('searchReplaceModal'):document.getElementById('searchReplaceModal').classList.add('hidden'));
        window.showToast("Replaced " + replacementCount + " occurrences.", "success");
        
        renderList();
        renderEditor();
        renderCode();
      };

      window.getEntryValidationErrors = function(entry) {
        var errors = [];
        if (!entry) return errors;
        var entryName = "'" + (entry.id_name || entry.id) + "'";

        var checkContradiction = function(field1, field2, name1, name2) {
            var arr1 = toArray(entry[field1]).map(function(x){ return String(x).toLowerCase(); });
            var arr2 = toArray(entry[field2]).map(function(x){ return String(x).toLowerCase(); });
            for (var i = 0; i < arr1.length; i++) {
                if (arr1[i] && arr2.indexOf(arr1[i]) !== -1) {
                    errors.push("Contradiction in " + entryName + ": '" + arr1[i] + "' exists in both " + name1 + " and " + name2 + ".");
                }
            }
        };

        var checkLimit = function(field, limit, category) {
            var arr = toArray(entry[field]);
            if (arr.length > limit) {
                errors.push("Limit exceeded in " + entryName + ": " + field + " has " + arr.length + " items (max " + limit + " for " + category + ").");
            }
        };

        // Generic Tag Contradictions
        checkContradiction('keywords', 'block', 'Keywords', 'Block');
        checkContradiction('andAny', 'block', 'andAny', 'Block');
        checkContradiction('andAll', 'block', 'andAll', 'Block');
        checkContradiction('andAny', 'notAll', 'andAny', 'notAll');
        checkContradiction('andAll', 'notAll', 'andAll', 'notAll');

        // Emotion Gate Contradictions
        var emoRequire = (entry.andAnyEmotion || []).concat(entry.andAllEmotion || []);
        var emoBlock = (entry.notAnyEmotion || []).concat(entry.notAllEmotion || []);
        emoRequire.forEach(function(val) {
            if (emoBlock.map(function(b){return b.toUpperCase()}).indexOf(val.toUpperCase()) > -1) {
                errors.push("Contradiction in " + entryName + ": Emotion '" + val + "' is both required and blocked.");
            }
        });

        // Limits (using defined constants)
        checkLimit('andAllEmotion', MAX_EMOTION_GATES, 'Emotion');
        checkLimit('notAnyEmotion', MAX_EMOTION_GATES, 'Emotion');
        checkLimit('notAllEmotion', MAX_EMOTION_GATES, 'Emotion');
        checkLimit('andAllEros', MAX_EROS_GATES, 'Eros');
        checkLimit('notAnyEros', MAX_EROS_GATES, 'Eros');
        checkLimit('notAllEros', MAX_EROS_GATES, 'Eros');
        checkLimit('andAllIntent', MAX_INTENT_GATES, 'Intent');
        checkLimit('notAnyIntent', MAX_INTENT_GATES, 'Intent');
        checkLimit('notAllIntent', MAX_INTENT_GATES, 'Intent');

        return errors;
      }

      window.validateAll = function() {
        var results = [];

        var checkRecursively = function(entries) {
            if (!entries) return;
            entries.forEach(function(entry) {
                var errors = getEntryValidationErrors(entry);
                if (errors.length > 0) {
                    results = results.concat(errors);
                }
                if (entry.shifts) {
                    checkRecursively(entry.shifts);
                }
            });
        };

        checkRecursively(STATE.data.dynamiclore);

        // Store results for AI fix
        window._validationResults = results;

        var modal = document.getElementById('validationModal');
        var list = document.getElementById('validationResultList');

        if (results.length === 0) {
            list.innerHTML = '<div style="color: var(--success);">‚úÖ No logical contradictions found.</div>';
            document.getElementById('btnFixContradictions').style.display = 'none';
            document.getElementById('btnAiAutoFix').style.display = 'none';
        } else {
            list.innerHTML = results.map(function(err) { return '<div>- ' + escHtml(err) + '</div>'; }).join('');
            document.getElementById('btnFixContradictions').style.display = 'block';
            document.getElementById('btnAiAutoFix').style.display = 'block';
        }

        document.getElementById('btnAiRepair').style.display = 'none';
        modal.classList.remove('hidden');
      };


      // --------------------------------------------------------------------------
      // Data Health Check (read-only validation)
      // --------------------------------------------------------------------------
      window.runHealthCheck = function() {
        var issues = [];

        function addIssue(kind, msg, type, entryId, shiftId) {
          issues.push({ kind: kind, msg: msg, type: type || '', entryId: entryId || null, shiftId: shiftId || null });
        }

        function isArr(x){ return Object.prototype.toString.call(x) === '[object Array]'; }
        function trim(s){ return String(s == null ? '' : s).replace(/^\s+|\s+$/g,''); }

        // Characters: empty/duplicate keys
        var cSeen = {};
        for (var i=0;i<STATE.data.characters.length;i++){
          var c = STATE.data.characters[i] || {};
          var key = trim(c.key || '');
          if (!key) addIssue('error', 'Character with empty key at index ' + i + '.', 'characters', c.id || null, null);
          else {
            var lk = key.toLowerCase();
            if (cSeen[lk]) addIssue('warn', 'Duplicate character key "' + key + '".', 'characters', c.id || null, null);
            cSeen[lk] = true;
          }
          if (c.aliases && !isArr(c.aliases)) addIssue('warn', 'Character "' + (key||'(unnamed)') + '" has malformed aliases (expected array).', 'characters', c.id || null, null);
        }

        // Pairs: missing refs / empty keys
        var charKeySet = {};
        for (i=0;i<STATE.data.characters.length;i++){
          var ck = trim((STATE.data.characters[i]||{}).key || '');
          if (ck) charKeySet[ck] = true;
        }
        for (i=0;i<STATE.data.pairs.length;i++){
          var p = STATE.data.pairs[i] || {};
          var pa = trim(p.a || p.charA || p.left || '');
          var pb = trim(p.b || p.charB || p.right || '');
          if (!pa || !pb) addIssue('warn', 'Pair missing character reference(s) at index ' + i + '.', 'pairs', p.id || null, null);
          if (pa && !charKeySet[pa]) addIssue('warn', 'Pair references missing character "' + pa + '".', 'pairs', p.id || null, null);
          if (pb && !charKeySet[pb]) addIssue('warn', 'Pair references missing character "' + pb + '".', 'pairs', p.id || null, null);
          if (p.requireTags && !isArr(p.requireTags)) addIssue('warn', 'Pair has malformed requireTags (expected array).', 'pairs', p.id || null, null);
        }

        // DynamicLore: required-ish fields + malformed tags arrays
        function scanLore(entries, parentId){
          if (!entries || !isArr(entries)) return;
          for (var j=0;j<entries.length;j++){
            var e = entries[j] || {};
            var eid = e.id || parentId || null;
            var name = trim(e.id_name || e.name || e.key || '');
            if (!name) addIssue('warn', 'DynamicLore entry missing id_name/name at index ' + j + '.', 'dynamiclore', eid, null);
            if (e.keys && !isArr(e.keys)) addIssue('warn', 'DynamicLore "' + (name||'(unnamed)') + '" has malformed keys (expected array).', 'dynamiclore', eid, null);
            if (e.tags && !isArr(e.tags)) addIssue('warn', 'DynamicLore "' + (name||'(unnamed)') + '" has malformed tags (expected array).', 'dynamiclore', eid, null);
            if (e.shifts && isArr(e.shifts)) {
              for (var k=0;k<e.shifts.length;k++){
                var s = e.shifts[k] || {};
                var sid = s.id || null;
                if (s.tags && !isArr(s.tags)) addIssue('warn', 'Shift for "' + (name||'(unnamed)') + '" has malformed tags (expected array).', 'dynamiclore', eid, sid);
              }
              // recurse if nested
              scanLore(e.shifts, eid);
            }
          }
        }
        scanLore(STATE.data.dynamiclore, null);

        // Store issues for AI repair
        window._healthCheckIssues = issues;

        // Render report
        var modal = document.getElementById('validationModal');
        var list = document.getElementById('validationResultList');
        if (!modal || !list) return;

        document.getElementById('btnFixContradictions').style.display = 'none';
        document.getElementById('btnAiAutoFix').style.display = 'none';

        if (!issues.length) {
          list.innerHTML = '<div style="color: var(--success);">‚úÖ No issues found.</div>';
          document.getElementById('btnAiRepair').style.display = 'none';
        } else {
          var html = '<div style="margin-bottom:8px;"><b>‚ö†Ô∏è ' + issues.length + ' issue(s) found</b></div>';
          for (i=0;i<issues.length;i++){
            var it = issues[i];
            var icon = (it.kind === 'error') ? '‚õî' : '‚ö†Ô∏è';
            html += '<div style="display:flex;justify-content:space-between;gap:10px;align-items:center;border-bottom:1px solid var(--border);padding:6px 0;">';
            html += '<div style="flex:1;">' + icon + ' [' + (it.type || '-') + '] ' + escHtml(it.msg) + '</div>';
            if (it.entryId) {
              html += '<button class="pill-button small" type="button" onclick="window._jumpToIssue(\'' + escHtml(String(it.type||'')) + '\', \'' + escHtml(String(it.entryId)) + '\', \'' + escHtml(String(it.shiftId||'')) + '\')">Jump</button>';
            } else {
              html += '<div style="width:56px;"></div>';
            }
            html += '</div>';
          }
          list.innerHTML = html;
          document.getElementById('btnAiRepair').style.display = 'block';
        }

        if (window.ModalManager && window.ModalManager.open) window.ModalManager.open(modal);
        else modal.classList.remove('hidden');
      };

      window._jumpToIssue = function(type, entryId, shiftId) {
        try {
          if (type === 'characters' || type === 'pairs' || type === 'dynamiclore') {
            window.switchType(type);
            window.selectEntry(entryId, shiftId || null);
            // also ensure Visual tab for editing
            try { window.switchTab('visual'); } catch(_e0){}
          }
        } catch (_e) {}
        try {
          if (window.ModalManager && window.ModalManager.close) window.ModalManager.close(document.getElementById('validationModal'));
          else (window._closeModalById?window._closeModalById('validationModal'):document.getElementById('validationModal').classList.add('hidden'));
        } catch (_e2) {}
      };


      window.fixAllContradictions = function() {
        var fixCount = 0;

        var fixEntry = function(entry) {
            // 1. Generic Tags: Remove requirements from 'block'
            var reqFields = ['keywords', 'andAny', 'andAll'];
            var blockField = 'block';
            
            if (entry[blockField] && entry[blockField].length > 0) {
                reqFields.forEach(function(reqF) {
                    if (entry[reqF] && entry[reqF].length > 0) {
                        var reqs = toArray(entry[reqF]).map(function(x){return String(x).toLowerCase()});
                        for (var i = entry[blockField].length - 1; i >= 0; i--) {
                            if (reqs.indexOf(String(entry[blockField][i]).toLowerCase()) !== -1) {
                                entry[blockField].splice(i, 1);
                                fixCount++;
                            }
                        }
                    }
                });
            }

            // 2. Inference Gates: Remove requirements from 'notAny...'
            var categories = [
                { req: ['andAnyEmotion', 'andAllEmotion'], block: ['notAnyEmotion'] },
                { req: ['andAnyLongTermEmotion', 'andAllLongTermEmotion'], block: ['notAnyLongTermEmotion'] },
                { req: ['andAnyEros', 'andAllEros'], block: ['notAnyEros'] },
                { req: ['andAnyLongTermEros', 'andAllLongTermEros'], block: ['notAnyLongTermEros'] },
                { req: ['andAnyIntent', 'andAllIntent'], block: ['notAnyIntent'] }
            ];

            categories.forEach(function(cat) {
                var allReqs = [];
                cat.req.forEach(function(f) {
                    if (entry[f]) allReqs = allReqs.concat(toArray(entry[f]).map(function(x){return String(x).toLowerCase()}));
                });
                
                if (allReqs.length > 0) {
                    cat.block.forEach(function(bf) {
                        if (entry[bf] && entry[bf].length > 0) {
                             for (var i = entry[bf].length - 1; i >= 0; i--) {
                                if (allReqs.indexOf(String(entry[bf][i]).toLowerCase()) !== -1) {
                                    entry[bf].splice(i, 1);
                                    fixCount++;
                                }
                            }
                        }
                    });
                }
            });

            if (entry.shifts) {
                entry.shifts.forEach(fixEntry);
            }
        };

        STATE.data.dynamiclore.forEach(fixEntry);
        
        if (fixCount > 0) {
            window.showToast("Fixed " + fixCount + " contradictions.", "success");
            window.validateAll(); // Refresh report
            window.renderList(); // Refresh UI if needed
            window.renderEditor();
        } else {
            window.showToast("No simple contradictions found to fix.", "info");
        }
      };

      window._handleSmartTagKey = function(e, context, field) {
        var key = e.key;

        // Commit current value
        if (key === 'Enter' || key === ',' || key === ';' || key === 'Tab') {
          if (key === 'Tab') e.preventDefault();
          if (key === ',' || key === ';') e.preventDefault();
          if (key === 'Enter') e.preventDefault();
          window._finalizeSmartTag(e.target, context, field, true);
          return;
        }

        // Backspace on empty input removes last tag
        if (key === 'Backspace') {
          var v = '';
          try { v = String(e.target && e.target.value != null ? e.target.value : ''); } catch(_e0){}
          if (!v) {
            var entry = (context === 'shift') ? currShift() : curr();
            if (!entry) return;
            var arr = toArray(entry[field]);
            if (arr.length) {
              e.preventDefault();
              arr.pop();
              var patch = {}; patch[field] = arr;
              if (context === 'shift') saveShift(patch); else save(patch);
              try { renderEditor(); } catch (_e1) {}
            }
          }
        }
      };

      
      window._handleSmartTagPaste = function(e, context, field) {
        // If paste includes separators, auto-commit after paste occurs.
        try {
          var txt = '';
          if (e && e.clipboardData && e.clipboardData.getData) {
            txt = e.clipboardData.getData('text') || '';
          }
          // Let the paste happen, then inspect input value.
          setTimeout(function(){
            try{
              var input = e && e.target ? e.target : null;
              if (!input) return;
              var v = String(input.value || '');
              if (!v) return;
              if (v.indexOf(',') >= 0 || v.indexOf('\n') >= 0 || v.indexOf('\r') >= 0 || v.indexOf(';') >= 0) {
                window._finalizeSmartTag(input, context, field, true);
              }
            }catch(_e2){}
          }, 0);
        } catch (_e) {}
      };

window._finalizeSmartTag = function(input, context, field, keepFocus) {
        // Accept single value OR a comma/newline separated list (pastes, etc.)
        var raw = (input && input.value != null) ? String(input.value) : "";
        raw = raw.replace(/\r/g, "");
        if (!raw) return;

        // Split on commas and newlines; trim; drop empties
        var parts = raw.split(/[,\n]+/);
        var cleaned = [];
        for (var i = 0; i < parts.length; i++) {
          var p = String(parts[i]).replace(/^\s+|\s+$/g, '');
          if (!p) continue;
          cleaned.push(p);
        }
        if (!cleaned.length) return;

        var entry = (context === 'shift') ? currShift() : curr();
        if (!entry) return;

        var arr = toArray(entry[field]);
        var changed = false;

        for (i = 0; i < cleaned.length; i++) {
          var val = cleaned[i];

          // Preserve commas inside phrases if user intentionally included them,
          // but do not treat them as separators here (we already split above).
          // De-dupe exact matches.
          if (arr.indexOf(val) < 0) {
            arr.push(val);
            changed = true;
          }
        }

        // Clear visible input regardless (prevents re-adding on blur)
        try { input.value = ""; } catch (_e0) {}

        if (!changed) return;

        var patch = {}; patch[field] = arr;
        if (context === 'shift') saveShift(patch); else save(patch);

        // IMPORTANT: editor UI is not re-rendered by save(), so refresh it
        // to show the newly added tags immediately.
        try { renderEditor(); } catch (_e1) {}

        if (keepFocus) {
          setTimeout(function(){
            var nextInput = document.getElementById('input_' + field + '_' + context);
            if (nextInput) nextInput.focus();
          }, 0);
        }
      };

      window._removeSmartTag = function(context, field, index, e) {
        e.stopPropagation();
        var entry = (context === 'shift') ? currShift() : curr();
        if (!entry) return;

        var arr = toArray(entry[field]);
        arr.splice(index, 1);

        var patch = {}; patch[field] = arr;
        if (context === 'shift') saveShift(patch); else save(patch);

        // Refresh editor immediately (save() doesn't do this)
        try { renderEditor(); } catch (_e) {}
      };

      window._syncSmartTagFromHidden = function(hiddenInput, context, field) {
        var arr = splitCsv(hiddenInput.value);
        var patch = {}; patch[field] = arr;
        if (context === 'shift') saveShift(patch); else save(patch);

        // Refresh editor immediately (so tags appear without tab switching)
        try { renderEditor(); } catch (_e) {}
      };

      function gateTextarea(field, label, arr) {
        return renderSmartTagInput('entry', field, label, arr);
      }

      function emotionGatePicker(field, label, selectedArr) {
        var sel = toArray(selectedArr).map(function (x) { return String(x).toUpperCase(); });

        var selectId = "emo_pick_" + field;
        var opts = '<option value="">Select emotion‚Ä¶</option>';
        for (var i = 0; i < EMOTIONS.length; i++) {
          var emo = EMOTIONS[i];
          opts += '<option value="' + emo + '">' + emo + "</option>";
        }

        // Render selected list with remove buttons
        var listHtml = "";
        for (var j = 0; j < sel.length; j++) {
          var v = sel[j];
          if (!v) continue;
          listHtml +=
            '<div class="tag" style="margin-right:6px;margin-bottom:6px;">' +
            escHtml(v) +
            '<span class="tag-remove" title="Remove" onclick="window._emoRemove(\'' + field + '\', \'' + v + '\')">‚úï</span>' +
            "</div>";
        }
        if (!listHtml) listHtml = '<div class="form-help">No emotions selected.</div>';

        return (
          '<div class="form-group">' +
          '<label class="form-label">' + escHtml(label) + "</label>" +
          '<div style="display:flex;gap:8px;align-items:center;">' +
          '<select id="' + selectId + '" class="form-select" style="flex:1;">' + opts + "</select>" +
          '<button type="button" class="pill-button small" onclick="window._emoAdd(\'' + field + '\', \'' + selectId + '\')">Add</button>' +
          "</div>" +
          '<div class="tag-cloud" style="margin-top:10px;">' + listHtml + "</div>" +
          "</div>"
        );
      }

      function erosGatePicker(field, label, selectedArr) {
        var sel = toArray(selectedArr).map(function (x) { return String(x).toLowerCase(); });

        var selectId = "eros_pick_" + field;
        var opts = '<option value="">Select eros intensity‚Ä¶</option>';
        for (var i = 0; i < EROS_INTENSITIES.length; i++) {
          var intent = EROS_INTENSITIES[i];
          opts += '<option value="' + intent + '">' + intent + "</option>";
        }

        // Render selected list with remove buttons
        var listHtml = "";
        for (var j = 0; j < sel.length; j++) {
          var v = sel[j];
          if (!v) continue;
          listHtml +=
            '<div class="tag" style="margin-right:6px;margin-bottom:6px;">' +
            escHtml(v) +
            '<span class="tag-remove" title="Remove" onclick="window._erosRemove(\'' + field + '\', \'' + v + '\')">‚úï</span>' +
            "</div>";
        }
        if (!listHtml) listHtml = '<div class="form-help">No eros intensities selected.</div>';

        return (
          '<div class="form-group">' +
          '<label class="form-label">' + escHtml(label) + "</label>" +
          '<div style="display:flex;gap:8px;align-items:center;">' +
          '<select id="' + selectId + '" class="form-select" style="flex:1;">' + opts + "</select>" +
          '<button type="button" class="pill-button small" onclick="window._erosAdd(\'' + field + '\', \'' + selectId + '\')">Add</button>' +
          "</div>" +
          '<div class="tag-cloud" style="margin-top:10px;">' + listHtml + "</div>" +
          "</div>"
        );
      }

      function intentGatePicker(field, label, selectedArr) {
        var sel = toArray(selectedArr).map(function (x) { return String(x).toLowerCase(); });

        var selectId = "intent_pick_" + field;
        var opts = '<option value="">Select intent‚Ä¶</option>';
        for (var i = 0; i < INTENTS.length; i++) {
          var intent = INTENTS[i];
          opts += '<option value="' + intent + '">' + intent + "</option>";
        }

        // Render selected list with remove buttons
        var listHtml = "";
        for (var j = 0; j < sel.length; j++) {
          var v = sel[j];
          if (!v) continue;
          listHtml +=
            '<div class="tag" style="margin-right:6px;margin-bottom:6px;">' +
            escHtml(v) +
            '<span class="tag-remove" title="Remove" onclick="window._intentRemove(\'' + field + '\', \'' + v + '\')">‚úï</span>' +
            "</div>";
        }
        if (!listHtml) listHtml = '<div class="form-help">No intents selected.</div>';

        return (
          '<div class="form-group">' +
          '<label class="form-label">' + escHtml(label) + "</label>" +
          '<div style="display:flex;gap:8px;align-items:center;">' +
          '<select id="' + selectId + '" class="form-select" style="flex:1;">' + opts + "</select>" +
          '<button type="button" class="pill-button small" onclick="window._intentAdd(\'' + field + '\', \'' + selectId + '\')">Add</button>' +
          "</div>" +
          '<div class="tag-cloud" style="margin-top:10px;">' + listHtml + "</div>" +
          "</div>"
        );
      }

      /**
       * Generic function to add a gate value (emotion/eros/intent)
       * @param {string} field - The field name to update
       * @param {string} selectId - The select element ID
       * @param {Function} caseTransform - Function to transform case (toUpperCase or toLowerCase)
       */
      function addGateValue(field, selectId, caseTransform) {
        var el = document.getElementById(selectId);
        if (!el) return;
        var v = caseTransform((el.value || ""));
        if (!v) return;

        var e = curr();
        if (!e) return;

        var arr = toArray(e[field]).map(function (x) { return caseTransform(String(x)); });
        if (arr.indexOf(v) < 0) arr.push(v);

        var patch = {};
        patch[field] = arr;
        save(patch);

        // Reset selector
        el.value = "";

        // Refresh UI so pills appear immediately
        try { renderEditor(); } catch (err) {
          console.error("Error rendering editor:", err);
        }
      }

      /**
       * Generic function to remove a gate value (emotion/eros/intent)
       * @param {string} field - The field name to update
       * @param {string} v - The value to remove
       * @param {Function} caseTransform - Function to transform case (toUpperCase or toLowerCase)
       */
      function removeGateValue(field, v, caseTransform) {
        v = caseTransform(String(v || ""));
        var e = curr();
        if (!e) return;

        var arr = toArray(e[field]).map(function (x) { return caseTransform(String(x)); });
        var idx = arr.indexOf(v);
        if (idx >= 0) arr.splice(idx, 1);

        var patch = {};
        patch[field] = arr;
        save(patch);

        // Refresh UI so pills update immediately
        try { renderEditor(); } catch (err) {
          console.error("Error rendering editor:", err);
        }
      }

      // Emotion gates (uppercase)
      window._emoAdd = function (field, selectId) {
        addGateValue(field, selectId, function(s) { return s.toUpperCase(); });
      };

      window._emoRemove = function (field, v) {
        removeGateValue(field, v, function(s) { return s.toUpperCase(); });
      };

      // Eros gates (lowercase)
      window._erosAdd = function (field, selectId) {
        addGateValue(field, selectId, function(s) { return s.toLowerCase(); });
      };

      window._erosRemove = function (field, v) {
        removeGateValue(field, v, function(s) { return s.toLowerCase(); });
      };

      // Intent gates (lowercase)
      window._intentAdd = function (field, selectId) {
        addGateValue(field, selectId, function(s) { return s.toLowerCase(); });
      };

      window._intentRemove = function (field, v) {
        removeGateValue(field, v, function(s) { return s.toLowerCase(); });
      };

      window._toggleLoreChar = function (name) {
        var e = curr();
        if (!e) return;
        var arr = e.characters ? e.characters.slice() : [];
        var idx = arr.indexOf(name);
        if (idx >= 0) arr.splice(idx, 1);
        else arr.push(name);
        save({ characters: arr });
      };

      function renderShiftEditor(parentEntry, shift) {
        if (!shift) return;
        var ed = document.getElementById("visualEditor");

        var bc = '<div class="breadcrumb">Editing Shift of <strong>' + escHtml(parentEntry.id_name || parentEntry.id || "") + "</strong></div>";

        // character checkboxes
        var chars = charKeys();
        var selectedChars = shift.characters || [];
        var charCheckboxes = "";
        if (chars.length) {
          for (var i = 0; i < chars.length; i++) {
            var checked = selectedChars.indexOf(chars[i]) >= 0 ? "checked" : "";
            charCheckboxes += '<label class="radio-pill"><input type="checkbox" ' + checked + ' onchange="window._toggleShiftChar(\'' + chars[i] + '\')"><span>' + escHtml(chars[i]) + "</span></label>";
          }
        } else {
          charCheckboxes = '<div class="form-help">No entities defined yet. Create entities first.</div>';
        }

        ed.innerHTML =
          bc +
          '<div class="form-section">' +
          '<div class="section-title"><div style="display:flex;align-items:center;gap:10px;"><button class="pill-button small" onclick="window.openAiEditModal()">AI Edit</button> Shift</div></div>' +
          '<div class="form-grid">' +
          '<div class="form-group">' +
          '<label class="form-label">Shift ID Name (optional)</label>' +
          '<input class="form-input" value="' + escHtml(shift.id_name || "") + '" onchange="saveShift({id_name:this.value})">' +
          "</div>" +
          '<div class="form-group">' +
          '<label class="form-label">Priority</label>' +
          '<input type="number" class="form-input" value="' + (shift.priority != null ? escHtml(shift.priority) : "") + '" oninput="saveShift({priority:this.value?parseInt(this.value):null})">' +
          '<div class="form-help">Leave blank to inherit</div>' +
          "</div>" +
          '<div class="form-group">' +
          '<label class="form-label">Group</label>' +
          '<input class="form-input" value="' + escHtml(shift.group || "") + '" oninput="saveShift({group:this.value})">' +
          "</div>" +
          "</div>" +
          "</div>" +

          '<div class="form-section">' +
          '<div class="section-title">Keyword + Tag Controls</div>' +
          '<div class="form-grid">' +
          '<div class="form-group">' +
          renderSmartTagInput('shift', 'keywords', 'Keywords', shift.keywords, 'shift-keywords-' + shift.id) +
          "</div>" +
          '<div class="form-group">' +
          '<label class="form-label">tag</label>' +
          '<input class="form-input" value="' + escHtml(shift.tag || "") + '" oninput="saveShift({tag:this.value})">' +
          "</div>" +
          "</div>" +
          '<div class="form-grid">' +
          '<div class="form-group">' +
          renderSmartTagInput('shift', 'triggers', 'Triggers', shift.triggers) +
          "</div>" +
          '<div class="form-group">' +
          '<label class="form-label">probability</label>' +
          '<input class="form-input" value="' + escHtml(shift.probability || "") + '" oninput="saveShift({probability:this.value})">' +
          "</div>" +
          '<div class="form-group">' +
          '<label class="form-label">block</label>' +
          renderSmartTagInput('shift', 'block', 'Block', shift.block) +
          "</div>" +
          "</div>" +
          "</div>" +


          '<div class="form-section">' +
          '<div class="section-title" onclick="this.parentNode.classList.toggle(\'collapsed\')">Tag Gates</div>' +
          renderSmartTagInput('shift', 'andAll', 'andAll (Require All)', shift.andAll) +
          renderSmartTagInput('shift', 'notAll', 'notAll (Block if All)', shift.notAll) +
          '<div class="form-help">Note: <strong>block</strong> above acts as notAny (block if ANY present).</div>' +
          "</div>" +

          '<div class="form-section">' +
          '<div class="section-title" onclick="this.parentNode.classList.toggle(\'collapsed\')">Emotion Gates</div>' +
          '<div class="form-grid" style="align-items:start">' +
          '<div>' +
          '<div style="font-size:11px;font-weight:700;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;">Current Mood</div>' +
          shiftEmotionPicker("andAnyEmotion", "andAnyEmotion", shift.andAnyEmotion) +
          shiftEmotionPicker("andAllEmotion", "andAllEmotion", shift.andAllEmotion) +
          shiftEmotionPicker("notAnyEmotion", "notAnyEmotion", shift.notAnyEmotion) +
          shiftEmotionPicker("notAllEmotion", "notAllEmotion", shift.notAllEmotion) +
          '</div><div>' +
          '<div style="font-size:11px;font-weight:700;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;">Long Term State</div>' +
          shiftEmotionPicker("andAnyLongTermEmotion", "andAnyLongTermEmotion", shift.andAnyLongTermEmotion) +
          shiftEmotionPicker("andAllLongTermEmotion", "andAllLongTermEmotion", shift.andAllLongTermEmotion) +
          shiftEmotionPicker("notAnyLongTermEmotion", "notAnyLongTermEmotion", shift.notAnyLongTermEmotion) +
          shiftEmotionPicker("notAllLongTermEmotion", "notAllLongTermEmotion", shift.notAllLongTermEmotion) +
          '</div></div>' +
          "</div>" +

          '<div class="form-section">' +
          '<div class="section-title" onclick="this.parentNode.classList.toggle(\'collapsed\')">EROS Gates</div>' +
          '<div class="form-grid" style="align-items:start">' +
          '<div>' +
          '<div style="font-size:11px;font-weight:700;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;">Current Vibe</div>' +
          shiftErosGatePicker("andAnyEros", "andAnyEros", shift.andAnyEros) +
          shiftErosGatePicker("andAllEros", "andAllEros", shift.andAllEros) +
          shiftErosGatePicker("notAnyEros", "notAnyEros", shift.notAnyEros) +
          shiftErosGatePicker("notAllEros", "notAllEros", shift.notAllEros) +
          '</div><div>' +
          '<div style="font-size:11px;font-weight:700;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;">Long Term State</div>' +
          shiftErosGatePicker("andAnyLongTermEros", "andAnyLongTermEros", shift.andAnyLongTermEros) +
          shiftErosGatePicker("andAllLongTermEros", "andAllLongTermEros", shift.andAllLongTermEros) +
          shiftErosGatePicker("notAnyLongTermEros", "notAnyLongTermEros", shift.notAnyLongTermEros) +
          shiftErosGatePicker("notAllLongTermEros", "notAllLongTermEros", shift.notAllLongTermEros) +
          '</div></div>' +
          "</div>" +

          '<div class="form-section">' +
          '<div class="section-title" onclick="this.parentNode.classList.toggle(\'collapsed\')">Intent Gates</div>' +
          shiftIntentPicker("andAnyIntent", "andAnyIntent", shift.andAnyIntent) +
          shiftIntentPicker("andAllIntent", "andAllIntent", shift.andAllIntent) +
          shiftIntentPicker("notAnyIntent", "notAnyIntent", shift.notAnyIntent) +
          shiftIntentPicker("notAllIntent", "notAllIntent", shift.notAllIntent) +
          "</div>" +

          '<div class="form-section">' +
          '<div class="section-title" onclick="this.parentNode.classList.toggle(\'collapsed\')">Entities (optional)</div>' +
          '<div class="form-group"><div class="radio-group">' + charCheckboxes + '</div></div>' +
          "</div>" +

          '<div class="form-section">' +
          '<div class="section-title" onclick="this.parentNode.classList.toggle(\'collapsed\')">Shift Personality <button class="pill-button small" onclick="event.stopPropagation();window.openAiModal(\'shift-personality-' + shift.id + '\')">AI</button></div>' +
          '<textarea id="shift-personality-' + shift.id + '" class="form-textarea" style="min-height:120px;" oninput="saveShift({personality:this.value})">' + escHtml(shift.personality || "") + "</textarea>" +
          '<div style="margin-top:8px;"><label class="form-label" style="font-size:10px;">Remove Text (Optional)</label><textarea class="form-textarea" style="min-height:60px;font-size:11px;" oninput="saveShift({remove_personality:this.value})">' + escHtml(shift.remove_personality || "") + '</textarea></div>' +
          "</div>" +

          '<div class="form-section">' +
          '<div class="section-title" onclick="this.parentNode.classList.toggle(\'collapsed\')">Shift Scenario <button class="pill-button small" onclick="event.stopPropagation();window.openAiModal(\'shift-scenario-' + shift.id + '\')">AI</button></div>' +
          '<textarea id="shift-scenario-' + shift.id + '" class="form-textarea" style="min-height:140px;" oninput="saveShift({scenario:this.value})">' + escHtml(shift.scenario || "") + "</textarea>" +
          '<div style="margin-top:8px;"><label class="form-label" style="font-size:10px;">Remove Text (Optional)</label><textarea class="form-textarea" style="min-height:60px;font-size:11px;" oninput="saveShift({remove_scenario:this.value})">' + escHtml(shift.remove_scenario || "") + '</textarea></div>' +
          "</div>" +

          '<div style="margin-top:20px;"><button class="pill-button small" onclick="STATE.shiftId=null;renderEditor();">‚Üê Back to Entry</button></div>';
      }

      function shiftEmotionPicker(field, label, selectedArr) {
        var sel = toArray(selectedArr).map(function (x) { return String(x).toUpperCase(); });

        var selectId = "shift_emo_pick_" + field;
        var opts = '<option value="">Select emotion‚Ä¶</option>';
        for (var i = 0; i < EMOTIONS.length; i++) {
          var emo = EMOTIONS[i];
          opts += '<option value="' + emo + '">' + emo + "</option>";
        }

        var listHtml = "";
        for (var j = 0; j < sel.length; j++) {
          var v = sel[j];
          if (!v) continue;
          listHtml +=
            '<div class="tag" style="margin-right:6px;margin-bottom:6px;">' +
            escHtml(v) +
            '<span class="tag-remove" title="Remove" onclick="window._shiftEmoRemove(\'' + field + '\', \'' + v + '\')">‚úï</span>' +
            "</div>";
        }
        if (!listHtml) listHtml = '<div class="form-help">No emotions selected.</div>';

        return (
          '<div class="form-group">' +
          '<label class="form-label">' + escHtml(label) + "</label>" +
          '<div style="display:flex;gap:8px;align-items:center;">' +
          '<select id="' + selectId + '" class="form-select" style="flex:1;">' + opts + "</select>" +
          '<button type="button" class="pill-button small" onclick="window._shiftEmoAdd(\'' + field + '\', \'' + selectId + '\')">Add</button>' +
          "</div>" +
          '<div class="tag-cloud" style="margin-top:10px;">' + listHtml + "</div>" +
          "</div>"
        );
      }

      function shiftErosGatePicker(field, label, selectedArr) {
        var sel = toArray(selectedArr).map(function (x) { return String(x).toLowerCase(); });

        var selectId = "shift_eros_pick_" + field;
        var opts = '<option value="">Select eros intensity‚Ä¶</option>';
        for (var i = 0; i < EROS_INTENSITIES.length; i++) {
          var intent = EROS_INTENSITIES[i];
          opts += '<option value="' + intent + '">' + intent + "</option>";
        }

        var listHtml = "";
        for (var j = 0; j < sel.length; j++) {
          var v = sel[j];
          if (!v) continue;
          listHtml +=
            '<div class="tag" style="margin-right:6px;margin-bottom:6px;">' +
            escHtml(v) +
            '<span class="tag-remove" title="Remove" onclick="window._shiftErosRemove(\'' + field + '\', \'' + v + '\')">‚úï</span>' +
            "</div>";
        }
        if (!listHtml) listHtml = '<div class="form-help">No eros intensities selected.</div>';

        return (
          '<div class="form-group">' +
          '<label class="form-label">' + escHtml(label) + "</label>" +
          '<div style="display:flex;gap:8px;align-items:center;">' +
          '<select id="' + selectId + '" class="form-select" style="flex:1;">' + opts + "</select>" +
          '<button type="button" class="pill-button small" onclick="window._shiftErosAdd(\'' + field + '\', \'' + selectId + '\')">Add</button>' +
          "</div>" +
          '<div class="tag-cloud" style="margin-top:10px;">' + listHtml + "</div>" +
          "</div>"
        );
      }

      function shiftIntentPicker(field, label, selectedArr) {
        var sel = toArray(selectedArr).map(function (x) { return String(x).toLowerCase(); });

        var selectId = "shift_intent_pick_" + field;
        var opts = '<option value="">Select intent‚Ä¶</option>';
        for (var i = 0; i < INTENTS.length; i++) {
          var intent = INTENTS[i];
          opts += '<option value="' + intent + '">' + intent + "</option>";
        }

        var listHtml = "";
        for (var j = 0; j < sel.length; j++) {
          var v = sel[j];
          if (!v) continue;
          listHtml +=
            '<div class="tag" style="margin-right:6px;margin-bottom:6px;">' +
            escHtml(v) +
            '<span class="tag-remove" title="Remove" onclick="window._shiftIntentRemove(\'' + field + '\', \'' + v + '\')">‚úï</span>' +
            "</div>";
        }
        if (!listHtml) listHtml = '<div class="form-help">No intents selected.</div>';

        return (
          '<div class="form-group">' +
          '<label class="form-label">' + escHtml(label) + "</label>" +
          '<div style="display:flex;gap:8px;align-items:center;">' +
          '<select id="' + selectId + '" class="form-select" style="flex:1;">' + opts + "</select>" +
          '<button type="button" class="pill-button small" onclick="window._shiftIntentAdd(\'' + field + '\', \'' + selectId + '\')">Add</button>' +
          "</div>" +
          '<div class="tag-cloud" style="margin-top:10px;">' + listHtml + "</div>" +
          "</div>"
        );
      }

      window._shiftEmoAdd = function (field, selectId) {
        var el = document.getElementById(selectId);
        if (!el) return;
        var v = (el.value || "").toUpperCase();
        if (!v) return;

        var s = currShift();
        if (!s) return;

        var arr = toArray(s[field]).map(function (x) { return String(x).toUpperCase(); });
        if (arr.indexOf(v) < 0) arr.push(v);

        var patch = {};
        patch[field] = arr;
        saveShift(patch);

        el.value = "";
      };

      window._shiftEmoRemove = function (field, v) {
        v = String(v || "").toUpperCase();
        var s = currShift();
        if (!s) return;

        var arr = toArray(s[field]).map(function (x) { return String(x).toUpperCase(); });
        var idx = arr.indexOf(v);
        if (idx >= 0) arr.splice(idx, 1);

        var patch = {};
        patch[field] = arr;
        saveShift(patch);
      };

      window._shiftErosAdd = function (field, selectId) {
        var el = document.getElementById(selectId);
        if (!el) return;
        var v = (el.value || "").toLowerCase();
        if (!v) return;

        var s = currShift();
        if (!s) return;

        var arr = toArray(s[field]).map(function (x) { return String(x).toLowerCase(); });
        if (arr.indexOf(v) < 0) arr.push(v);

        var patch = {};
        patch[field] = arr;
        saveShift(patch);

        el.value = "";
      };

      window._shiftErosRemove = function (field, v) {
        v = String(v || "").toLowerCase();
        var s = currShift();
        if (!s) return;

        var arr = toArray(s[field]).map(function (x) { return String(x).toLowerCase(); });
        var idx = arr.indexOf(v);
        if (idx >= 0) arr.splice(idx, 1);

        var patch = {};
        patch[field] = arr;
        saveShift(patch);
      };

      window._shiftIntentAdd = function (field, selectId) {
        var el = document.getElementById(selectId);
        if (!el) return;
        var v = (el.value || "").toLowerCase();
        if (!v) return;

        var s = currShift();
        if (!s) return;

        var arr = toArray(s[field]).map(function (x) { return String(x).toLowerCase(); });
        if (arr.indexOf(v) < 0) arr.push(v);

        var patch = {};
        patch[field] = arr;
        saveShift(patch);

        el.value = "";
      };

      window._shiftIntentRemove = function (field, v) {
        v = String(v || "").toLowerCase();
        var s = currShift();
        if (!s) return;

        var arr = toArray(s[field]).map(function (x) { return String(x).toLowerCase(); });
        var idx = arr.indexOf(v);
        if (idx >= 0) arr.splice(idx, 1);

        var patch = {};
        patch[field] = arr;
        saveShift(patch);
      };

      window._toggleShiftChar = function (name) {
        var s = currShift();
        if (!s) return;
        var arr = s.characters ? s.characters.slice() : [];
        var idx = arr.indexOf(name);
        if (idx >= 0) arr.splice(idx, 1);
        else arr.push(name);
        saveShift({ characters: arr });
      };

      // --------------------------------------------------------------------------
      // AI Integration
      // --------------------------------------------------------------------------
      var aiTargetField = null;
      var aiGenerationMode = 'text'; // 'text' or 'entry'

      window.openAiModal = function (targetId) {
        aiTargetField = targetId;
        aiGenerationMode = 'text';
        (window.ModalManager&&window.ModalManager.open?window.ModalManager.open(document.getElementById('aiModal')):document.getElementById('aiModal').classList.remove('hidden'));
        var targetElement = document.getElementById(targetId);
        if (targetElement) {
          document.getElementById('aiPrompt').value = window.getQuillText(targetId) || targetElement.value || '';
        }
        document.getElementById('aiPrompt').readOnly = true;
        document.getElementById('aiResult').value = "Generating...";
        document.getElementById('insertAiResultBtn').style.display = 'none';
        document.querySelector('.pill-button.success').style.display = 'none';
        document.querySelector('.pill-button.danger').style.display = 'none';
        window.generateAiText();
      };

      window.openAiEntryModal = function () {
        aiGenerationMode = 'entry';
        (window.ModalManager&&window.ModalManager.open?window.ModalManager.open(document.getElementById('aiModal')):document.getElementById('aiModal').classList.remove('hidden'));
        
        var promptText = 'Generate a new DYNAMIC_LORE based on the personality and scenario information.';
        if (STATE.type === 'characters') promptText = 'Generate a new CHARACTER entry based on the personality context.';
        if (STATE.type === 'pairs') promptText = 'Generate a new RELATIONSHIP PAIR entry based on the personality context.';
        
        document.getElementById('aiPrompt').value = promptText;
        document.getElementById('aiPrompt').readOnly = false;
        document.getElementById('aiResult').value = "";
        document.getElementById('insertAiResultBtn').style.display = 'none';
        
        var modal = document.getElementById('aiModal');
        var successBtn = modal.querySelector('.pill-button.success');
        var dangerBtn = modal.querySelector('.pill-button.danger');
        if (successBtn) successBtn.style.display = 'inline-flex';
        if (dangerBtn) dangerBtn.style.display = 'inline-flex';
      }

      window.openAiShiftModal = function () {
        if (STATE.type !== 'dynamiclore' || !curr()) {
          window.showToast("Please select a lore entry first.", "error");
          return;
        }
        aiGenerationMode = 'shift';
        (window.ModalManager&&window.ModalManager.open?window.ModalManager.open(document.getElementById('aiModal')):document.getElementById('aiModal').classList.remove('hidden'));
        document.getElementById('aiPrompt').value = 'Generate a Shift for the current entry. Focus on a specific reaction or mood change.';
        document.getElementById('aiPrompt').readOnly = false;
        document.getElementById('aiResult').value = "";
        document.getElementById('insertAiResultBtn').style.display = 'none';
        
        var modal = document.getElementById('aiModal');
        var successBtn = modal.querySelector('.pill-button.success');
        var dangerBtn = modal.querySelector('.pill-button.danger');
        if (successBtn) successBtn.style.display = 'inline-flex';
        if (dangerBtn) dangerBtn.style.display = 'inline-flex';
      }

      window.openAiEditModal = function () {
        var entry = curr();
        if (!entry) {
          window.showToast("No entry selected.", "error");
          return;
        }

        // Check if multiple entries are selected
        var selectedCount = (STATE.selectedIds && STATE.selectedIds.length > 1) ? STATE.selectedIds.length : 1;

        aiGenerationMode = 'edit_entry';
        (window.ModalManager&&window.ModalManager.open?window.ModalManager.open(document.getElementById('aiModal')):document.getElementById('aiModal').classList.remove('hidden'));

        var contextName = (entry.id_name || entry.key || "this entry");
        if (STATE.shiftId) contextName = "this shift";
        else if (selectedCount > 1) contextName = selectedCount + " selected entries";

        document.getElementById('aiPrompt').value = "Refine " + contextName + ". ";
        document.getElementById('aiPrompt').readOnly = false;
        document.getElementById('aiResult').value = "";
        document.getElementById('insertAiResultBtn').style.display = 'none';

        var modal = document.getElementById('aiModal');
        var successBtn = modal.querySelector('.pill-button.success');
        var dangerBtn = modal.querySelector('.pill-button.danger');
        if (successBtn) successBtn.style.display = 'inline-flex';
        if (dangerBtn) dangerBtn.style.display = 'inline-flex';
      };

      window.openAiTextEditModal = function (targetId) {
        var targetElement = document.getElementById(targetId);
        if (!targetElement) {
          window.showToast("Target element not found.", "error");
          return;
        }
        
        aiTargetField = targetId;
        aiGenerationMode = 'edit_text';
        (window.ModalManager&&window.ModalManager.open?window.ModalManager.open(document.getElementById('aiModal')):document.getElementById('aiModal').classList.remove('hidden'));
        
        document.getElementById('aiPrompt').value = "Refine this text: ";
        document.getElementById('aiPrompt').readOnly = false;
        document.getElementById('aiResult').value = "";
        document.getElementById('insertAiResultBtn').style.display = 'inline-flex';
        
        var modal = document.getElementById('aiModal');
        var successBtn = modal.querySelector('.pill-button.success');
        if (successBtn) successBtn.style.display = 'inline-flex';
        document.getElementById('aiPrompt').focus();
      };

      window.closeAiModal = function () {
        (window._closeModalById?window._closeModalById('aiModal'):document.getElementById('aiModal').classList.add('hidden'));
        document.getElementById('aiPrompt').readOnly = false;
        document.getElementById('aiResult').value = "";
        document.getElementById('insertAiResultBtn').style.display = 'inline-flex';
        document.querySelector('.pill-button.success').style.display = 'inline-flex';
        document.querySelector('.pill-button.danger').style.display = 'inline-flex';
      };

      window.insertAiResult = function () {
        var result = document.getElementById('aiResult').value;
        if (aiTargetField) {
          var targetElement = document.getElementById(aiTargetField);
          if (targetElement) {
            // Try to set as Quill content, fallback to regular textarea
            if (window.quillInstances && window.quillInstances[aiTargetField]) {
              window.setQuillText(aiTargetField, result);
            } else {
              targetElement.value = result;
            }
            // Dispatch input event so the specific oninput handler (which handles CSV splitting, saving, etc.) runs automatically
            targetElement.dispatchEvent(new Event('input'));
          }
        }
        window.closeAiModal();
      };

      window.openAiAutoFix = function() {
        if (!window._validationResults || window._validationResults.length === 0) {
          window.showToast("No validation errors to fix.", "info");
          return;
        }

        // Collect all entries with validation errors
        var entriesToFix = [];
        var collectRecursively = function(entries) {
          if (!entries) return;
          entries.forEach(function(entry) {
            var errors = getEntryValidationErrors(entry);
            if (errors.length > 0) {
              entriesToFix.push({
                id: entry.id,
                id_name: entry.id_name,
                errors: errors,
                data: entry
              });
            }
            if (entry.shifts) {
              collectRecursively(entry.shifts);
            }
          });
        };
        collectRecursively(STATE.data.dynamiclore);

        // Build prompt from validation results
        var errorList = window._validationResults.join('\n');
        var prompt = "You are an expert at fixing AURA lorebook validation errors. Fix the following entries automatically.\n\n" +
                     "VALIDATION ERRORS:\n" + errorList + "\n\n" +
                     "ENTRIES WITH ERRORS:\n```json\n" + JSON.stringify(entriesToFix.map(function(e) { return e.data; }), null, 2) + "\n```\n\n" +
                     "TASK: Return ONLY a valid JSON array of the FIXED entries. Maintain all 'id' fields. Fix the issues by:\n" +
                     "- Reducing emotion gates (andAnyEmotion, notAnyEmotion, etc.) to max 2 items\n" +
                     "- Reducing eros gates (andAnyEros, notAnyEros, etc.) to max 2 items\n" +
                     "- Reducing intent gates (andAnyIntent, notAnyIntent, etc.) to max 1 item\n" +
                     "- Keeping the most important/relevant items\n\n" +
                     "Return ONLY the JSON array, no markdown, no explanations.";

        aiGenerationMode = 'validation_fix';
        (window.ModalManager&&window.ModalManager.open?window.ModalManager.open(document.getElementById('aiModal')):document.getElementById('aiModal').classList.remove('hidden'));

        document.getElementById('aiPrompt').value = prompt;
        document.getElementById('aiPrompt').readOnly = true;
        document.getElementById('aiResult').value = "";
        document.getElementById('insertAiResultBtn').style.display = 'none';

        var modal = document.getElementById('aiModal');
        var successBtn = modal.querySelector('.pill-button.success');
        if (successBtn) successBtn.style.display = 'inline-flex';

        // Auto-generate
        setTimeout(function() { window.generateAiText(); }, 100);
      };

      window.openAiRepair = function() {
        if (!window._healthCheckIssues || window._healthCheckIssues.length === 0) {
          window.showToast("No health check issues to repair.", "info");
          return;
        }

        // Build prompt from health check results with current data
        var issuesList = window._healthCheckIssues.map(function(issue) {
          return issue.kind.toUpperCase() + ': [' + issue.type + '] ' + issue.msg;
        }).join('\n');

        var dataSnapshot = {
          characters: STATE.data.characters,
          pairs: STATE.data.pairs,
          dynamiclore: STATE.data.dynamiclore
        };

        var prompt = "You are an expert at repairing AURA lorebook data issues. Fix ALL the following issues automatically.\n\n" +
                     "HEALTH CHECK ISSUES:\n" + issuesList + "\n\n" +
                     "CURRENT DATA:\n```json\n" + JSON.stringify(dataSnapshot, null, 2) + "\n```\n\n" +
                     "TASK: Return ONLY a valid JSON object with the FIXED data. Maintain all 'id' fields. Fix issues by:\n" +
                     "- Adding missing 'key' fields to characters (generate appropriate names)\n" +
                     "- Adding missing 'id_name' fields to dynamiclore entries (generate descriptive names)\n" +
                     "- Fixing malformed arrays (tags, keywords, etc.)\n" +
                     "- Fixing missing character references in pairs\n\n" +
                     "Return ONLY a JSON object in this format:\n" +
                     "{\n" +
                     "  \"characters\": [...],\n" +
                     "  \"pairs\": [...],\n" +
                     "  \"dynamiclore\": [...]\n" +
                     "}\n\n" +
                     "No markdown, no explanations, just the JSON.";

        aiGenerationMode = 'health_repair';
        (window.ModalManager&&window.ModalManager.open?window.ModalManager.open(document.getElementById('aiModal')):document.getElementById('aiModal').classList.remove('hidden'));

        document.getElementById('aiPrompt').value = prompt;
        document.getElementById('aiPrompt').readOnly = true;
        document.getElementById('aiResult').value = "";
        document.getElementById('insertAiResultBtn').style.display = 'none';

        var modal = document.getElementById('aiModal');
        var successBtn = modal.querySelector('.pill-button.success');
        if (successBtn) successBtn.style.display = 'inline-flex';

        // Auto-generate
        setTimeout(function() { window.generateAiText(); }, 100);
      };

      window.generateAiText = async function () {
        var apiKey = document.getElementById('apiKey').value.trim().replace(/[\r\n\s]/g, '');
        if (!apiKey) {
          window.showToast('Please enter your API key.', 'error');
          return;
        }

        var model = document.getElementById('aiModel').value;
        var provider = document.getElementById('aiProvider').value;
        var userPrompt = document.getElementById('aiPrompt').value;
        if (!userPrompt) {
          window.showToast('Please enter a prompt.', 'error');
          return;
        }

        var personalityContext = window.getQuillText('personalityTextarea');
        var scenarioContext = window.getQuillText('scenarioTextarea');
        var fullPrompt = "";

        if (aiGenerationMode === 'edit_text') {
            var originalText = window.getQuillText(aiTargetField);
            fullPrompt = "You are an expert editor. Refine the following text based on the user's instruction. Return only the refined text, without any extra commentary.\n\nORIGINAL TEXT:\n```\n" + originalText + "\n```\n\nINSTRUCTION:\n" + userPrompt + "\n\nREFINED TEXT:";
        } else {
            fullPrompt = "Personality Context:\n" + personalityContext + "\n\nScenario Context:\n" + scenarioContext + "\n\nPrompt:\n" + userPrompt;

            if (aiGenerationMode === 'edit_entry') {
          // Check if multiple entries are selected
          if (STATE.selectedIds && STATE.selectedIds.length > 1 && !STATE.shiftId) {
            // Multi-edit mode
            var selectedEntries = [];
            for (var i = 0; i < STATE.selectedIds.length; i++) {
              var entry = findEntry(STATE.selectedIds[i], STATE.data[STATE.type]);
              if (entry) selectedEntries.push(entry);
            }
            if (selectedEntries.length > 0) {
              fullPrompt += "\n\nCurrent JSON Entries (array of " + selectedEntries.length + " objects):\n```json\n" + JSON.stringify(selectedEntries, null, 2) + "\n```\n\nTask: Modify ALL entries in the array above based on the user request. Return ONLY a valid JSON array with all modified objects. Maintain each entry's 'id' field.";
            }
          } else {
            // Single entry edit mode
            var target = curr();
            if (STATE.shiftId) {
              target = findEntry(STATE.shiftId, STATE.data.dynamiclore);
            }
            if (target) {
              fullPrompt += "\n\nCurrent JSON Entry:\n```json\n" + JSON.stringify(target, null, 2) + "\n```\n\nTask: Modify the JSON object above based on the user request. Return ONLY the valid JSON object. Maintain the 'id' field if possible.";
            }
          }
        } else if (aiGenerationMode === 'entry' || aiGenerationMode === 'shift') {
          if (STATE.type === 'characters' && aiGenerationMode === 'entry') {
            fullPrompt += "\n\nGenerate a single JSON object (or an array of objects) for CHARACTER entries. Do not include ```json markdown.\n\nRequirements:\n1. 'key': lowercase string.\n2. 'gender': 'M', 'F', or 'N'.\n3. 'aliases': array of strings.\n4. 'personality': concise string (max 50 words).";
          } else if (STATE.type === 'pairs' && aiGenerationMode === 'entry') {
            var availableChars = STATE.data.characters.map(function(c){return c.key}).filter(Boolean);
            fullPrompt += "\n\nGenerate a single JSON object (or an array of objects) for RELATIONSHIP PAIR entries. Do not include ```json markdown.\n\nRequirements:\n1. 'pair': array of 2 character keys. MUST use keys from this list: " + JSON.stringify(availableChars) + ".\n2. 'requireTags': array of strings.\n3. 'injection': concise string (max 50 words).\n4. 'group': optional string.";
          } else {
            fullPrompt += "\n\nGenerate a single JSON object (or an array of objects) for DYNAMIC_LORE " + (aiGenerationMode === 'shift' ? "shift" : "entry") + ". The JSON should be compatible with the AURA lorebook format. Do not include ```json markdown.\n\nRequirements:\n1. Set 'priority' to a number between 1 and 10.\n2. CRITICAL: You MUST include emotion gates based on the mood. Use 'andAnyEmotion' (require) or 'notAnyEmotion' (block). Valid emotions: ANGER, JOY, SADNESS, FEAR, ROMANCE, NEUTRAL.\n3. CRITICAL: You MUST include intent gates if applicable. Use 'andAnyIntent' (require) or 'notAnyIntent' (block). Valid intents: question, disclosure, command, promise, conflict, smalltalk, meta, narrative.\n4. CRITICAL: You MUST include eros gates if applicable. Use 'andAnyEros' (require) or 'notAnyEros' (block). Valid eros intensities: platonic, tension, romance, physical, passion, explicit, conflict, aftercare.\n5. Include 'id_name', 'keywords' (array).\n6. 'personality' and 'scenario' fields MUST be concise (max 20 words each).";
            fullPrompt += "\n\nNote: You can also use 'andAnyLongTermEmotion' or 'andAnyLongTermEros' for persistent states.";
          }
        }
        }


        var resultTextarea = document.getElementById('aiResult');
        resultTextarea.value = 'Generating...';
        
        var genBtn = document.querySelector('#aiModal .pill-button.success');
        if(genBtn) { genBtn.disabled = true; genBtn.innerText = "Working..."; }

        try {
          let text = "";

          if (provider === 'openrouter' || provider === 'openai' || provider === 'grok' || provider === 'anythingllm' || provider === 'chutes') {
            let apiUrl = "";
            let headers = {
              "Authorization": `Bearer ${apiKey}`,
              "Content-Type": "application/json"
            };

            if (provider === 'openrouter') {
              apiUrl = "https://openrouter.ai/api/v1/chat/completions";
              headers["HTTP-Referer"] = window.location.href;
              headers["X-Title"] = "AURA Data Manager";
            } else if (provider === 'openai') {
              apiUrl = "https://api.openai.com/v1/chat/completions";
            } else if (provider === 'grok') {
              apiUrl = "https://api.x.ai/v1/chat/completions";
            } else if (provider === 'anythingllm') {
              apiUrl = "http://localhost:3001/api/v1/openai/chat/completions";
            } else if (provider === 'chutes') {
              apiUrl = "https://chutes.ai/api/v1/chat/completions";
            }

            const response = await fetch(apiUrl, {
              method: "POST",
              headers: headers,
              body: JSON.stringify({
                "model": model,
                "messages": [
                  {"role": "user", "content": fullPrompt}
                ]
              })
            });

            if (!response.ok) throw new Error(`${provider} error! status: ${response.status}`);
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            text = data.choices[0].message.content;

          } else {
            // Gemini
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${encodeURIComponent(apiKey)}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                contents: [{ parts: [{ text: fullPrompt }] }],
              }),
            });

            if (!response.ok) {
              let errorDetails = `HTTP error! status: ${response.status}`;
              try {
                const errJson = await response.json();
                if (errJson.error && errJson.error.message) {
                  errorDetails += `\nServer Message: ${errJson.error.message}`;
                }
              } catch (e) { /* ignore */ }
              throw new Error(errorDetails);
            }

            const data = await response.json();
            text = data.candidates[0].content.parts[0].text;
          }

          if (aiGenerationMode === 'entry') {
            try {
              var cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();
              const parsed = JSON.parse(cleanText);
              const entries = Array.isArray(parsed) ? parsed : [parsed];
              
              entries.forEach(newEntry => {
                if (STATE.type === 'characters') {
                  newEntry.id = id('char');
                  STATE.data.characters.push(newEntry);
                } else if (STATE.type === 'pairs') {
                  newEntry.id = id('pair');
                  STATE.data.pairs.push(newEntry);
                } else {
                  newEntry.id = id('lore');
                  if (!newEntry.shifts) newEntry.shifts = [];
                  STATE.data.dynamiclore.push(newEntry);
                }
              });
              renderList();
              window.closeAiModal();
              window.showToast("Generated " + entries.length + " entries!", "success");
            } catch (e) {
              resultTextarea.value = "Error parsing JSON from AI. You can copy the text and manually create the entry.\n\n" + text;
            }
          } else if (aiGenerationMode === 'shift') {
            try {
              var cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();
              const parsed = JSON.parse(cleanText);
              const shifts = Array.isArray(parsed) ? parsed : [parsed];
              
              var parent = STATE.shiftId ? findEntry(STATE.shiftId, STATE.data.dynamiclore) : curr();
              if (!parent) throw new Error("Parent entry not found");
              
              if (!parent.shifts) parent.shifts = [];
              
              shifts.forEach(newShift => {
                newShift.id = id('shift');
                parent.shifts.push(newShift);
              });
              
              renderList(true);
              window.closeAiModal();
              window.showToast("Generated " + shifts.length + " shifts!", "success");
            } catch (e) {
              resultTextarea.value = "Error parsing JSON from AI. You can copy the text and manually create the entry.\n\n" + text;
            }
          } else if (aiGenerationMode === 'edit_entry') {
            try {
              var cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();
              const parsedData = JSON.parse(cleanText);

              // Check if we're in multi-edit mode
              if (STATE.selectedIds && STATE.selectedIds.length > 1 && !STATE.shiftId) {
                // Multi-edit mode: expect an array of updated entries
                const updatedEntries = Array.isArray(parsedData) ? parsedData : [parsedData];
                var updateCount = 0;

                // Update each selected entry by matching ID
                for (var i = 0; i < updatedEntries.length; i++) {
                  var updatedEntry = updatedEntries[i];
                  if (updatedEntry.id) {
                    var target = findEntry(updatedEntry.id, STATE.data[STATE.type]);
                    if (target) {
                      Object.assign(target, updatedEntry);
                      updateCount++;
                    }
                  }
                }

                renderList();
                renderEditor();
                window.closeAiModal();
                window.showToast(updateCount + " entr" + (updateCount === 1 ? "y" : "ies") + " updated!", "success");
              } else {
                // Single entry edit mode
                const updatedEntry = parsedData;
                var target = curr();
                if (STATE.shiftId) target = findEntry(STATE.shiftId, STATE.data.dynamiclore);

                if (target) {
                  Object.assign(target, updatedEntry);
                  renderList();
                  renderEditor();
                  window.closeAiModal();
                  window.showToast("Entry updated!", "success");
                }
              }
            } catch (e) {
              resultTextarea.value = "Error parsing JSON from AI. You can copy the text and manually update the entry.\n\n" + text;
            }
          } else if (aiGenerationMode === 'validation_fix') {
            // Handle validation auto-fix - parse fixed entries and apply them
            try {
              var cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();
              const fixedEntries = JSON.parse(cleanText);
              var updateCount = 0;

              fixedEntries.forEach(function(fixedEntry) {
                if (fixedEntry.id) {
                  // Find the entry in dynamiclore
                  var target = findEntry(fixedEntry.id, STATE.data.dynamiclore);
                  if (target) {
                    Object.assign(target, fixedEntry);
                    updateCount++;
                  }
                }
              });

              renderList();
              renderEditor();
              renderCode();
              autoSave();
              window.closeAiModal();
              window.showToast(updateCount + " validation error(s) fixed!", "success");
              // Re-run validation to show remaining issues
              setTimeout(function() { window.validateAll(); }, 100);
            } catch (e) {
              resultTextarea.value = "Error parsing fixes. You can copy and manually apply.\n\n" + text;
            }
          } else if (aiGenerationMode === 'health_repair') {
            // Handle health check auto-repair - parse fixed data and replace
            try {
              var cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();
              const fixedData = JSON.parse(cleanText);

              if (fixedData.characters) STATE.data.characters = fixedData.characters;
              if (fixedData.pairs) STATE.data.pairs = fixedData.pairs;
              if (fixedData.dynamiclore) STATE.data.dynamiclore = fixedData.dynamiclore;

              renderList();
              renderEditor();
              renderCode();
              autoSave();
              window.closeAiModal();
              window.showToast("Health check issues repaired!", "success");
              // Re-run health check to show remaining issues
              setTimeout(function() { window.runHealthCheck(); }, 100);
            } catch (e) {
              resultTextarea.value = "Error parsing repairs. You can copy and manually apply.\n\n" + text;
            }
          } else if (aiGenerationMode === 'edit_text') {
            resultTextarea.value = text;
          } else {
            resultTextarea.value = text;
            window.insertAiResult();
          }

        } catch (error) {
          resultTextarea.value = 'Error: ' + error.message;
          console.error('AI generation error:', error);
        } finally {
          if(genBtn) { genBtn.disabled = false; genBtn.innerText = "Generate"; }
        }
      };


      // --------------------------------------------------------------------------
      // Code View
      // --------------------------------------------------------------------------
      function renderCode() {
        var eJson = document.getElementById("entryJsonCode");
        var full = document.getElementById("fullExportCode");
        var entry = curr();

        if (entry) {
          var clean = JSON.parse(JSON.stringify(entry));
          delete clean.id;
          eJson.value = JSON.stringify(clean, null, 2);
        } else {
          eJson.value = "";
        }
        full.value = genExport();
      }

      // --------------------------------------------------------------------------
      // Graph View (Force Directed)
      // --------------------------------------------------------------------------
      var gCtx, gNodes = [], gLinks = [], gAnim = null;
      var gCam = { x: 0, y: 0, z: 1 };
      var gDrag = { active: false, node: null, startX: 0, startY: 0, camX: 0, camY: 0, hasMoved: false };

      window.resetGraphCamera = function() {
        var cvs = document.getElementById('graphCanvas');
        if (cvs) {
          gCam.x = cvs.width / 2;
          gCam.y = cvs.height / 2;
          gCam.z = 1;
        }
      };

      // Helper to refresh graph if it's currently visible
      window.maybeRefreshGraph = function() {
        var graphView = document.getElementById('graphView');
        if (graphView && !graphView.classList.contains('hidden')) {
          window.renderGraph();
        }
      };

      window.renderGraph = function() {
        var cvs = document.getElementById('graphCanvas');
        var parent = document.getElementById('graphView');
        if (!cvs || !parent) return;

        // Save existing node positions to restore them
        var oldPositions = {};
        if (gNodes && gNodes.length) {
          gNodes.forEach(function(n) {
            oldPositions[n.id] = { x: n.x, y: n.y, vx: n.vx, vy: n.vy };
          });
        }

        // Reset drag state to prevent stuck nodes across renders
        gDrag = { active: false, node: null, startX: 0, startY: 0, camX: 0, camY: 0, hasMoved: false };

        // Filters
        var showChar = document.getElementById('gFilterChar') ? document.getElementById('gFilterChar').checked : true;
        var showPair = document.getElementById('gFilterPair') ? document.getElementById('gFilterPair').checked : true;
        var showLore = document.getElementById('gFilterLore') ? document.getElementById('gFilterLore').checked : true;
        var showShift = document.getElementById('gFilterShift') ? document.getElementById('gFilterShift').checked : true;
        var groupFilter = document.getElementById('gFilterGroup') ? (document.getElementById('gFilterGroup').value || "").toLowerCase().trim() : "";

        cvs.width = parent.clientWidth;
        cvs.height = parent.clientHeight;
        gCtx = cvs.getContext('2d');
        
        // Build Data with better initial positioning
        gNodes = []; gLinks = [];
        var map = {};
        var charNodes = [], pairNodes = [], loreNodes = [];

        // Characters
        if (showChar) {
          STATE.data.characters.forEach(function(c) {
            var n = { id: c.id, label: c.key, type: 'char', data: c, x: 0, y: 0, vx:0, vy:0, r: 15, color: '#a855f7' };
            // Restore position if node existed before
            if (oldPositions[c.id]) {
              n.x = oldPositions[c.id].x;
              n.y = oldPositions[c.id].y;
              n.vx = oldPositions[c.id].vx;
              n.vy = oldPositions[c.id].vy;
            }
            charNodes.push(n);
            map[c.key] = n; // map by key for linking
          });
        }

        // Pairs
        if (showPair) {
          STATE.data.pairs.forEach(function(p) {
            if (groupFilter && (p.group||"").toLowerCase().indexOf(groupFilter) === -1) return;
            var label = (p.pair||[]).join('+');
            var n = { id: p.id, label: label, type: 'pair', data: p, x: 0, y: 0, vx:0, vy:0, r: 10, color: '#f59e0b' };
            // Restore position if node existed before
            if (oldPositions[p.id]) {
              n.x = oldPositions[p.id].x;
              n.y = oldPositions[p.id].y;
              n.vx = oldPositions[p.id].vx;
              n.vy = oldPositions[p.id].vy;
            }
            pairNodes.push(n);
            if (p.pair) {
              p.pair.forEach(function(k) { if(map[k]) gLinks.push({ s: n, t: map[k], len: 80 }); });
            }
          });
        }

        // Lore - Build keyword/tag index first
        var keywordMap = {}; // keyword -> [nodes]
        var tagMap = {}; // tag -> node

        if (showLore) {
          STATE.data.dynamiclore.forEach(function(l) {
            if (groupFilter && (l.group||"").toLowerCase().indexOf(groupFilter) === -1) return;

            var n = { id: l.id, label: l.id_name || 'Lore', type: 'lore', data: l, x: 0, y: 0, vx:0, vy:0, r: 12, color: '#4f46e5' };
            // Restore position if node existed before
            if (oldPositions[l.id]) {
              n.x = oldPositions[l.id].x;
              n.y = oldPositions[l.id].y;
              n.vx = oldPositions[l.id].vx;
              n.vy = oldPositions[l.id].vy;
            }
            loreNodes.push(n);
            map[l.id] = n; // map by ID for shift parent linking

            // Index keywords
            if (l.keywords && l.keywords.length) {
              l.keywords.forEach(function(kw) {
                if (!kw) return;
                var kwLower = String(kw).toLowerCase();
                if (!keywordMap[kwLower]) keywordMap[kwLower] = [];
                keywordMap[kwLower].push(n);
              });
            }

            // Index tag
            if (l.tag) {
              var tagLower = String(l.tag).toLowerCase();
              tagMap[tagLower] = n;
            }

            // Link to chars
            if (l.characters) {
              l.characters.forEach(function(k) { if(map[k]) gLinks.push({ s: n, t: map[k], len: 100 }); });
            }
          });
        }

        // Create trigger-based links
        gNodes.forEach(function(n) {
          if (n.data.triggers && n.data.triggers.length) {
            n.data.triggers.forEach(function(trigger) {
              if (!trigger) return;
              var trigLower = String(trigger).toLowerCase();
              // Link if trigger matches any keyword
              if (keywordMap[trigLower]) {
                keywordMap[trigLower].forEach(function(targetNode) {
                  if (targetNode.id !== n.id) { // Don't link to self
                    gLinks.push({ s: n, t: targetNode, len: 120, style: 'dashed' });
                  }
                });
              }
            });
          }
        });

        // Create tag-based links for pairs
        gNodes.forEach(function(n) {
          if (n.type === 'pair' && n.data.requireTags && n.data.requireTags.length) {
            n.data.requireTags.forEach(function(tag) {
              if (!tag) return;
              var tagLower = String(tag).toLowerCase();
              if (tagMap[tagLower]) {
                gLinks.push({ s: n, t: tagMap[tagLower], len: 120, style: 'dashed' });
              }
            });
          }
        });

        // Position nodes in organized circles by type
        var cx = cvs.width / 2;
        var cy = cvs.height / 2;
        var baseRadius = Math.min(cvs.width, cvs.height) * 0.3;

        // Position characters in outer circle (only if new/no saved position)
        charNodes.forEach(function(n, i) {
          if (!oldPositions[n.id]) {
            var angle = (i / charNodes.length) * Math.PI * 2;
            n.x = cx + Math.cos(angle) * baseRadius * 1.2;
            n.y = cy + Math.sin(angle) * baseRadius * 1.2;
          }
          gNodes.push(n);
        });

        // Position pairs in middle circle (only if new/no saved position)
        pairNodes.forEach(function(n, i) {
          if (!oldPositions[n.id]) {
            var angle = (i / pairNodes.length) * Math.PI * 2 + Math.PI / 6; // Offset by 30 degrees
            n.x = cx + Math.cos(angle) * baseRadius * 0.7;
            n.y = cy + Math.sin(angle) * baseRadius * 0.7;
          }
          gNodes.push(n);
        });

        // Position lore in inner circle (only if new/no saved position)
        loreNodes.forEach(function(n, i) {
          if (!oldPositions[n.id]) {
            var angle = (i / loreNodes.length) * Math.PI * 2;
            n.x = cx + Math.cos(angle) * baseRadius * 0.3;
            n.y = cy + Math.sin(angle) * baseRadius * 0.3;
          }
          gNodes.push(n);
        });

        // Now process shifts AFTER parent lore nodes are positioned
        var processShifts = function(shifts, parentNode, depth) {
          if (!showShift || !shifts || !shifts.length) return;

          shifts.forEach(function(s) {
            var offset = 20 + (depth * 10);
            var sn = {
              id: s.id,
              parentId: parentNode.id,
              label: s.id_name || 'Shift',
              type: 'shift',
              data: s,
              x: parentNode.x + (Math.random()-0.5)*offset,
              y: parentNode.y + (Math.random()-0.5)*offset,
              vx:0, vy:0,
              r: Math.max(6, 8 - depth),
              color: depth === 1 ? '#22c55e' : '#10b981'
            };
            // Restore position if shift existed before
            if (oldPositions[s.id]) {
              sn.x = oldPositions[s.id].x;
              sn.y = oldPositions[s.id].y;
              sn.vx = oldPositions[s.id].vx;
              sn.vy = oldPositions[s.id].vy;
            }
            gNodes.push(sn);
            map[s.id] = sn; // map shift by ID

            // Link to parent
            gLinks.push({ s: sn, t: parentNode, len: 40 + (depth * 10) });

            // Shift char links
            if (s.characters) {
              s.characters.forEach(function(k) { if(map[k]) gLinks.push({ s: sn, t: map[k], len: 100 }); });
            }

            // Index shift keywords
            if (s.keywords && s.keywords.length) {
              s.keywords.forEach(function(kw) {
                if (!kw) return;
                var kwLower = String(kw).toLowerCase();
                if (!keywordMap[kwLower]) keywordMap[kwLower] = [];
                keywordMap[kwLower].push(sn);
              });
            }

            // Index shift tag
            if (s.tag) {
              var tagLower = String(s.tag).toLowerCase();
              tagMap[tagLower] = sn;
            }

            // Recursively process nested shifts
            if (s.shifts && s.shifts.length) {
              processShifts(s.shifts, sn, depth + 1);
            }
          });
        };

        // Process all lore shifts now that parents are positioned
        loreNodes.forEach(function(n) {
          if (n.data.shifts && n.data.shifts.length) {
            processShifts(n.data.shifts, n, 1);
          }
        });

        // Center camera
        gCam.x = cvs.width / 2;
        gCam.y = cvs.height / 2;

        // Start Loop
        if (gAnim) cancelAnimationFrame(gAnim);
        gAnim = requestAnimationFrame(gTick);

        // Events
        cvs.onmousedown = function(e) {
          var rect = cvs.getBoundingClientRect();
          var mx = (e.clientX - rect.left - gCam.x) / gCam.z;
          var my = (e.clientY - rect.top - gCam.y) / gCam.z;
          
          gDrag.active = true;
          gDrag.startX = e.clientX;
          gDrag.startY = e.clientY;
          gDrag.hasMoved = false;
          gDrag.camX = gCam.x;
          gDrag.camY = gCam.y;
          gDrag.node = null;
          
          // Hit test
          for(var i=gNodes.length-1; i>=0; i--) {
            var n = gNodes[i];
            var dx = mx - n.x, dy = my - n.y;
            if (dx*dx + dy*dy < n.r*n.r) {
              gDrag.node = n; break;
            }
          }
        };
        cvs.onmousemove = function(e) {
          var rect = cvs.getBoundingClientRect();
          var mx = (e.clientX - rect.left - gCam.x) / gCam.z;
          var my = (e.clientY - rect.top - gCam.y) / gCam.z;

          if (!gDrag.active) {
            var hoverNode = null;
            for(var i=gNodes.length-1; i>=0; i--) { var n = gNodes[i]; var dx = mx - n.x, dy = my - n.y; if (dx*dx + dy*dy < n.r*n.r) { hoverNode = n; break; } }
            cvs.style.cursor = hoverNode ? 'pointer' : 'grab';
            
            var tip = document.getElementById('graphTooltip');
            if (hoverNode) {
              var d = hoverNode.data;
              var content = "<strong>" + escHtml(hoverNode.label) + "</strong>";
              content += "<div class='meta'>" + hoverNode.type.toUpperCase() + (d.group ? " ¬∑ " + escHtml(d.group) : "") + "</div>";
              
              var parts = [];
              if (d.personality) parts.push("<strong>Personality:</strong> " + escHtml(d.personality));
              if (d.scenario) parts.push("<strong>Scenario:</strong> " + escHtml(d.scenario));
              if (d.injection) parts.push("<strong>Injection:</strong> " + escHtml(d.injection));
              if (parts.length > 0) content += "<div class='preview'>" + parts.join("<br><br>") + "</div>";
              tip.innerHTML = content;
              tip.style.display = 'block';
              tip.style.left = (e.clientX + 15) + 'px';
              tip.style.top = (e.clientY + 15) + 'px';
            } else {
              tip.style.display = 'none';
            }
            return;
          }

          if (Math.abs(e.clientX - gDrag.startX) > 3 || Math.abs(e.clientY - gDrag.startY) > 3) {
            gDrag.hasMoved = true;
          }

          if (gDrag.node) {
            gDrag.node.x = (e.clientX - rect.left - gCam.x) / gCam.z;
            gDrag.node.y = (e.clientY - rect.top - gCam.y) / gCam.z;
            gDrag.node.vx = 0; gDrag.node.vy = 0;
          } else {
            gCam.x = gDrag.camX + (e.clientX - gDrag.startX);
            gCam.y = gDrag.camY + (e.clientY - gDrag.startY);
          }
        };
        cvs.onmouseup = function() {
          var wasClick = gDrag.active && !gDrag.hasMoved;
          var n = gDrag.node;
          
          gDrag.active = false; 
          gDrag.node = null; 

          if (wasClick && n && n.id) {
             if (n.type === 'char') window.switchType('characters');
             else if (n.type === 'pair') window.switchType('pairs');
             else window.switchType('dynamiclore');
             
             // Update sidebar active state
             var btns = document.querySelectorAll(".data-type-btn");
             for(var j=0; j<btns.length; j++) {
               var b = btns[j];
               b.classList.remove("active");
               if((n.type==='char' && b.innerText.includes('Chars')) || (n.type==='pair' && b.innerText.includes('Pairs')) || ((n.type==='lore'||n.type==='shift') && b.innerText.includes('Lore'))) b.classList.add("active");
             }

             if (n.type === 'shift') window.selectEntry(n.parentId, n.id);
             else window.selectEntry(n.id);
             
             window.switchTab('visual');
          }
        };
        cvs.onmouseleave = function() { document.getElementById('graphTooltip').style.display = 'none'; gDrag.active = false; gDrag.node = null; };
        cvs.ondblclick = null;
        cvs.onwheel = function(e) {
          e.preventDefault();
          var s = Math.exp(-e.deltaY * 0.001);
          gCam.z *= s;
        };
      };

      function gTick() {
        var searchTerm = document.getElementById('gSearchNode') ? document.getElementById('gSearchNode').value.toLowerCase().trim() : "";

        // Repulsion forces between nodes
        for (var i=0; i<gNodes.length; i++) {
          var a = gNodes[i];
          for (var j=i+1; j<gNodes.length; j++) {
            var b = gNodes[j];
            var dx = b.x - a.x, dy = b.y - a.y;
            var d2 = dx*dx + dy*dy + 0.1;
            var d = Math.sqrt(d2);
            var f = (GRAPH_REPULSION_FORCE / d2) * GRAPH_REPULSION_MULTIPLIER;
            var fx = (dx/d) * f, fy = (dy/d) * f;
            a.vx -= fx; a.vy -= fy;
            b.vx += fx; b.vy += fy;
          }
          // Center gravity - pull nodes toward center
          a.vx -= a.x * GRAPH_CENTER_GRAVITY;
          a.vy -= a.y * GRAPH_CENTER_GRAVITY;
        }

        // Spring forces for links
        gLinks.forEach(function(l) {
          var dx = l.t.x - l.s.x, dy = l.t.y - l.s.y;
          var d = Math.sqrt(dx*dx + dy*dy);
          var f = (d - l.len) * GRAPH_LINK_STIFFNESS;
          var fx = (dx/d) * f, fy = (dy/d) * f;
          l.s.vx += fx; l.s.vy += fy;
          l.t.vx -= fx; l.t.vy -= fy;
        });

        // Update node positions with velocity damping
        gNodes.forEach(function(n) {
          if (n === gDrag.node) return;
          n.x += n.vx; n.y += n.vy;
          n.vx *= GRAPH_DRAG; n.vy *= GRAPH_DRAG;
        });

        // Draw
        if (!gCtx) return;
        var cvs = gCtx.canvas;
        gCtx.clearRect(0, 0, cvs.width, cvs.height);
        gCtx.save();
        gCtx.translate(gCam.x, gCam.y);
        gCtx.scale(gCam.z, gCam.z);

        gCtx.lineWidth = 2;
        gLinks.forEach(function(l) {
          var dim = false;
          if (searchTerm) {
             if (l.s.label.toLowerCase().indexOf(searchTerm) === -1 && l.t.label.toLowerCase().indexOf(searchTerm) === -1) dim = true;
          }

          // Use different styles for different link types
          if (l.style === 'dashed') {
            gCtx.strokeStyle = '#6366f1'; // Indigo for trigger/tag links
            gCtx.setLineDash([5, 5]);
          } else {
            gCtx.strokeStyle = '#374151'; // Gray for structural links
            gCtx.setLineDash([]);
          }

          gCtx.globalAlpha = dim ? 0.05 : (l.style === 'dashed' ? 0.6 : 1);
          gCtx.beginPath(); gCtx.moveTo(l.s.x, l.s.y); gCtx.lineTo(l.t.x, l.t.y); gCtx.stroke();
          gCtx.globalAlpha = 1;
        });
        gCtx.setLineDash([]); // Reset line dash

        gNodes.forEach(function(n) {
          var isMatch = !searchTerm || n.label.toLowerCase().indexOf(searchTerm) !== -1;
          gCtx.globalAlpha = isMatch ? 1 : 0.1;
          gCtx.fillStyle = n.color; gCtx.beginPath(); gCtx.arc(n.x, n.y, n.r, 0, Math.PI*2); gCtx.fill();
          if (isMatch) { gCtx.fillStyle = '#fff'; gCtx.font = '10px sans-serif'; gCtx.textAlign = 'center'; gCtx.fillText(n.label, n.x, n.y + n.r + 12); }
          gCtx.globalAlpha = 1;
        });
        gCtx.restore();
        gAnim = requestAnimationFrame(gTick);
      }

      // --------------------------------------------------------------------------
      // Boot
      // --------------------------------------------------------------------------
      window.onload = function () {
        // Migrate old single API key to new multi-key system
        var oldKey = localStorage.getItem('aura_gemini_key');
        if (oldKey) {
          var keys = window.getApiKeys();
          // Only migrate if no keys exist yet
          if (Object.keys(keys).length === 0) {
            keys['Default'] = oldKey;
            window.saveApiKeys(keys);
            window.setActiveKeyName('Default');
          }
          // Remove old key after migration
          localStorage.removeItem('aura_gemini_key');
        }

        // Initialize API key selector and load active key
        window.refreshApiKeySelector();
        window.switchApiKey();

        // --------------------------------------------------------------------------
        // Quill Editor Initialization
        // --------------------------------------------------------------------------
        window.quillInstances = {};

        // Quill configuration
        var quillToolbarOptions = [
          [{ 'header': [1, 2, 3, false] }],
          ['bold', 'italic', 'underline', 'strike'],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
          ['blockquote', 'code-block'],
          [{ 'color': [] }, { 'background': [] }],
          ['link'],
          ['clean']
        ];

        // Helper function to initialize a Quill editor
        window.initQuillEditor = function(elementId, placeholder, onChangeCallback) {
          var element = document.getElementById(elementId);
          if (!element || window.quillInstances[elementId]) return window.quillInstances[elementId];

          var quill = new Quill('#' + elementId, {
            theme: 'snow',
            placeholder: placeholder || 'Enter text...',
            modules: {
              toolbar: quillToolbarOptions
            }
          });

          if (onChangeCallback) {
            quill.on('text-change', function() {
              onChangeCallback(quill);
            });
          }

          window.quillInstances[elementId] = quill;
          return quill;
        };

        // Helper to get text content from Quill editor
        window.getQuillText = function(elementId) {
          var quill = window.quillInstances[elementId];
          if (quill) {
            return quill.root.innerHTML;
          }
          var el = document.getElementById(elementId);
          return el ? (el.value || '') : '';
        };

        // Helper to set text content in Quill editor
        window.setQuillText = function(elementId, content) {
          var quill = window.quillInstances[elementId];
          if (quill) {
            quill.root.innerHTML = content || '';
          } else {
            var el = document.getElementById(elementId);
            if (el) {
              if (el.tagName === 'TEXTAREA') {
                el.value = content || '';
              } else {
                el.innerHTML = content || '';
              }
            }
          }
        };

        // Initialize main editors with localStorage sync and stats
        window.quillInstances.personalityTextarea = window.initQuillEditor('personalityTextarea', 'Enter personality details...', function(quill) {
          var html = quill.root.innerHTML;
          localStorage.setItem('aura_global_personality', html);
          window.updateStats('personalityTextarea', 'personalityStats');
        });

        window.quillInstances.scenarioTextarea = window.initQuillEditor('scenarioTextarea', 'Enter scenario details...', function(quill) {
          var html = quill.root.innerHTML;
          localStorage.setItem('aura_global_scenario', html);
          window.updateStats('scenarioTextarea', 'scenarioStats');
        });

        window.quillInstances.initialMessageTextarea = window.initQuillEditor('initialMessageTextarea', 'Enter initial message...', function(quill) {
          var html = quill.root.innerHTML;
          localStorage.setItem('aura_global_initial_message', html);
          window.updateStats('initialMessageTextarea', 'initialMessageStats');
        });

        // Initialize laboratory editors
        window.quillInstances.labPersonality = window.initQuillEditor('labPersonality', 'Global Personality...', function(quill) {
          window.syncFromLab('personality', quill.root.innerHTML);
        });

        window.quillInstances.labScenario = window.initQuillEditor('labScenario', 'Global Scenario...', function(quill) {
          window.syncFromLab('scenario', quill.root.innerHTML);
        });

        // Initialize context panel editors
        window.quillInstances.ctxPersonality = window.initQuillEditor('ctxPersonality', 'Global Personality...', function(quill) {
          window.syncContext('personality', quill.root.innerHTML);
        });

        window.quillInstances.ctxScenario = window.initQuillEditor('ctxScenario', 'Global Scenario...', function(quill) {
          window.syncContext('scenario', quill.root.innerHTML);
        });

        window.quillInstances.ctxInitialMessage = window.initQuillEditor('ctxInitialMessage', 'First message...', function(quill) {
          window.syncContext('initialMessage', quill.root.innerHTML);
        });

        // Load saved values from localStorage
        var savedPers = localStorage.getItem('aura_global_personality');
        if (savedPers) {
          window.setQuillText('personalityTextarea', savedPers);
          window.updateStats('personalityTextarea', 'personalityStats');
        }
        var savedScen = localStorage.getItem('aura_global_scenario');
        if (savedScen) {
          window.setQuillText('scenarioTextarea', savedScen);
          window.updateStats('scenarioTextarea', 'scenarioStats');
        }

        var savedInit = localStorage.getItem('aura_global_initial_message') || "";
        if (savedInit) {
          window.setQuillText('initialMessageTextarea', savedInit);
          window.updateStats('initialMessageTextarea', 'initialMessageStats');
        }

        // Auto-load saved data
        autoLoad();

        // Restore UI state (tab/type/selection/search)
        try { applyUiState(); } catch (_e) {}

        window.clearChat();
        renderList();
        renderEditor();
        renderCode();

        
        // --------------------------------------------------------------------------
        // Modal UX: Esc-to-close + Focus Trap (topmost open modal)
        // --------------------------------------------------------------------------
        (function(){
          var MODAL_SELECTOR = 'div[id$="Modal"]';
          var activeModal = null;
          var prevFocus = null;

          function isHidden(el){
            if (!el) return true;
            return el.classList && el.classList.contains('hidden');
          }

          function listOpenModals(){
            var all = document.querySelectorAll(MODAL_SELECTOR);
            var open = [];
            for (var i=0;i<all.length;i++){
              if (!isHidden(all[i])) open.push(all[i]);
            }
            return open;
          }

          function topmostModal(){
            var open = listOpenModals();
            if (!open.length) return null;
            // Prefer highest z-index if present, otherwise last in DOM order
            var top = open[open.length-1];
            var topZ = -1;
            for (var i=0;i<open.length;i++){
              var z = 0;
              try { z = parseInt((window.getComputedStyle(open[i]).zIndex||'0'), 10); } catch(_e){}
              if (!isNaN(z) && z >= topZ){ topZ = z; top = open[i]; }
            }
            return top;
          }

          function getFocusable(modal){
            if (!modal) return [];
            var nodes = modal.querySelectorAll('a[href],button:not([disabled]),textarea,input,select,[tabindex]');
            var out = [];
            for (var i=0;i<nodes.length;i++){
              var n = nodes[i];
              if (!n) continue;
              if (n.getAttribute && n.getAttribute('tabindex') === '-1') continue;
              // skip hidden elements
              if (n.offsetParent === null && n !== document.activeElement) continue;
              out.push(n);
            }
            return out;
          }

          function focusFirst(modal){
            var f = getFocusable(modal);
            if (f.length) { try{ f[0].focus(); }catch(_e){} }
          }

          function closeModal(modal){
            if (!modal) return;
            try { modal.classList.add('hidden'); } catch(_e){}
            activeModal = topmostModal();
            if (!activeModal) {
              // restore focus
              if (prevFocus) { try{ prevFocus.focus(); }catch(_e2){} }
              prevFocus = null;
            } else {
              focusFirst(activeModal);
            }
          }

          function openModal(modal){
            if (!modal) return;
            if (!prevFocus) prevFocus = document.activeElement;
            activeModal = modal;
            try { modal.classList.remove('hidden'); } catch(_e){}
            focusFirst(modal);
          }

          // Expose for existing openers (optional)
          window.ModalManager = {
            open: openModal,
            close: closeModal,
            top: topmostModal
          };

          document.addEventListener('keydown', function(e){
            // Esc closes topmost modal, even if focused in an input
            if (e.key === 'Escape' || e.key === 'Esc') {
              var top = topmostModal();
              if (top) {
                e.preventDefault();
                closeModal(top);
                return;
              }
            }

            // Trap Tab inside topmost modal
            if (e.key === 'Tab') {
              var t = topmostModal();
              if (!t) return;
              var focusables = getFocusable(t);
              if (!focusables.length) return;

              var first = focusables[0];
              var last = focusables[focusables.length-1];
              var cur = document.activeElement;

              if (e.shiftKey) {
                if (cur === first || cur === t) {
                  e.preventDefault();
                  try{ last.focus(); }catch(_e1){}
                }
              } else {
                if (cur === last) {
                  e.preventDefault();
                  try{ first.focus(); }catch(_e2){}
                }
              }
            }
          });

          // Patch common close buttons to also restore focus by using ModalManager.close
          window._closeModalById = function(id){
            var el = document.getElementById(id);
            if (el) closeModal(el);
          };
        })();

        // Esc should also close Quick Switcher (not a modal)
        document.addEventListener('keydown', function(e){
          if (e.key === 'Escape' || e.key === 'Esc') {
            var qs = document.getElementById('quickSwitcher');
            if (qs && !qs.classList.contains('hidden')) {
              e.preventDefault();
              qs.classList.add('hidden');
              try { if (document.activeElement) document.activeElement.blur(); } catch(_e){}
            }
          }
        });



// Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
          // Ctrl+F - Search
          if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
            e.preventDefault();
            var searchInput = document.getElementById('searchInput');
            if (searchInput) {
              searchInput.focus();
              searchInput.select();
            }
          }
          // Ctrl+P - Quick Switcher
          if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
            e.preventDefault();
            window.toggleQuickSwitcher();
          }
          // Ctrl+N - New Entry
          if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
            e.preventDefault();
            window.createNew();
          }
          // Ctrl+D - Duplicate Entry
          if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
            e.preventDefault();
            window.duplicate();
          }
          // Ctrl+H - Find & Replace
          if ((e.ctrlKey || e.metaKey) && e.key === 'h') {
            e.preventDefault();
            window.openSearchReplaceModal();
          }
          // Ctrl+S - Save to File
          if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            window.exportData();
          }
          // Ctrl+? or Ctrl+/ - Keyboard Shortcuts
          if ((e.ctrlKey || e.metaKey) && (e.key === '?' || e.key === '/')) {
            e.preventDefault();
            window.showKeyboardShortcuts();
          }
          // Delete key - Delete Entry
          if (e.key === 'Delete' && !e.target.matches('input, textarea')) {
            e.preventDefault();
            window.deleteEntry();
          }
});
      };

      // --------------------------------------------------------------------------
      // Tutorial System
      // --------------------------------------------------------------------------
      var tutStep = 0;
      var basicTutData = [
        { id: null, title: "Welcome to AURA", text: "This tutorial will walk you through creating a Dynamic Lore entry. We have automatically created a new entry for you to edit." },
        { id: "fld_idname", title: "ID Name", text: "Give your entry a unique ID (e.g., 'holly_fear_response'). This helps you find it later and reference it in other tools." },
        { id: "fld_keywords", title: "Keywords", text: "Enter comma-separated words that trigger this entry (e.g., 'christmas, snow, holiday'). If these words appear in chat, this entry becomes active." },
        { id: "btn_ai_pers", title: "AI Assistance", text: "Click this AI button to automatically generate the personality text based on your settings! It saves a lot of typing." },
        { id: "sec_emotion", title: "Emotion Gates", text: "These gates control WHEN this entry triggers based on the mood. For example, require 'JOY' so this entry only happens when the user is happy." },
        { id: "btn_save_file", title: "Save Your Work", text: "Finally, remember to click 'Save to File' frequently to download your database as a .js file." }
      ];

      var advancedTutData = [
        { id: null, title: "Advanced Tutorial", text: "This detailed guide covers every field in the Dynamic Lore editor." },
        { id: "fld_idname", title: "ID Name", text: "Unique identifier for this entry. Used for debugging and referencing." },
        { id: "fld_priority", title: "Priority", text: "Determines insertion order. Higher numbers appear lower in context (more important)." },
        { id: "fld_group", title: "Group", text: "Optional label to organize entries in the sidebar." },
        { id: "fld_keywords", title: "Keywords", text: "Phrases that trigger this entry when found in user/AI chat." },
        { id: "fld_tag", title: "Tag", text: "A specific tag name for this entry. Useful if other entries want to require/block this specific entry via gates." },
        { id: "fld_triggers", title: "Triggers (Emitted Tags)", text: "Tags that become 'active' when this entry is inserted. Other entries can require these tags." },
        { id: "fld_probability", title: "Probability", text: "Chance for this entry to trigger when keywords match (e.g., '50%')." },
        { id: "fld_block", title: "Block (Block Tags)", text: "If any of these tags are active in the context, this entry will NOT trigger." },
        { id: "sec_personality", title: "Personality", text: "Defines the character's mind, tone, and behavior for this specific context." },
        { id: "sec_scenario", title: "Scenario", text: "Defines the physical situation, actions, or plot points for this context." },
        { id: "sec_tag_gates", title: "Tag Gates", text: "Require (andAll) or Block (notAll) based on other active tags in the system." },
        { id: "sec_emotion", title: "Emotion Gates", text: "Restrict this entry to specific emotional states (Joy, Anger, etc.)." },
        { id: "sec_eros", title: "Eros Gates", text: "Restrict this entry to specific arousal/romance levels (Tension, Passion, etc.)." },
        { id: "sec_intent", title: "Intent Gates", text: "Restrict this entry to specific user intents (Question, Command, etc.)." },
        { id: "sec_entities", title: "Entity Filters", text: "Only trigger if specific characters are present in the scene." }
      ];

      var walkthroughTutData = [
        { id: null, title: "Interactive Walkthrough", text: "This guide will help you create a valid entry step-by-step. You must complete each step to proceed." },
        { 
          id: "fld_idname", 
          title: "Step 1: ID Name", 
          text: "Enter a unique ID for this entry (e.g., 'holly_greeting').",
          validate: function() {
            var e = curr();
            if (!e || !e.id_name) {
              window.showToast("Please enter an ID Name.", "error");
              return false;
            }
            return true;
          }
        },
        { 
          id: "fld_keywords", 
          title: "Step 2: Keywords", 
          text: "Enter at least one keyword that triggers this entry (e.g., 'hello').",
          validate: function() {
            var e = curr();
            if (!e || !e.keywords || e.keywords.length === 0) {
              window.showToast("Please enter at least one keyword.", "error");
              return false;
            }
            return true;
          }
        },
        { 
          id: "sec_personality", 
          title: "Step 3: Personality", 
          text: "Define the personality. You can type it manually or use the AI button.",
          validate: function() {
            var e = curr();
            if (!e || !e.personality) {
              window.showToast("Please enter personality text.", "error");
              return false;
            }
            return true;
          }
        },
        { 
          id: "sec_emotion", 
          title: "Step 4: Emotion Gates", 
          text: "Select at least one 'Current Mood' emotion (e.g., NEUTRAL) to gate this entry.",
          validate: function() {
            var e = curr();
            if (!e) return false;
            var has = (e.andAnyEmotion && e.andAnyEmotion.length) || (e.andAllEmotion && e.andAllEmotion.length) || (e.notAnyEmotion && e.notAnyEmotion.length) || (e.notAllEmotion && e.notAllEmotion.length);
            if (!has) {
              window.showToast("Please select at least one emotion gate.", "error");
              return false;
            }
            return true;
          }
        },
        { id: "btn_save_file", title: "Step 5: Save", text: "Great! Your entry is ready. Click 'Save to File' to download your database." }
      ];

      var currentTutData = basicTutData;

      window.startTutorial = function() {
        currentTutData = basicTutData;
        window.switchType('dynamiclore');
        window.createNew();
        tutStep = 0;
        window.renderTutorialStep();
      };

      window.startAdvancedTutorial = function() {
        currentTutData = advancedTutData;
        window.switchType('dynamiclore');
        window.createNew();
        tutStep = 0;
        window.renderTutorialStep();
      };

      window.startWalkthrough = function() {
        currentTutData = walkthroughTutData;
        window.switchType('dynamiclore');
        window.createNew();
        tutStep = 0;
        window.renderTutorialStep();
      };

      /**
       * Clamp tooltip position to stay within viewport bounds
       * @param {number} left - Desired left position
       * @param {number} top - Desired top position
       * @param {DOMRect} tipRect - Tooltip bounding rectangle
       * @param {number} padding - Padding from viewport edges
       * @returns {Object} Clamped {left, top} position
       */
      function clampToViewport(left, top, tipRect, padding) {
        padding = padding || 10;

        // Get viewport dimensions
        var viewportWidth = window.innerWidth;
        var viewportHeight = window.innerHeight;

        // Clamp horizontal position
        if (left < padding) {
          left = padding;
        } else if (left + tipRect.width > viewportWidth - padding) {
          left = viewportWidth - tipRect.width - padding;
        }

        // Clamp vertical position
        if (top < padding) {
          top = padding;
        } else if (top + tipRect.height > viewportHeight - padding) {
          top = viewportHeight - tipRect.height - padding;
        }

        return { left: left, top: top };
      }

      window.renderTutorialStep = function() {
        var step = currentTutData[tutStep];
        var ring = document.getElementById('tutorialRing');
        var tip = document.getElementById('tutorialTooltip');

        document.getElementById('tutTitle').innerText = step.title;
        document.getElementById('tutText').innerText = step.text;
        tip.style.display = 'flex';
        tip.style.transform = 'none'; // Reset transform

        if (step.id) {
          var el = document.getElementById(step.id);
          if (el) {
            el.scrollIntoView({block: "center", behavior: "auto"});
            var rect = el.getBoundingClientRect();
            ring.style.display = 'block';
            ring.style.top = (rect.top - 5) + 'px';
            ring.style.left = (rect.left - 5) + 'px';
            ring.style.width = (rect.width + 10) + 'px';
            ring.style.height = (rect.height + 10) + 'px';

            // Get tooltip dimensions (must be visible to measure)
            var tipRect = tip.getBoundingClientRect();

            // Try to position below the element first
            var topPos = rect.bottom + 15;
            var leftPos = rect.left;

            // If tooltip would go off the bottom, try positioning above
            if (topPos + tipRect.height > window.innerHeight - 10) {
              topPos = rect.top - tipRect.height - 15;
            }

            // If still off screen (element at very top), position beside it
            if (topPos < 10) {
              topPos = rect.top;
              leftPos = rect.right + 15;

              // If off right edge, try left side
              if (leftPos + tipRect.width > window.innerWidth - 10) {
                leftPos = rect.left - tipRect.width - 15;
              }
            }

            // Final clamp to ensure it's fully within viewport
            var clamped = clampToViewport(leftPos, topPos, tipRect, 10);
            tip.style.top = clamped.top + 'px';
            tip.style.left = clamped.left + 'px';
            return;
          }
        }

        // Fallback: center on screen
        ring.style.display = 'none';
        var tipRect = tip.getBoundingClientRect();
        var centeredLeft = (window.innerWidth - tipRect.width) / 2;
        var centeredTop = 100;

        var clamped = clampToViewport(centeredLeft, centeredTop, tipRect, 10);
        tip.style.top = clamped.top + 'px';
        tip.style.left = clamped.left + 'px';
      };

      window.nextTutorialStep = function() {
        var step = currentTutData[tutStep];
        if (step.validate && !step.validate()) {
          return;
        }
        tutStep++;
        if (tutStep >= currentTutData.length) {
          window.endTutorial();
        } else {
          window.renderTutorialStep();
        }
      };

      window.endTutorial = function() {
        document.getElementById('tutorialRing').style.display = 'none';
        document.getElementById('tutorialTooltip').style.display = 'none';
      };

      function currShift() {
        if (!STATE.shiftId) return null;
        return findEntry(STATE.shiftId, STATE.data.dynamiclore);
      }

      function saveShift(patch) {
        var s = currShift();
        if (s) {
          for (var k in patch) s[k] = patch[k];
          renderList();
          renderEditor();
          renderCode();
        }
      }

      // expose for back button in shift editor (kept compatible with inline onclick)
      window.STATE = STATE;
      window.renderEditor = renderEditor;
      window.renderList = renderList;
      window.renderCode = renderCode;
      window.save = save;
      window.saveShift = saveShift;

      // --------------------------------------------------------------------------
      // Quick Switcher Logic
      // --------------------------------------------------------------------------
      var qsIndex = 0;
      var qsItems = [];

      window.toggleQuickSwitcher = function() {
        var el = document.getElementById('quickSwitcher');
        var inp = document.getElementById('qsInput');
        if (el.classList.contains('hidden')) {
          el.classList.remove('hidden');
          inp.value = '';
          inp.focus();
          window.renderQuickSwitcherResults();
        } else {
          el.classList.add('hidden');
        }
      };

      document.getElementById('qsInput').addEventListener('input', function() {
        window.renderQuickSwitcherResults(this.value);
      });

      document.getElementById('qsInput').addEventListener('keydown', function(e) {
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          qsIndex = Math.min(qsIndex + 1, qsItems.length - 1);
          window.updateQsSelection();
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          qsIndex = Math.max(qsIndex - 1, 0);
          window.updateQsSelection();
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (qsItems[qsIndex]) {
            var item = qsItems[qsIndex];
            window.switchType(item.type);
            if (item.shiftId) window.selectEntry(item.parentId, item.id);
            else window.selectEntry(item.id);
            window.switchTab('visual');
            window.toggleQuickSwitcher();
          }
        } else if (e.key === 'Escape') {
          window.toggleQuickSwitcher();
        }
      });

      window.renderQuickSwitcherResults = function(term) {
        term = (term || "").toLowerCase();
        var list = document.getElementById('qsResults');
        list.innerHTML = "";
        qsItems = [];
        qsIndex = 0;

        var add = function(type, entry, parentId) {
          var label = "";
          if (type === 'characters') label = entry.key;
          else if (type === 'pairs') label = (entry.pair||[]).join(' + ');
          else label = entry.id_name || "Unnamed";
          
          if (term && label.toLowerCase().indexOf(term) === -1 && (entry.group||"").toLowerCase().indexOf(term) === -1) return;
          
          qsItems.push({ type: type, id: entry.id, label: label, group: entry.group, parentId: parentId, shiftId: !!parentId });
        };

        STATE.data.characters.forEach(function(c) { add('characters', c); });
        STATE.data.pairs.forEach(function(p) { add('pairs', p); });
        STATE.data.dynamiclore.forEach(function(l) { 
          add('dynamiclore', l);
          if (l.shifts) l.shifts.forEach(function(s) { add('dynamiclore', s, l.id); });
        });

        var html = "";
        qsItems.forEach(function(item, i) {
          var typeLabel = item.type === 'dynamiclore' ? (item.shiftId ? 'SHIFT' : 'LORE') : (item.type === 'characters' ? 'CHAR' : 'PAIR');
          html += '<div class="qs-item ' + (i === 0 ? 'selected' : '') + '" onclick="window.qsClick(' + i + ')"><div class="qs-text">' + escHtml(item.label) + '</div><div class="qs-meta">' + (item.group ? '<span>' + escHtml(item.group) + '</span>' : '') + '<span class="qs-badge">' + typeLabel + '</span></div></div>';
        });
        list.innerHTML = html || '<div style="padding:20px;text-align:center;color:var(--text-soft);">No matches found</div>';
      };

      window.updateQsSelection = function() {
        var els = document.querySelectorAll('.qs-item');
        for(var i=0; i<els.length; i++) els[i].classList.remove('selected');
        if(els[qsIndex]) {
          els[qsIndex].classList.add('selected');
          els[qsIndex].scrollIntoView({block: 'nearest'});
        }
      };

      window.qsClick = function(i) {
        qsIndex = i;
        var item = qsItems[qsIndex];
        window.switchType(item.type);
        if (item.shiftId) window.selectEntry(item.parentId, item.id);
        else window.selectEntry(item.id);
        window.switchTab('visual');
        window.toggleQuickSwitcher();
      };

    })();
  </script>
</body>

</html>